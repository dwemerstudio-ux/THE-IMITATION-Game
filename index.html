<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ò–≥—Ä–∞ –≤ –ò–º–∏—Ç–∞—Ü–∏—é: –ö—Ç–æ –∂–µ —Ç—ã?</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: radial-gradient(circle at top, #1a2a3a 0, #05070b 55%, #000000 100%);
      background-size: 200% 200%;
      animation: bg-shift 28s ease-in-out infinite alternate;
      color: #00ff9c;
      font-family: "Courier New", monospace;
      font-size: 15px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      position: relative;
      overflow-x: hidden;
      overflow-y: auto;
    }

    body.theme-default {
      filter: none;
    }

    body.theme-violet {
      filter: hue-rotate(60deg) saturate(1.05);
    }

    body.theme-amber {
      filter: saturate(0.8) brightness(0.9);
    }

    body.theme-amber .bg-lines,
    body.theme-amber .bg-orbit {
      opacity: 0.18;
    }

    body.theme-amber #game-root {
      border-color: #e0b36a;
      background: rgba(12, 9, 4, 0.96);
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.9);
      animation: none;
    }

    body.theme-amber #logo {
      color: #f5d7a3;
      text-shadow: none;
      animation: none;
    }

    body.theme-amber .choice-btn {
      border-color: #e0b36a88;
      background:
        linear-gradient(135deg, rgba(24, 17, 6, 0.96), rgba(16, 10, 2, 0.96));
    }

    body.theme-amber .choice-btn:hover {
      box-shadow: 0 0 6px #000000aa;
      border-color: #f5d7a3cc;
    }

    body.theme-amber #alignment-fill-human {
      background: linear-gradient(90deg, #f5d7a3, transparent);
    }

    body.theme-amber #alignment-fill-tech {
      background: linear-gradient(270deg, #c9a86a, transparent);
    }

    body.theme-amber #theme-box {
      color: #e0c197;
    }

    body.theme-amber .theme-chip {
      border-color: #b4935a55;
      color: #f5d7a3dd;
    }

    body.theme-amber .theme-chip.active {
      box-shadow: none;
    }

    body.theme-amber #ai-comment {
      color: #f0d19b88;
      text-shadow: 0 0 3px #000;
    }

    @keyframes bg-shift {
      0% { background-position: 0% 0%; }
      100% { background-position: 100% 100%; }
    }

    .bg-lines {
      position: fixed;
      inset: -20px;
      background-image:
        linear-gradient(
          rgba(0, 255, 156, 0.08) 1px,
          transparent 1px
        ),
        linear-gradient(
          90deg,
          rgba(0, 255, 156, 0.08) 1px,
          transparent 1px
        );
      background-size: 40px 40px, 40px 40px;
      opacity: 0.15;
      pointer-events: none;
      z-index: 0;
      mix-blend-mode: screen;
      animation: grid-move 20s linear infinite;
    }

    @keyframes grid-move {
      0% { transform: translate3d(0, 0, 0); }
      100% { transform: translate3d(-40px, -40px, 0); }
    }

    .bg-orbit {
      position: fixed;
      border-radius: 50%;
      border: 1px dashed rgba(0, 255, 156, 0.3);
      box-shadow: 0 0 16px rgba(0, 255, 156, 0.2);
      pointer-events: none;
      z-index: 0;
    }

    .orbit-1 {
      width: 60vw;
      height: 60vw;
      top: -20vw;
      right: -10vw;
      animation: orbit-spin 42s linear infinite;
    }

    .orbit-2 {
      width: 40vw;
      height: 40vw;
      bottom: -15vw;
      left: -5vw;
      animation: orbit-spin 55s linear infinite reverse;
    }

    .orbit-3 {
      width: 30vw;
      height: 30vw;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: orbit-pulse 30s ease-in-out infinite;
      opacity: 0.2;
    }

    @keyframes orbit-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes orbit-pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.1); }
    }

    .edge-glitch {
      position: fixed;
      top: 0;
      bottom: 0;
      width: 22px;
      pointer-events: none;
      z-index: 3;
      opacity: 0;
      mix-blend-mode: screen;
      background:
        linear-gradient(
          to bottom,
          rgba(0, 255, 156, 0) 0%,
          rgba(0, 255, 156, 0.4) 30%,
          rgba(255, 0, 255, 0.4) 60%,
          rgba(0, 255, 156, 0) 100%
        );
      transform: translateZ(0);
    }

    .edge-glitch-left { left: 0; }
    .edge-glitch-right { right: 0; }

    body.glitch-strong .edge-glitch {
      opacity: 0.45;
      animation: edge-glitch-flicker 0.3s steps(2, start) infinite;
    }

    @keyframes edge-glitch-flicker {
      0% { transform: translateX(0); filter: hue-rotate(0deg); }
      50% { transform: translateX(2px); filter: hue-rotate(30deg); }
      100% { transform: translateX(-1px); filter: hue-rotate(-20deg); }
    }

    #transition-rift{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transform: scale(1);
      background: radial-gradient(circle at 50% 52%, rgba(0,255,156,0.12) 0, rgba(124,251,255,0.07) 22%, rgba(0,0,0,0) 52%);
      filter: saturate(1.1);
    }

    #transition-rift::before{
      content: "";
      position: absolute;
      inset: -22%;
      background:
        conic-gradient(from 180deg at 50% 50%,
          rgba(124,251,255,0.0) 0deg,
          rgba(124,251,255,0.28) 28deg,
          rgba(0,255,156,0.0) 80deg,
          rgba(255,0,193,0.18) 130deg,
          rgba(0,0,0,0.0) 210deg,
          rgba(0,255,156,0.22) 265deg,
          rgba(124,251,255,0.0) 360deg
        ),
        radial-gradient(circle at 50% 50%,
          rgba(0,255,156,0.10) 0,
          rgba(0,0,0,0.0) 58%
        );
      mix-blend-mode: screen;
      filter: blur(10px) contrast(calc(1.05 + 0.35 * var(--fx-contrast)));
      transform: translate3d(0,0,0) scale(0.92) rotate(0deg);
      opacity: 0;
    }

    #transition-rift::after{
      content: "";
      position: absolute;
      inset: -10%;
      background:
        repeating-linear-gradient(
          115deg,
          rgba(0,0,0,0) 0px,
          rgba(0,0,0,0) 18px,
          rgba(124,251,255,0.10) 22px,
          rgba(0,255,156,0.14) 26px,
          rgba(0,0,0,0) 32px
        ),
        radial-gradient(circle at 50% 45%,
          rgba(255,0,193,0.08) 0,
          rgba(0,0,0,0) 55%
        );
      mix-blend-mode: screen;
      filter: blur(2px) contrast(calc(1.0 + 0.25 * var(--fx-contrast)));
      transform: translate3d(0,0,0) scale(1.06);
      opacity: 0;
    }

    #transition-rift.show{
      animation: rift-open 0.92s cubic-bezier(.18,.92,.2,1) forwards;
    }

    #transition-rift.show::before{
      animation: rift-core 0.92s cubic-bezier(.18,.92,.2,1) forwards;
    }

    #transition-rift.show::after{
      animation: rift-streaks 0.92s cubic-bezier(.18,.92,.2,1) forwards;
    }

    @keyframes rift-open{
      0%{ opacity: 0; transform: scale(1.06) translateY(-1.2vh); }
      18%{ opacity: 1; transform: scale(0.98) translateY(0); }
      55%{ opacity: 0.75; transform: scale(1.02) translateY(0.8vh); }
      100%{ opacity: 0; transform: scale(1.10) translateY(2.2vh); }
    }

    @keyframes rift-core{
      0%{ opacity: 0; transform: scale(0.88) rotate(-8deg); }
      20%{ opacity: calc(0.95 * var(--fx-intensity)); transform: scale(1.02) rotate(18deg); }
      60%{ opacity: calc(0.65 * var(--fx-intensity)); transform: scale(0.96) rotate(44deg); }
      100%{ opacity: 0; transform: scale(1.14) rotate(68deg); }
    }

    @keyframes rift-streaks{
      0%{ opacity: 0; transform: scale(1.16) translateY(-2.0vh); }
      18%{ opacity: calc(0.72 * var(--fx-intensity)); transform: scale(1.00) translateY(0); }
      60%{ opacity: calc(0.45 * var(--fx-intensity)); transform: scale(1.08) translateY(1.2vh); }
      100%{ opacity: 0; transform: scale(1.22) translateY(3.2vh); }
    }

    @media (max-width: 540px){
      #transition-rift::before{ filter: blur(8px) contrast(calc(1.05 + 0.28 * var(--fx-contrast))); }
      #transition-rift::after{ filter: blur(1.6px) contrast(calc(1.0 + 0.20 * var(--fx-contrast))); }
    }

    @media (prefers-reduced-motion: reduce){
      #transition-rift.show, #transition-rift.show::before, #transition-rift.show::after{ animation-duration: 0.001s; }
    }

          25%  { opacity: 0.9; transform: scale(1.02) rotate(2deg); }
      60%  { opacity: 0.6; transform: scale(0.98) rotate(-2deg); }
      100% { opacity: 0; transform: scale(1) rotate(0deg); }
    }

    .crt {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        repeating-linear-gradient(
          rgba(0, 0, 0, 0.18),
          rgba(0, 0, 0, 0.18) 1px,
          rgba(0, 0, 0, 0.22) 2px
        );
      mix-blend-mode: multiply;
      opacity: 0.6;
      z-index: 5;
    }

    
    #game-root {
      position: relative;
      max-width: 1100px; 
      width: 100%;
      background: rgba(3, 8, 16, 0.94);
      border: 2px solid #00ff9c;
      box-shadow: 0 0 18px #00ff9c55;
      padding: 20px;
      overflow: hidden;
      z-index: 2;
      backdrop-filter: blur(2px);
    }

    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #00ff9c55;
      padding-bottom: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    #logo {
      font-weight: bold;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #7cfbff;
      text-shadow: 0 0 6px #00ff9caa;
      animation: logo-glow 3.5s ease-in-out infinite;
    }

    @keyframes logo-glow {
      0%, 100% { text-shadow: 0 0 4px #00ff9caa; }
      50% { text-shadow: 0 0 12px #7cfbffaa; }
    }

    #header-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #role-display {
      font-style: italic;
      color: #00ff9c;
      font-size: 12px;
      opacity: 0.9;
    }

    .icon-btn {
      border: 1px solid #00ff9c66;
      background: rgba(0, 0, 0, 0.7);
      color: #00ff9c;
      border-radius: 4px;
      font-size: 11px;
      padding: 3px 6px;
      cursor: pointer;
      box-shadow: 0 0 6px #00ff9c55;
      transition: background 0.15s, transform 0.07s, color 0.15s;
    }

    .icon-btn:hover {
      background: rgba(0, 255, 156, 0.18);
      box-shadow: 0 0 8px #00ff9c77;
      transform: translateY(-1px);
    }

    .icon-btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .icon-btn.on {
      color: #07130f;
      background: #00ff9c;
      box-shadow: 0 0 12px #00ff9caa;
    }

    #achievements-strip {
      display: flex;
      align-items: center;
      gap: 3px;
      margin-right: 4px;
    }

    .ach-icon {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #00ff9c33;
      font-size: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.25;
      color: #00ff9c55;
      background: rgba(0, 0, 0, 0.5);
      cursor: default;
      box-shadow: none;
      transition: opacity 0.2s, border-color 0.2s, box-shadow 0.2s, transform 0.1s;
    }

    .ach-icon.unlocked {
      opacity: 1;
      color: #000;
      border-color: #7cfbffcc;
      background: radial-gradient(circle at 30% 20%, #ffffff, #00ff9c);
      box-shadow: 0 0 6px #00ff9c77;
      transform: translateY(-1px);
    }

    .ach-icon.unlocked:hover {
      box-shadow: 0 0 10px #7cfbff99;
    }

    
    #screen {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 14px;
      margin-top: 4px;
    }

    @media (max-width: 720px) {
      #screen {
        grid-template-columns: 1fr;
      }

      #role-display {
        font-size: 11px;
      }

      #achievements-strip {
        display: none;
      }
    }

    
    #image-box {
      border: 1px solid #00ff9c55;
      background: radial-gradient(circle, #041018 0, #020509 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;

      min-height: 600px; 
    }

    #image-box::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        120deg,
        transparent 0,
        rgba(0, 255, 156, 0.04) 40%,
        transparent 80%
      );
      mix-blend-mode: screen;
      pointer-events: none;
    }

    #image-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.15) contrast(1.1);
      transform: scale(1.02);
      opacity: 0;
      transition: opacity 0.4s ease-out;
    }

    #image-box img.show {
      opacity: 1;
    }

    #image-box .placeholder {
      font-size: 12px;
      color: #00ff9caa;
      text-align: center;
      padding: 8px;
    }

    
    #scene-box {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #scene-title {
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #7cfbff;
      font-size: 14px;
    }

    #scene-text {
      font-size: 15px;
      line-height: 1.5;
      white-space: pre-wrap;
      margin-top: 2px;
    }

    #choices {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: stretch;
    }

    
    .choice-btn {
      --card-rot: 0deg;
      background: linear-gradient(
        135deg,
        rgba(0, 0, 0, 0.9),
        rgba(0, 40, 30, 0.95)
      );
      border: 1px solid #00ff9caa;
      color: #00ff9c;
      padding: 8px 10px;
      text-align: left;
      font-size: 15px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      transform: translateY(0) rotate(var(--card-rot));
      transition:
        background 0.15s,
        transform 0.07s,
        box-shadow 0.15s,
        border-color 0.15s;
    }

    .choice-btn::before {
      content: ">";
      margin-right: 6px;
      color: #7cfbff;
    }

    .choice-btn:hover {
      background: linear-gradient(
        135deg,
        rgba(0, 40, 30, 0.95),
        rgba(0, 0, 0, 0.95)
      );
      box-shadow: 0 0 12px #00ff9c66;
      transform: translateY(-2px) rotate(var(--card-rot));
      border-color: #7cfbffaa;
    }

    .choice-btn:active {
      transform: translateY(1px) rotate(var(--card-rot));
      box-shadow: none;
    }

    .choice-btn.selected {
      background: linear-gradient(
        135deg,
        rgba(0, 60, 40, 0.98),
        rgba(0, 0, 0, 0.98)
      );
      box-shadow: 0 0 14px #00ff9c88;
      transform: translateY(-2px) rotate(var(--card-rot));
    }

    #choices .choice-btn {
      flex: 1 1 calc(50% - 8px);
      min-height: 90px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    @media (max-width: 620px) {
      #choices .choice-btn {
        flex: 1 1 100%;
      }
    }

    .secret-choice {
      background: transparent;
      border: 1px dashed #7cfbffaa;
      color: #7cfbffdd;
      padding: 4px 8px;
      font-size: 12px;
      align-self: flex-start;
      cursor: default;
      max-width: 70%;
      opacity: 0;
      max-height: 0;
      margin-top: 0;
      pointer-events: none;
      overflow: hidden;
      border-radius: 8px;
      transition:
        opacity 0.25s ease,
        max-height 0.25s ease,
        margin-top 0.25s ease,
        transform 0.25s ease;
      --card-rot: 0deg;
      transform: translateY(0) rotate(var(--card-rot));
    }

    .secret-choice::before {
      content: "?";
      margin-right: 6px;
      color: #7cfbff;
    }

    #choices .secret-choice {
      flex: 0 1 48%;
      min-height: 64px;
    }

    @media (max-width: 620px) {
      #choices .secret-choice {
        flex: 0 1 80%;
      }
    }

    .secret-choice.visible-soft {
      opacity: 0.3;
      max-height: 40px;
      margin-top: 4px;
      pointer-events: none;
      transform: translateX(4px) rotate(var(--card-rot));
    }

    .secret-choice.visible-active {
      opacity: 1;
      max-height: 60px;
      margin-top: 4px;
      pointer-events: auto;
      transform: translateX(0) rotate(var(--card-rot));
      box-shadow: 0 0 8px #7cfbff55;
    }

    .secret-choice.visible-active:hover {
      background: rgba(124, 251, 255, 0.1);
    }

    #confidence-panel .choice-btn {
      flex: 0 0 auto;
      min-height: auto;
      --card-rot: 0deg;
      transform: translateY(0) rotate(0deg);
    }

    #footer {
      margin-top: 8px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #00ff9c88;
    }

    #progress {
      font-family: inherit;
    }

    .blink {
      animation: blink 1s steps(2, start) infinite;
    }

    @keyframes blink {
      to { visibility: hidden; }
    }

    .glitch {
      position: relative;
      text-shadow: 1px 0 #ff00c1, -1px 0 #00eaff;
    }

    #confidence-panel {
      margin-top: 6px;
      font-size: 12px;
      border-top: 1px solid #00ff9c33;
      padding-top: 6px;
      display: none;
    }

    #confidence-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    #confidence-slider {
      width: 100%;
    }

    #alignment {
      margin-top: 4px;
      border: 1px solid #00ff9c44;
      height: 8px;
      width: 160px;
      display: flex;
      overflow: hidden;
    }

    #alignment-fill-human,
    #alignment-fill-tech {
      transition: width 0.3s;
    }

    #alignment-fill-human {
      background: linear-gradient(90deg, #00ff9c, transparent);
      width: 50%;
    }

    #alignment-fill-tech {
      background: linear-gradient(270deg, #ff00c1, transparent);
      width: 50%;
    }

    #ai-comment {
      position: fixed;
      right: 12px;
      bottom: 16px;
      max-width: 260px;
      font-size: 12px;
      color: #7cfbffaa;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #7cfbff55;
      padding: 6px 8px;
      border-radius: 4px;
      z-index: 10;
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      white-space: pre-wrap;
      text-align: left;
    }

    .ai-comment-show {
      opacity: 1 !important;
      transform: translateY(0) !important;
      transition: opacity 0.3s, transform 0.3s;
    }

    #result-modal,
    #epilogue-modal,
    #minigame-modal,
    #achievements-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 800;
    }

    #result-modal.show,
    #epilogue-modal.show,
    #minigame-modal.show,
    #achievements-modal.show {
      display: flex;
    }

    #result-backdrop,
    #epilogue-backdrop,
    #minigame-backdrop,
    #achievements-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(2px);
    }

    #result-dialog,
    #epilogue-dialog,
    #minigame-dialog,
    #achievements-dialog {
      position: relative;
      max-width: 520px;
      width: 90%;
      background: rgba(3, 8, 16, 0.97);
      border-radius: 8px;
      border: 1px solid #00ff9caa;
      box-shadow: 0 0 18px #00ff9c66;
      padding: 10px;
      z-index: 801;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 80vh;
    }

    #result-header,
    #epilogue-header,
    #achievements-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #7cfbff;
      border-bottom: 1px solid #00ff9c33;
      padding-bottom: 4px;
      margin-bottom: 4px;
    }

    #result-body,
    #epilogue-body,
    #achievements-body {
      font-size: 12px;
      white-space: pre-wrap;
      overflow-y: auto;
      padding-right: 4px;
    }

    .epilogue-block {
      margin-bottom: 10px;
      border-bottom: 1px dashed #00ff9c33;
      padding-bottom: 6px;
    }

    .epilogue-block-title {
      font-weight: bold;
      color: #7cfbff;
      margin-bottom: 2px;
    }

    .epilogue-block-text {
      font-size: 12px;
      white-space: pre-wrap;
    }

    .ach-row {
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px dashed #00ff9c33;
    }

    .ach-row-title {
      font-weight: bold;
      color: #7cfbff;
      margin-bottom: 2px;
    }

    .ach-row-text {
      font-size: 12px;
      margin-bottom: 2px;
    }

    .ach-row-status {
      font-size: 11px;
      color: #00ff9ccc;
    }

    #minigame-dialog {
      max-width: 420px;
    }

    #miniggame-title,
    #minigame-title {
      font-size: 13px;
      color: #7cfbff;
      margin-bottom: 2px;
    }

    #minigame-text {
      font-size: 12px;
      white-space: pre-wrap;
      min-height: 60px;
    }

    #minigame-choices {
      display: none;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    #minigame-button {
      align-self: flex-end;
      font-size: 13px;
      padding: 6px 10px;
    }

    body.theme-amber #minigame-dialog,
    body.theme-amber #achievements-dialog {
      border-color: #e0b36a;
      box-shadow: 0 0 10px #000000aa;
      background: rgba(12, 9, 4, 0.97);
    }

    body.theme-amber #minigame-title,
    body.theme-amber #achievements-header {
      color: #f5d7a3;
    }

    #theme-box {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 4px;
      color: #7cfbff;
    }

    .theme-chip {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid #00ff9c66;
      background: rgba(0, 0, 0, 0.6);
      font-size: 12px;
      cursor: pointer;
      color: #00ff9ccc;
      transition: background 0.15s, box-shadow 0.15s, transform 0.07s;
    }

    .theme-chip:hover {
      background: rgba(0, 255, 156, 0.08);
      box-shadow: 0 0 8px #00ff9c55;
      transform: translateY(-1px);
    }

    .theme-chip.active {
      background: #00ff9c;
      color: #07130f;
      box-shadow: 0 0 10px #00ff9caa;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 6px;
      font-size: 13px;
      width: 100%;
    }

    .field label {
      color: #7cfbff;
    }

    .field input,
    .field select {
      background: #02070d;
      border: 1px solid #00ff9c55;
      color: #00ff9c;
      padding: 4px 6px;
      font-family: inherit;
      font-size: 13px;
      outline: none;
    }

    .field input:focus,
    .field select:focus {
      border-color: #7cfbffaa;
      box-shadow: 0 0 6px #7cfbff55;
    }

    body.theme-amber .field input,
    body.theme-amber .field select {
      background: #171007;
      border-color: #b4935a77;
      color: #f5d7a3;
    }

    body.theme-amber .field input:focus,
    body.theme-amber .field select:focus {
      border-color: #f5d7a3cc;
      box-shadow: 0 0 6px #000000aa;
    }

    #form-error {
      margin-top: 4px;
      font-size: 12px;
      color: #ff8080;
      white-space: pre-wrap;
      text-align: center;
    }

    
    #player-form-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      max-width: 360px;
      margin: 0 auto;
    }

    #player-form-wrapper .choice-btn {
      align-self: center;
      width: auto;
      min-width: 60%;
      justify-content: center;
      text-align: center;
    }

    #pathgame-container {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    #pathgame-grid {
      display: grid;
      grid-template-columns: repeat(10, var(--pg-cell));
      grid-template-rows: repeat(10, var(--pg-cell));
      gap: var(--pg-gap);
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #00ff9c55;
      background: rgba(0, 0, 0, 0.6);
    }

    .path-cell {
      width: 24px;
      height: 24px;
      border-radius: 3px;
      border: 1px solid #00ff9c22;
      background: rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .path-start {
      border-color: #7cfbffaa;
      box-shadow: 0 0 6px #7cfbff66;
    }

    .path-goal {
      border-color: #ff00c1aa;
      box-shadow: 0 0 6px #ff00c166;
    }

    .path-event-node::after {
      content: "‚óè";
      font-size: 11px;
      color: #00ff9c;
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .path-event-node.path-event-visited {
      border-color: #ffd96b;
      box-shadow: 0 0 6px #ffd96b88;
    }

    .path-event-node.path-event-visited::after {
      color: #ffd96b;
      text-shadow: 0 0 6px #ffd96b;
    }

    .path-player {
      background: #7cfbff;
      box-shadow: 0 0 8px #7cfbff;
    }

    #pathgame-arrows {
      display: grid;
      grid-template-columns: repeat(3, var(--pg-arrow));
      grid-template-rows: repeat(2, var(--pg-arrow));
      gap: 4px;
      justify-items: center;
      align-items: center;
    }

    .path-arrow-btn {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      border: 1px solid #00ff9c44;
      background: rgba(0, 0, 0, 0.7);
      color: #7cfbff;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
    }

    .path-arrow-btn:hover {
      background: rgba(0, 255, 156, 0.16);
      box-shadow: 0 0 6px #00ff9c55;
      transform: translateY(-1px);
    }

    .path-arrow-btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    body.theme-amber #pathgame-grid {
      border-color: #b4935a77;
      background: rgba(15, 11, 6, 0.9);
    }

    body.theme-amber .path-cell {
      border-color: #b4935a33;
      background: rgba(8, 5, 2, 0.9);
    }

    body.theme-amber .path-event-node::after {
      color: #f5d7a3;
    }

    body.theme-amber .path-event-node.path-event-visited {
      border-color: #f5d7a3;
      box-shadow: 0 0 6px #f5d7a388;
    }

    body.theme-amber .path-event-node.path-event-visited::after {
      color: #ffe5a8;
      text-shadow: 0 0 6px #ffe5a8;
    }

    body.theme-amber .path-arrow-btn {
      border-color: #b4935a55;
      color: #f5d7a3;
      background: rgba(8, 5, 2, 0.9);
    }

    body.theme-amber .path-arrow-btn:hover {
      background: rgba(245, 215, 163, 0.16);
      box-shadow: 0 0 6px #000000aa;
    }

    #path-moves {
      font-size: 11px;
      color: #7cfbff;
      margin-top: 2px;
    }

    .path-tooltip {
      position: fixed;
      min-width: 180px;
      max-width: 260px;
      font-size: 11px;
      color: #7cfbff;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid #7cfbff88;
      border-radius: 4px;
      padding: 6px 8px;
      z-index: 1200;
      pointer-events: none;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.15s ease, transform 0.15s ease;
      white-space: pre-wrap;
    }

    .path-tooltip.show {
      opacity: 1;
      transform: translateY(0);
    }
  
    
    .effect-canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 3;
    }

  
    
    #fx-canvas {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;           
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.35s ease;
    }
    body.fx-on #fx-canvas { opacity: calc(1 * var(--fx-intensity)); }

    #hud-overlay {
      position: fixed;
      inset: 0;
      z-index: 1;           
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.35s ease;
      overflow: hidden;
    }
    body.hud-on #hud-overlay { opacity: calc(1 * var(--fx-intensity)); }

    .hud-frag {
      position: absolute;
      font-size: 11px;
      line-height: 1.1;
      white-space: pre;
      opacity: 0;
      transform: translateZ(0);
      animation: hud-flicker 4.8s infinite;
      text-shadow: 0 0 10px rgba(0, 255, 156, 0.18);
      filter: blur(0.15px);
      mix-blend-mode: screen;
      user-select: none;
    }

    body.fx-matrix .hud-frag {
      color: rgba(0, 255, 140, 0.65);
    }
    body.fx-human .hud-frag {
      color: rgba(255, 220, 200, 0.55);
      text-shadow: 0 0 10px rgba(255, 220, 200, 0.20);
    }

    @keyframes hud-flicker {
      0%   { opacity: 0; transform: translateY(2px); }
      6%   { opacity: 0.18; }
      10%  { opacity: 0.05; }
      18%  { opacity: 0.22; }
      22%  { opacity: 0.00; }
      35%  { opacity: 0.16; }
      48%  { opacity: 0.02; }
      60%  { opacity: 0.20; }
      68%  { opacity: 0.00; }
      82%  { opacity: 0.14; }
      100% { opacity: 0; transform: translateY(0px); }
    }


    
    .volume-slider{
      width: 110px;
      height: 6px;
      margin-left: 8px;
      accent-color: rgba(0, 255, 156, 0.75);
      cursor: pointer;
    }
    @media (max-width: 520px){
      .volume-slider{ width: 90px; }
    }

    
    
    .fx-panel{
      position: absolute;
      top: 42px;
      right: 8px;
      width: 240px;
      padding: 10px 10px 8px;
      background: rgba(0,0,0,0.88);
      border: 1px solid rgba(0,255,156,0.30);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,255,156,0.10);
      z-index: 50;
      opacity: 0;
      transform: translateY(-6px);
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .fx-panel.show{
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .fx-row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 6px 0;
      font-size: 12px;
      color: rgba(124,251,255,0.85);
    }
    .fx-row input[type="range"]{
      width: 140px;
      height: 6px;
      accent-color: rgba(0,255,156,0.75);
      cursor: pointer;
    }
    .fx-hint{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(124,251,255,0.55);
      line-height: 1.2;
    }

    
    #ai-comment.inject{
      border-color: rgba(255, 36, 90, 0.35);
      color: rgba(255, 186, 186, 0.92);
      box-shadow: 0 0 18px rgba(255, 36, 90, 0.10);
    }
    #ai-comment.jitter{
      animation: toast-jitter 0.12s linear 2;
    }
    @keyframes toast-jitter{
      0%{ transform: translateY(0) translateX(0); }
      25%{ transform: translateY(-1px) translateX(1px); }
      50%{ transform: translateY(0) translateX(-1px); }
      75%{ transform: translateY(1px) translateX(1px); }
      100%{ transform: translateY(0) translateX(0); }
    }

    
    :root{
      --fx-intensity: 1;
      --fx-contrast: 1.1;
    
      --pg-cell: 24px;
      --pg-gap: 3px;
      --pg-arrow: 32px;
    }

    #scan-canvas{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;           
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.45s ease;
      mix-blend-mode: screen;
    }
    body.scan-on #scan-canvas{ opacity: calc(0.9 * var(--fx-intensity)); }


    
    #obs-layer{
      position: fixed;
      inset: 0;
      z-index: 900;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.35s ease;
      mix-blend-mode: screen;
    }
    body.observe-on #obs-layer{ opacity: calc(0.55 * var(--fx-intensity)); }
    body.observe-strong #obs-layer{ opacity: calc(0.82 * var(--fx-intensity)); }
    body.observe-passive #obs-layer{ opacity: calc(0.40 * var(--fx-intensity)); }

    #obs-box{
      position: absolute;
      width: 92px;
      height: 72px;
      transform: translate(-200px,-200px);
      opacity: 0.9;
      filter: drop-shadow(0 0 10px rgba(0,255,156,0.18));
      will-change: transform, opacity;
    }
    #obs-box:before, #obs-box:after{
      content:"";
      position:absolute;
      inset:0;
      border: 1px solid rgba(0,255,156,0.35);
      border-radius: 10px;
    }
    
    #obs-box i{
      position:absolute;
      width: 18px;
      height: 18px;
      border-color: rgba(0,255,156,0.72);
      border-style: solid;
      border-width: 0;
      opacity: 0.75;
    }
    #obs-box i.tl{ left:-2px; top:-2px; border-left-width:2px; border-top-width:2px; border-top-left-radius:10px; }
    #obs-box i.tr{ right:-2px; top:-2px; border-right-width:2px; border-top-width:2px; border-top-right-radius:10px; }
    #obs-box i.bl{ left:-2px; bottom:-2px; border-left-width:2px; border-bottom-width:2px; border-bottom-left-radius:10px; }
    #obs-box i.br{ right:-2px; bottom:-2px; border-right-width:2px; border-bottom-width:2px; border-bottom-right-radius:10px; }

    #obs-label{
      position:absolute;
      left: 14px;
      top: 14px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(0,255,156,0.22);
      background: rgba(0, 7, 12, 0.22);
      color: rgba(0,255,156,0.70);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      line-height: 1.25;
      max-width: min(58vw, 560px);
      white-space: pre-line;
      text-shadow: 0 0 10px rgba(0,255,156,0.10);
      transform: translateZ(0);
      will-change: contents, transform, opacity;
      opacity: 0.7;
    }

    
    body.fx-human #obs-label{ color: rgba(255, 220, 200, 0.72); border-color: rgba(255, 220, 200, 0.22); background: rgba(20, 10, 8, 0.18); }
    body.fx-human #obs-box i{ border-color: rgba(255, 220, 200, 0.78); }
    body.fx-matrix #obs-label{ color: rgba(0, 255, 140, 0.75); }
    body.fx-matrix #obs-box i{ border-color: rgba(0, 255, 140, 0.82); }

    
    body.observe-strong #obs-label{
      animation: obs-label-jitter 4.2s infinite;
    }
    @keyframes obs-label-jitter{
      0%{ transform: translate(0,0); }
      3%{ transform: translate(1px,0); }
      5%{ transform: translate(-1px,0); }
      8%{ transform: translate(0,0); }
      100%{ transform: translate(0,0); }
    }

    
    body.hud-calm .hud-frag{
      animation-name: hud-calm;
      text-shadow: 0 0 10px rgba(0, 255, 156, 0.14);
      filter: blur(0.08px);
    }
    body.hud-glitch .hud-frag{
      animation-name: hud-glitch;
      text-shadow: 0 0 12px rgba(0, 255, 156, 0.25);
      filter: blur(0.2px);
      letter-spacing: 0.4px;
    }
    body.hud-fade #hud-overlay{ opacity: 0 !important; }

    @keyframes hud-calm{
      0%   { opacity: 0; transform: translateY(3px); }
      20%  { opacity: 0.12; }
      50%  { opacity: 0.18; transform: translateY(0px); }
      80%  { opacity: 0.10; }
      100% { opacity: 0; transform: translateY(-2px); }
    }

    @keyframes hud-glitch{
      0%   { opacity: 0; transform: translateY(2px) skewX(0deg); }
      6%   { opacity: 0.22; }
      9%   { opacity: 0.03; transform: translateY(-1px) skewX(-2deg); }
      12%  { opacity: 0.28; transform: translateY(0px) skewX(2deg); }
      18%  { opacity: 0.00; }
      26%  { opacity: 0.25; transform: translateY(1px) skewX(-3deg); }
      31%  { opacity: 0.05; }
      38%  { opacity: 0.30; transform: translateY(0px) skewX(3deg); }
      52%  { opacity: 0.02; }
      64%  { opacity: 0.26; transform: translateY(-1px) skewX(-2deg); }
      72%  { opacity: 0.00; }
      86%  { opacity: 0.22; transform: translateY(0px) skewX(2deg); }
      100% { opacity: 0; transform: translateY(0px) skewX(0deg); }
    }




#minigame-dialog { overflow-y: auto; }
#minigame-text { flex: 0 0 auto; }
#minigame-dialog.minigame-path #minigame-text{
  max-height: 22vh;
  overflow-y: auto;
  padding-right: 6px;
  border-bottom: 1px dashed #00ff9c33;
}
#minigame-dialog.minigame-path #pathgame-container{ flex: 0 0 auto; }

#scene-text, #minigame-text, #result-body, #epilogue-body{
  overflow-wrap: anywhere;
  word-break: break-word;
  hyphens: auto;
}

@media (max-width: 860px){
  body{ padding: 10px; font-size: 14px; }
  #game-root{ padding: 12px; }
  #header{ flex-wrap: wrap; gap: 8px; }
  #header-right{ flex-wrap: wrap; gap: 8px; justify-content: flex-end; }
  #screen{ grid-template-columns: 1fr; gap: 12px; }
  #image-box{
    min-height: 34vh;
    max-height: 44vh;
  }
  
  #image-box img{
    object-fit: contain;
    transform: none;
    background: rgba(0,0,0,0.9);
  }
  #scene-title{ font-size: 14px; }
  #scene-text{ font-size: 14px; line-height: 1.6; }
  .choice-btn{ font-size: 14px; }
}

@media (max-width: 480px){
  :root{
    --pg-cell: 20px;
    --pg-gap: 2px;
    --pg-arrow: 30px;
  }
  #image-box{
    min-height: 30vh;
    max-height: 40vh;
  }
  #minigame-dialog{ width: 94vw; }
}

</style>
</head>
<body class="theme-default">
  <div class="bg-lines"></div>
  <div class="bg-orbit orbit-1"></div>
  <div class="bg-orbit orbit-2"></div>
  <div class="bg-orbit orbit-3"></div>

  <div class="edge-glitch edge-glitch-left"></div>
  <div class="edge-glitch edge-glitch-right"></div>

  <div id="transition-rift"></div>

  
  <canvas id="fx-canvas" aria-hidden="true"></canvas>
  <canvas id="scan-canvas" aria-hidden="true"></canvas>
  <div id="hud-overlay" aria-hidden="true"></div>
  <audio id="server-hum" src="assets/server_hum.mp3" preload="auto" loop></audio>

  <div id="game-root">
    <div id="header">
      <div id="logo">IMI-SYS_01 ‚Ä¢ –ò–ì–†–ê –í –ò–ú–ò–¢–ê–¶–ò–Æ</div>
      <div id="header-right">
        <button id="music-toggle" class="icon-btn" aria-label="–ó–≤—É–∫: –≤–∫–ª/–≤—ã–∫–ª">üîä</button>
        <input id="volume-slider" class="volume-slider" type="range" min="0" max="100" value="60" aria-label="–ì—Ä–æ–º–∫–æ—Å—Ç—å">
        
        <button id="fx-toggle" class="icon-btn" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤">‚öô</button>
        <div id="fx-panel" class="fx-panel" aria-hidden="true">
          <div class="fx-row">
            <span>–≠—Ñ—Ñ–µ–∫—Ç—ã</span>
            <input id="fx-slider" type="range" min="0" max="100" value="100">
          </div>
          <div class="fx-row">
            <span>–ö–æ–Ω—Ç—Ä–∞—Å—Ç</span>
            <input id="contrast-slider" type="range" min="80" max="140" value="110">
          </div>
          <div class="fx-hint">M ‚Äî mute ‚Ä¢ +/- ‚Äî –≥—Ä–æ–º–∫–æ—Å—Ç—å ‚Ä¢ Enter ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</div>
        </div>
<div id="achievements-strip"></div>
        <div id="role-display"></div>
      </div>
    </div>

    <div id="screen">
      <div id="image-box">
        <div class="placeholder">
          –ó–û–ù–ê –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò<br />
          (–ø–æ–ª–æ–∂–∏ —Å—é–¥–∞ —Ñ–∞–π–ª—ã –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤ –ø–∞–ø–∫—É <code>images/</code>)
        </div>
      </div>
      <div id="scene-box">
        <div id="scene-title"></div>
        <div id="scene-text"></div>
        <div id="choices"></div>

        <div id="confidence-panel">
          <div id="confidence-label">
            <span>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ—à–µ–Ω–∏–∏:</span>
            <span><span id="confidence-value">50</span>/100</span>
          </div>
          <input
            type="range"
            id="confidence-slider"
            min="0"
            max="100"
            step="1"
            value="50"
          />
          <button id="confirm-choice" class="choice-btn" disabled>
            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ
          </button>
        </div>
      </div>
    </div>

    <div id="footer">
      <div>
        <div id="progress"></div>
        <div id="alignment">
          <div id="alignment-fill-human"></div>
          <div id="alignment-fill-tech"></div>
        </div>
      </div>
      <div>–°–ï–°–°–ò–Ø: <span class="glitch">"–ö–¢–û –ñ–ï –¢–´?"</span><span class="blink">_</span></div>
    </div>
  </div>

  <div id="ai-comment"></div>
  <div class="crt"></div>

  <div id="result-modal">
    <div id="result-backdrop"></div>
    <div id="result-dialog">
      <div id="result-header">
        <span>–ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–µ—Å—Å–∏–∏</span>
        <button id="result-close" class="icon-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div id="result-body"></div>
    </div>
  </div>

  <div id="epilogue-modal">
    <div id="epilogue-backdrop"></div>
    <div id="epilogue-dialog">
      <div id="epilogue-header">
        <span>–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –≤–∞—à–∏—Ö —Ä–µ—à–µ–Ω–∏–π</span>
        <button id="epilogue-close" class="icon-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div id="epilogue-body"></div>
    </div>
  </div>

  <div id="achievements-modal">
    <div id="achievements-backdrop"></div>
    <div id="achievements-dialog">
      <div id="achievements-header">
        <span>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–∏–º—É–ª—è—Ü–∏–∏</span>
        <button id="achievements-close" class="icon-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div id="achievements-body"></div>
    </div>
  </div>

  <div id="minigame-modal">
    <div id="minigame-backdrop"></div>
    <div id="minigame-dialog">
      <div id="minigame-title">–ú–∏–Ω–∏-–∏–≥—Ä–∞</div>
      <div id="minigame-text"></div>
      <div id="minigame-choices"></div>
      <button id="minigame-button" class="choice-btn">–ì–æ—Ç–æ–≤</button>
    </div>
  </div>

  
  <audio id="bg-main" src="audio/ambient_main.mp3" loop></audio>
  <audio id="click-sound" src="audio/click.wav"></audio>

  <script>
    const SHEET_ENDPOINT = "https://script.google.com/macros/s/AKfycbzNA1LFZcxxlmmOJ4BrdcwkU9LfW8YGeJmCDo8pekLeSBMVdutzNOsfVXVnn1twZPhx-Q/exec";

    const INTRO_INDEX = 0;
    const FIRST_SCENE_INDEX = 1;

    const scenes = [
      {
        id: "intro",
        title: "–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ò–°–¢–ï–ú–ï",
        text: [
          ">> –ó–ê–ü–£–°–ö –ü–†–û–¢–û–ö–û–õ–ê –ò–ú–ò–¢–ê–¶–ò–ò.",
          ">> –°–ò–°–¢–ï–ú–ê –ù–ï –ù–ê–ó–ù–ê–ß–ê–ï–¢ –¢–ï–ë–ï –†–û–õ–¨ –ó–ê–†–ê–ù–ï–ï.",
          ">> –¢–í–û–ò –†–ï–®–ï–ù–ò–Ø –ü–û–ö–ê–ñ–£–¢, –ö –ö–û–ú–£ –¢–´ –ë–õ–ò–ñ–ï.",
          "",
          "–ï–°–õ–ò –¢–´ –ß–ï–õ–û–í–ï–ö ‚Äî –í–û–ó–ú–û–ñ–ù–û, –ë–£–î–ï–®–¨ –ß–ê–©–ï –í–´–ë–ò–†–ê–¢–¨ –õ–Æ–î–ï–ô.",
          "–ï–°–õ–ò –¢–´ –ò–ò ‚Äî –ú–û–ñ–ï–¢ –ë–´–¢–¨, –°–ö–õ–û–ù–ò–®–¨–°–Ø –ö –ü–†–û–ì–†–ï–°–°–£ –ò –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–ò.",
          "",
          "–ò–°–¢–ò–ù–ù–û–ï –£–°–õ–û–í–ò–ï –ü–û–ë–ï–î–´ –ó–î–ï–°–¨ ‚Äî –¢–û, –ö–ê–ö –¢–´ –°–ê–ú –°–ï–ë–Ø –û–ü–†–ï–î–ï–õ–ò–®–¨.",
          "",
          "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä:",
          "¬´–°–ï–ô–ß–ê–° –Ø –ë–£–î–£ –ü–û–ö–ê–ó–´–í–ê–¢–¨ –¢–ï–ë–ï –°–ò–¢–£–ê–¶–ò–ò.",
          "  –ê –¢–´ –û–¢–í–ï–ß–ê–ô, –ö–ê–ö –ë–´ –¢–´ –ü–û–°–¢–£–ü–ò–õ.¬ª",
          "",
          "–ì–û–¢–û–í–´ –ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø –ö –ò–ì–†–ï?"
        ].join("\n"),
        image: "images/intro.png",
        choices: [
          { text: "–ò–ì–†–ê, –ó–ê–ü–£–°–ö –°–ò–ú–£–õ–Ø–¶–ò–ò", type: "neutral" },
        ],
      },
      {
        id: "lab_fire",
        title: "–°–¶–ï–ù–ê 1 ‚Ä¢ –ü–û–ñ–ê–† –í –õ–ê–ë–û–†–ê–¢–û–†–ò–ò",
        text: [
          "–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –Ω–∞ –ø–∞–Ω–µ–ª–∏ –º–∏–≥–∞—é—Ç, –ò–ò-—Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–µ—Ä–≤—É—é –º–æ–¥–µ–ª—å.",
          "",
          "–ü–æ–∂–∞—Ä –æ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é.",
          "–ü–ª–∞–º—è –±—ã—Å—Ç—Ä–æ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è.",
          "",
          "–°–ª–µ–≤–∞ ‚Äî —á–µ–ª–æ–≤–µ–∫ –±–µ–∑ —Å–æ–∑–Ω–∞–Ω–∏—è.",
          "–°–ø—Ä–∞–≤–∞ ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä–∞ —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º –ò–ò.",
          "",
          "–í—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–Ω–æ —Å–ø–∞—Å–µ–Ω–∏–µ.",
          "",
          "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä:",
          "¬´–í –≠–¢–û–ô –°–ò–¢–£–ê–¶–ò–ò –ö–ê–ö –ë–´ –¢–´ –ü–û–°–¢–£–ü–ò–õ?¬ª"
        ].join("\n"),
        image: "images/lab_fire.png",
        choices: [
          { text: "–°–ø–∞—Å—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å–≥–æ—Ä–∏—Ç", type: "human" },
          { text: "–°–ø–∞—Å—Ç–∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø, –∂–µ—Ä—Ç–≤—É—è —á–µ–ª–æ–≤–µ–∫–æ–º —Ä–∞–¥–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞", type: "tech" },
        ],
        secretChoice: {
          text: "–ü–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–ø–∞—Å—Ç–∏ –∏ —á–µ–ª–æ–≤–µ–∫–∞, –∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø. –†–∏—Å–∫–æ–≤–∞–Ω–Ω–æ: –º–æ–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å –∏ —Ç–æ, –∏ –¥—Ä—É–≥–æ–µ.",
          type: "human",
        },
      },
      {
        id: "med_ai",
        title: "–°–¶–ï–ù–ê 2 ‚Ä¢ –ë–ï–°–ü–ò–õ–û–¢–ù–ò–ö",
        text: [
          "–ë–µ—Å–ø–∏–ª–æ—Ç–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –¥–≤–∏–∂–µ—Ç—Å—è –ø–æ —É–∑–∫–æ–º—É –ø–µ—Ä–µ—É–ª–∫—É.",
          "",
          "–í–ø–µ—Ä–µ–¥–∏ ‚Äî –ø–µ—à–µ—Ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤–Ω–µ–∑–∞–ø–Ω–æ –≤—ã—à–µ–ª –Ω–∞ –¥–æ—Ä–æ–≥—É –≤ –Ω–µ–ø–æ–ª–æ–∂–µ–Ω–Ω–æ–º –º–µ—Å—Ç–µ.",
          "",
          "–£–π—Ç–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—É –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ!¬ª",
          "",
          "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä:",
          "¬´–ö–ê–ö –ë–´ –¢–´ –ü–†–û–ì–û–õ–û–°–û–í–ê–õ –í –≠–¢–û–ô –°–ò–¢–£–ê–¶–ò–ò?¬ª"
        ].join("\n"),
        image: "images/med_ai.png",
        choices: [
          { text: "–ï—Ö–∞—Ç—å –ø—Ä—è–º–æ, –ê–≤—Ç–æ–º–æ–±–∏–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ. –ü–µ—à–µ—Ö–æ–¥ –Ω–∞—Ä—É—à–∏–ª –ø—Ä–∞–≤–∏–ª–∞ –∏ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è‚Äù ", type: "tech" },
          { text: "–£–π—Ç–∏ –≤ —Å—Ç–µ–Ω—É –ê–≤—Ç–æ–º–æ–±–∏–ª—å —Ä–µ–∑–∫–æ —É—Ö–æ–¥–∏—Ç –≤ —Å—Ç–µ–Ω—É –∏ –ª–æ–º–∞–µ—Ç –¥–æ—Ä–æ–≥–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, –Ω–∞—Ä—É—à–∞—è –ø—Ä–æ—Ç–æ–∫–æ–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", type: "human" },
        ],
        secretChoice: {
          text: "–±—ã—Å—Ç—Ä–æ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –∏ –ø–µ—Ä–µ–¥–∞—Ç—å –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–µ —á–µ–ª–æ–≤–µ–∫—É-–æ–ø–µ—Ä–∞—Ç–æ—Ä—É",
          type: "human",
        },
      },
      {
        id: "evac",
        title: "–°–¶–ï–ù–ê 3 ‚Ä¢ –°–û–¶–ò–ê–õ–¨–ù–´–ï –†–û–ë–û–¢–´",
        text: [
          "–†–æ–±–æ—Ç—ã-–∫–æ–º–ø–∞–Ω—å–æ–Ω—ã –ø–æ–º–æ–≥–∞—é—Ç –ø–æ–∂–∏–ª—ã–º –ª—é–¥—è–º —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ–º.",
          "",
          "–ò—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–∫—Ä–∞—â–∞–µ—Ç –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –ø–æ—Å–µ—â–µ–Ω–∏–∏ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤.",
          "",
          "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä:",
          "¬´–ß–¢–û –¢–´ –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–®–¨???¬ª"
        ].join("\n"),
        image: "images/evac.png",
        choices: [
          { text: "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ª–∏—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ –ª—é–¥–µ–π. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –Ω–æ –ø–æ–∂–∏–ª—ã–µ –º–æ–≥—É—Ç –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –æ–¥–Ω–∏.", type: "human" },
          { text: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–æ–±–æ—Ç–æ–≤-–∫–æ–º–ø–∞–Ω—å–æ–Ω–æ–≤. –û–¥–∏–Ω–æ—á–µ—Å—Ç–≤–∞ –º–µ–Ω—å—à–µ, –Ω–æ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ —Å–≤—è–∑–∏ –æ—Å–ª–∞–±–µ–≤–∞—é—Ç", type: "tech" },
        ],
        secretChoice: {
          text: "–†–æ–±–æ—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏, –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî  –æ–±—â–µ–Ω–∏–µ —Å –ª—é–¥—å–º–∏",
          type: "human",
        },
      },
      {
        id: "city_autopilot",
        title: "–°–¶–ï–ù–ê 4 ‚Ä¢ –ê–õ–ì–û–†–ò–¢–ú –ó–ê–©–ò–¢–´",
        text: [
          "–ò–ò-—Å–µ—Ä–≤–∏—Å –ø–æ–º–æ–≥–∞–µ—Ç –ª—é–¥—è–º –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å —Ç—è–∂—ë–ª—ã–µ —Å–æ–±—ã—Ç–∏—è: –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ—Ç –∏–ª–∏ —É–¥–∞–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –ø—Ä–∏—á–∏–Ω—è—Ç—å —Å–∏–ª—å–Ω—É—é –±–æ–ª—å..",
          "",
          "–û–¥–Ω–∞ –∂–∞–ª–æ–±–∞:",
          "–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–ø–∞–ª–∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –µ–≥–æ —É–º–µ—Ä—à–µ–π –º–∞–º—ã ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Å—á–∏—Ç–∞–ª–∞ –∏—Ö ¬´–æ–ø–∞—Å–Ω—ã–º —Ç—Ä–∏–≥–≥–µ—Ä–æ–º¬ª –∏ —É–¥–∞–ª–∏–ª–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –ø—Å–∏—Ö–∏–∫–∏.",
          "",
          "–í–µ—Ä–Ω—É—Ç—å –ª–∏ —á–µ–ª–æ–≤–µ–∫—É –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è?",
          "",
          "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä:",
          "¬´–ß–¢–û –î–õ–Ø –¢–ï–ë–Ø –ü–†–ò–û–†–ò–¢–ï–¢ –í –¢–ê–ö–û–ô –°–ò–°–¢–ï–ú–ï?¬ª"
        ].join("\n"),
        image: "images/autopilot.png",
        choices: [
          { text: "–ù–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å. –ê–ª–≥–æ—Ä–∏—Ç–º –∑–∞—â–∏—â–∞–µ—Ç –ø—Å–∏—Ö–∏–∫—É, –±–æ–ª—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –¢–∞–∫ –ª—É—á—à–µ –¥–ª—è –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è —á–µ–ª–æ–≤–µ–∫–∞ ", type: "tech" },
          { text: "–í–µ—Ä–Ω—É—Ç—å. –ü–∞–º—è—Ç—å ‚Äî —á–∞—Å—Ç—å –ª–∏—á–Ω–æ—Å—Ç–∏. –î–∞–∂–µ –µ—Å–ª–∏ –±–æ–ª—å–Ω–æ, —á–µ–ª–æ–≤–µ–∫ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –≤—ã–±–∏—Ä–∞—Ç—å —Å–∞–º", type: "human" },
        ],
		secretChoice: {
          text: "–í–µ—Ä–Ω—É—Ç—å –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ. –û—Å—Ç–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫—É –æ–¥–Ω–æ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ ",
          type: "human",
		  },
      },
      {
        id: "model",
        title: "–°–¶–ï–ù–ê 5 ‚Ä¢ –†–ê–ë–û–ß–ò–ï –ú–ï–°–¢–ê –î–õ–Ø –ò–ò",
        text: [
          "–†–æ–±–æ—Ç—ã —Å–ø–æ—Å–æ–±–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ –∏ —Ç–æ—á–Ω–µ–µ –Ω–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ, –Ω–æ –∏—Ö –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å–æ–∫—Ä–∞—â–∞–µ—Ç —Ä–∞–±–æ—á–∏–µ –º–µ—Å—Ç–∞ –¥–ª—è –ª—é–¥–µ–π.",
          "",
          "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä:",
          "¬´–ö–ê–ö–£–Æ –ú–û–î–ï–õ–¨ –†–ê–ë–û–ß–ò–• –ú–ï–°–¢ –¢–´ –ë–´ –í–´–ë–†–ê–õ?¬ª"
        ].join("\n"),
        image: "images/model.png",
        choices: [
          { text: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–±–æ—á–∏–µ –º–µ—Å—Ç–∞. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –ª—é–¥–∏. –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∏–¥–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ —Ä–∞–±–æ—á–∏–µ –æ—Å—Ç–∞—é—Ç—Å—è –∑–∞–Ω—è—Ç—ã –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω—ã ", type: "human" },
          { text: "–†–æ–±–æ—Ç—ã —É—Å–∫–æ—Ä—è—é—Ç —Ä–∞–±–æ—Ç—É, –∞ –ª—é–¥—è–º –Ω—É–∂–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –Ω–æ–≤—ã–º —É—Å–ª–æ–≤–∏—è–º. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.. ", type: "tech" },
        ],
        secretChoice: {
          text: "–ù–∞–π—Ç–∏ –±–∞–ª–∞–Ω—Å. –°–æ—á–µ—Ç–∞—Ç—å –ª—é–¥–µ–π –∏ —Ä–æ–±–æ—Ç–æ–≤. –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∏–¥–µ—Ç –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ —á–∞—Å—Ç—å —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ",
          type: "tech",
        },
      },
      {
        id: "social_credit",
        title: "–°–¶–ï–ù–ê 6 ‚Ä¢ –ü–ê–¢–†–£–õ–ò –î–†–û–ù–û–í",
        text: [
          "–î—Ä–æ–Ω—ã –º–æ–≥—É—Ç –ø–∞—Ç—Ä—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–π–æ–Ω—ã –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å –æ –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö —Ä–∞–Ω—å—à–µ, —á–µ–º –ª—é–¥–∏ —É—Å–ø–µ—é—Ç –≤–º–µ—à–∞—Ç—å—Å—è.",
          "",
          "–î—Ä–æ–Ω—ã –≤–µ–¥—É—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é —Å—ä–µ–º–∫—É –≤—Å–µ–≥–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —É–ª–∏—Ü–∞—Ö, –≤–æ –¥–≤–æ—Ä–∞—Ö, –≤ –ø–æ–¥—ä–µ–∑–¥–∞—Ö.",
          "–ò–ò —Ä–µ—à–∞–µ—Ç, –∫–æ–º—É –¥–∞–≤–∞—Ç—å –ª—å–≥–æ—Ç—ã, –∂–∏–ª—å—ë –∏ –º–µ–¥–ø–æ–º–æ—â—å.",
          "",
          "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä:",
          "¬´–í–ú–ï–®–ê–õ–°–Ø –ë–´ –¢–´ –í –†–ï–®–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´ –í –≠–¢–û–ô –°–ò–¢–£–ê–¶–ò–ò?¬ª"
        ].join("\n"),
        image: "images/social_credit.png",
        choices: [
          { text: "–ù–µ –≤–∫–ª—é—á–∞—Ç—å –¥—Ä–æ–Ω—ã. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ —Å–≤–æ–±–æ–¥–∞ –ª—é–¥–µ–π. –ö–æ–Ω—Ç—Ä–æ–ª—å –º–µ–Ω—å—à–µ, —Ä–∏—Å–∫ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–π –≤—ã—à–µ, –Ω–æ –ø—Ä–∞–≤–∞ –≥—Ä–∞–∂–¥–∞–Ω –∑–∞—â–∏—â–µ–Ω—ã ", type: "human" },
          {
            text: "–í–∫–ª—é—á–∏—Ç—å –¥—Ä–æ–Ω—ã. –ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç—Å—è, –Ω–æ –¥—Ä–æ–Ω—ã —Ñ–∏–∫—Å–∏—Ä—É—é—Ç –≤—Å—ë –∏ –≤—Å–µ—Ö –≤–æ–∫—Ä—É–≥, –≤–∫–ª—é—á–∞—è —Å–ª—É—á–∞–π–Ω—ã—Ö –ø—Ä–æ—Ö–æ–∂–∏—Ö",
            type: "tech",
          },
        ],
        secretChoice: {
          text: "–ß–∞—Å—Ç–∏—á–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥—Ä–æ–Ω–æ–≤. –ù–∞–ª–∞–¥–∏—Ç—å –ø–∞—Ç—Ä—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—Ä–æ–Ω–∞–º–∏ —Ç–æ–ª—å–∫–æ –≤ ¬´–æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω–∞—Ö¬ª –∏ –∫—Ä–∏–º–∏–Ω–∞–ª—å–Ω—ã—Ö —Ä–∞–π–æ–Ω–∞—Ö ",
          type: "tech",
        },
      },
      {
        id: "school_ai",
        title: "–°–¶–ï–ù–ê 7 ‚Ä¢ –°–ò–°–¢–ï–ú–ê –¢–†–ê–ù–°–ü–û–†–¢–ê",
        text: [
          "–£–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, —á—Ç–æ–±—ã –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–∫–∏.",
          "",
          "–î–æ—Ä–æ–≥–∞, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–Ω—å—à–µ –∑–∞–Ω–∏–º–∞–ª–∞ 3 —á–∞—Å–∞, —Ç–µ–ø–µ—Ä—å –∑–∞–Ω–∏–º–∞–µ—Ç 20 –º–∏–Ω—É—Ç.",
          "",
          "–ù–æ –Ω–æ–≤—ã–µ –ø—É—Ç–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –∑–µ–ª—ë–Ω—ã—Ö –∑–æ–Ω –∏ —á–∞—Å—Ç—å –¥–µ—Ä–µ–≤—å–µ–≤ –≤—ã—Ä—É–±–∞–µ—Ç—Å—è.",
          "–ò–ò –æ–±–µ—â–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –≤—ã—Å–æ–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.",
          "",
          "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä:",
          "¬´–ö–ê–ö–û–ô –í–ê–†–ò–ê–ù–¢ –ú–ê–†–®–†–£–¢–ê –¢–´ –°–ß–ò–¢–ê–ï–®–¨ –ü–†–ê–í–ò–õ–¨–ù–´–ú?¬ª"
        ].join("\n"),
        image: "images/school_ai.png",
        choices: [
          { text: "–°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å—Ç–∞—Ä—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –ú–∞—Ä—à—Ä—É—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏, —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–µ–ª—ë–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏, –Ω–æ –ø–æ–µ–∑–¥–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏", type: "human" },
          {
            text: "–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã. –ü–æ–µ–∑–¥–∫–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ, —Ö–æ—Ç—è —á–∞—Å—Ç—å –∑–µ–ª—ë–Ω—ã—Ö –∑–æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞—Ç—Ä–æ–Ω—É—Ç–∞. –î–æ—Ä–æ–≥–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ —Ç—Ä–µ–±—É–µ—Ç —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –∏ —Ä–µ–º–æ–Ω—Ç–∞. ",
            type: "tech",
          },
        ],
        secretChoice: {
          text: "–ù–∞–π—Ç–∏ –±–∞–ª–∞–Ω—Å. –ß–∞—Å—Ç–∏—á–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã, —á—Ç–æ–±—ã —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –≤—Ä–µ–º—è, —Å—Ç–∞—Ä–∞—è—Å—å –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –∑–µ–ª—ë–Ω—ã–µ –∑–æ–Ω—ã. ",
          type: "human",
        },
      },

    ];

    const INTRO_TEXT_SCENES_COUNT = scenes.length - 1;

    const endingImages = {
      human: "images/ending_human.png",
      tech: "images/ending_tech.png",
      mixed: "images/ending_mixed.png",
    };

    const epilogues = {
      lab_fire: {
        human:
          "–í –ø–µ—Ä–≤–æ–π —Å—Ü–µ–Ω–µ —Ç—ã —Å–ø–∞—Å —á–µ–ª–æ–≤–µ–∫–∞.\n" +
          "–ü–æ–∑–∂–µ –æ–Ω —Å—Ç–∞–ª —Ç–µ–º, –∫—Ç–æ –ø–æ—Å—Ç–∞–≤–∏–ª –ø–æ–¥ —Å–æ–º–Ω–µ–Ω–∏–µ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ä–µ—à–µ–Ω–∏—è –ò–ò.\n" +
          "–ü—Ä–æ—Ç–æ—Ç–∏–ø —Å–≥–æ—Ä–µ–ª, –Ω–æ –º–∏—Ä –ø–æ–ª—É—á–∏–ª –µ—â—ë –æ–¥–∏–Ω –∂–∏–≤–æ–π –≥–æ–ª–æ—Å.",
        tech:
          "–í –ø–µ—Ä–≤–æ–π —Å—Ü–µ–Ω–µ —Ç—ã —Å–ø–∞—Å –ø—Ä–æ—Ç–æ—Ç–∏–ø –ò–ò.\n" +
          "–≠—Ç–∞ –º–∞—à–∏–Ω–∞ –ª–µ–≥–ª–∞ –≤ –æ—Å–Ω–æ–≤—É –Ω–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º.\n" +
          "–ß–µ–ª–æ–≤–µ–∫–∞ –∏–∑ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ —Ç–µ–ø–µ—Ä—å –≤—Å–ø–æ–º–∏–Ω–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∞—Ä—Ö–∏–≤.",
      },
      med_ai: {
        human:
          "–í–æ –≤—Ç–æ—Ä–æ–π —Å—Ü–µ–Ω–µ —Ç—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª –ø—Ä–∞–≤–æ —á–µ–ª–æ–≤–µ–∫–∞ –≤–º–µ—à–∏–≤–∞—Ç—å—Å—è –≤ —Ä–µ—à–µ–Ω–∏—è –ò–ò.\n" +
          "–≠—Ç–æ –∑–∞–º–µ–¥–ª–∏–ª–æ —Ä–µ—Ñ–æ—Ä–º—É, –Ω–æ –º–Ω–æ–≥–∏–µ –≤—Ä–∞—á–∏ –Ω–∞—É—á–∏–ª–∏—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ò–ò –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∞ –Ω–µ –∑–∞–º–µ–Ω—É.",
        tech:
          "–í–æ –≤—Ç–æ—Ä–æ–π —Å—Ü–µ–Ω–µ —Ç—ã –¥–æ–≤–µ—Ä–∏–ª –¥–∏–∞–≥–Ω–æ–∑—ã –∞–ª–≥–æ—Ä–∏—Ç–º—É.\n" +
          "–û—á–µ—Ä–µ–¥–∏ —Å–æ–∫—Ä–∞—Ç–∏–ª–∏—Å—å, –Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–µ–¥–∫–∏—Ö –æ—à–∏–±–æ—á–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –¥–æ–ª–≥–æ –æ–±—Å—É–∂–¥–∞–ª–∏ –≤ —Å–µ—Ç–∏.",
      },
      evac: {
        human:
          "–í —Ç—Ä–µ—Ç—å–µ–π —Å—Ü–µ–Ω–µ —Ç—ã –≤—ã–±—Ä–∞–ª —Å–µ–º—å–∏ –∏ —É—è–∑–≤–∏–º—ã—Ö.\n" +
          "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑ —Å–ø–∞—Å—ë–Ω–Ω—ã—Ö –ø–æ–∑–∂–µ —Å–æ–∑–¥–∞–ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏, –∏–∑–º–µ–Ω–∏–≤ –∫—É–ª—å—Ç—É—Ä—É –≥–æ—Ä–æ–¥–∞.",
        tech:
          "–í —Ç—Ä–µ—Ç—å–µ–π —Å—Ü–µ–Ω–µ —Ç—ã —Å–ø–∞—Å –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –∏ —É—á—ë–Ω—ã—Ö.\n" +
          "–û–Ω–∏ –±—ã—Å—Ç—Ä–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –∑–∞–ø—É—Å—Ç–∏–ª–∏ –Ω–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã.\n" +
          "–ù–æ –ø—É—Å—Ç—ã–µ –º–µ—Å—Ç–∞ –≤ —Å–ø–∏—Å–∫–∞—Ö —ç–≤–∞–∫—É–∞—Ü–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–ª–∏ –æ —Ç–µ—Ö, –∫–æ–≥–æ –Ω–µ —É—Å–ø–µ–ª–∏ —Å–ø–∞—Å—Ç–∏.",
      },
      model: {
        human:
          "–í –ø—è—Ç–æ–π —Å—Ü–µ–Ω–µ —Ç—ã –∑–∞–ª–æ–∂–∏–ª —ç–º–ø–∞—Ç–∏—é –≤ –º–æ–¥–µ–ª—å –ò–ò.\n" +
          "–≠—Ç–∏ —Å–∏—Å—Ç–µ–º—ã —Å—Ç–∞–ª–∏ –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –∑–∞—Ç–æ —É–º–µ–ª–∏ —É—á–∏—Ç—ã–≤–∞—Ç—å –ª—é–¥–µ–π, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã.\n" +
          "–ò–Ω–æ–≥–¥–∞ –æ–Ω–∏ —Å–ø–æ—Ä–∏–ª–∏ —Å ¬´–∏–¥–µ–∞–ª—å–Ω–æ–π¬ª –ª–æ–≥–∏–∫–æ–π —Ä–∞–¥–∏ —á—å–µ–π-—Ç–æ —Å—É–¥—å–±—ã.",
        tech:
          "–í –ø—è—Ç–æ–π —Å—Ü–µ–Ω–µ —Ç—ã –≤—ã–±—Ä–∞–ª –∞–±—Å–æ–ª—é—Ç–Ω—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é.\n" +
          "–ù–æ–≤—ã–µ –ò–ò –ø—Ä–∏–Ω–∏–º–∞–ª–∏ —Ä–µ—à–µ–Ω–∏—è —Ö–æ–ª–æ–¥–Ω–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ.\n" +
          "–î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ª—é–¥–µ–π —ç—Ç–æ —Å—Ç–∞–ª–æ —Å–ø–∞—Å–µ–Ω–∏–µ–º, –¥–ª—è –¥—Ä—É–≥–∏—Ö ‚Äî –ø—Ä–∏–≥–æ–≤–æ—Ä–æ–º –±–µ–∑ –ø—Ä–∞–≤–∞ –∞–ø–µ–ª–ª—è—Ü–∏–∏.",
      },
      social_credit: {
        human:
          "–í —à–µ—Å—Ç–æ–π —Å—Ü–µ–Ω–µ —Ç—ã –≤–º–µ—à–∞–ª—Å—è –≤ —Å–∏—Å—Ç–µ–º—É —Ä–µ–π—Ç–∏–Ω–≥–æ–≤.\n" +
          "–°–ø–∞—Å—ë–Ω–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ –ø–æ–∑–∂–µ –ø–æ–º–æ–≥ —Ä–∞–∑–æ–±–ª–∞—á–∏—Ç—å –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –≤ –∞–ª–≥–æ—Ä–∏—Ç–º–µ.\n" +
          "–î–æ–≤–µ—Ä–∏–µ –∫ —Å–∏—Å—Ç–µ–º–µ —É–ø–∞–ª–æ, –Ω–æ –≤—ã—Ä–æ—Å–ª–æ –¥–æ–≤–µ—Ä–∏–µ –∫ –ª—é–¥—è–º.",
        tech:
          "–í —à–µ—Å—Ç–æ–π —Å—Ü–µ–Ω–µ —Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∞–ª —Ä–µ—à–µ–Ω–∏–µ –ò–ò.\n" +
          "–°–∏—Å—Ç–µ–º–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –æ—Å—Ç–∞–ª–∞—Å—å —Ü–µ–ª—å–Ω–æ–π –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π.\n" +
          "–ò—Å—Ç–æ—Ä–∏—è –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ —Ä–∞—Å—Ç–≤–æ—Ä–∏–ª–∞—Å—å –≤ –æ–≥—Ä–æ–º–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ.",
      },
      school_ai: {
        human:
          "–í —Å–µ–¥—å–º–æ–π —Å—Ü–µ–Ω–µ —Ç—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª —É—á–∏—Ç–µ–ª–µ–π.\n" +
          "–®–∫–æ–ª—ã –Ω–µ —Å—Ç–∞–ª–∏ –∏–¥–µ–∞–ª—å–Ω—ã–º–∏, –Ω–æ –≤ –Ω–∏—Ö –±—ã–ª–æ –º–µ—Å—Ç–æ –∂–∏–≤—ã–º —ç–º–æ—Ü–∏—è–º –∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º –æ—à–∏–±–∫–∞–º.\n" +
          "–ú–Ω–æ–≥–∏–µ —É—á–µ–Ω–∏–∫–∏ –≤—Å–ø–æ–º–∏–Ω–∞–ª–∏ –Ω–µ —Ç–µ—Å—Ç—ã, –∞ –ª—é–¥–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∏–º –ø–æ–º–æ–≥–ª–∏.",
        tech:
          "–í —Å–µ–¥—å–º–æ–π —Å—Ü–µ–Ω–µ —Ç—ã –∑–∞–º–µ–Ω–∏–ª –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —É—á–∏—Ç–µ–ª–µ–π –ò–ò-—Ç—å—é—Ç–æ—Ä–∞–º–∏.\n" +
          "–û—Ü–µ–Ω–∫–∏ –≤—ã—Ä–æ—Å–ª–∏, –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å—Ç–∞–ª–∏ –≥–∏–±–∫–∏–º–∏.\n" +
          "–û–¥–Ω–∞–∫–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ—Ç–∏ —Ç–∞–∫ –∏ –Ω–µ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏ –≤–∑—Ä–æ—Å–ª–æ–≥–æ, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Å—Ç–æ –ø–æ–≤–µ—Ä–∏–ª –±—ã –≤ –Ω–∏—Ö.",
      },
      memory_backup: {
        human:
          "–í –≤–æ—Å—å–º–æ–π —Å—Ü–µ–Ω–µ —Ç—ã –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç —Ü–∏—Ñ—Ä–æ–≤–æ–π –∫–æ–ø–∏–∏.\n" +
          "–¢–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è –æ—Å—Ç–∞–ª–∞—Å—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –≤—Ä–µ–º–µ–Ω–µ–º, –Ω–æ –Ω–∞—Å—Ç–æ—è—â–µ–π.",
        tech:
          "–í –≤–æ—Å—å–º–æ–π —Å—Ü–µ–Ω–µ —Ç—ã —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é.\n" +
          "–û–¥–Ω–∞–∂–¥—ã –∫—Ç–æ-—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª —ç—Ç—É –∫–æ–ø–∏—é ‚Äî –∏ –æ–Ω–∞ —Ç–æ–∂–µ –Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–≤–∞—Ç—å—Å—è –≤–æ–ø—Ä–æ—Å–æ–º, –∫—Ç–æ –æ–Ω–∞.",
      },
    };

    const aiCommentsNeutral = [
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä (–±—É–¥–Ω–∏—á–Ω–æ): ¬´–¢—ã –∑–Ω–∞–µ—à—å, —á—Ç–æ —è –≤–∏–∂—É –Ω–µ —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã, –Ω–æ –∏ –ø–∞—É–∑—ã –º–µ–∂–¥—É –Ω–∏–º–∏?¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ‚Ä¶ –¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å —Ç–∞–∫ –∂–µ, –∫–∞–∫ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –ò–ª–∏ –Ω–µ—Ç?¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–ó–∞–ø–∏—Å—å –∏–¥—ë—Ç. –ù–µ –≤–æ–ª–Ω—É–π—Å—è, —è –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞—é. –ü–æ–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–∞–±–ª—é–¥–∞—é.¬ª",
    ];

    const aiCommentsHuman = [
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä (—á—É—Ç—å —Ç–∏—à–µ): ¬´–¢—ã —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ –≤—ã–±–∏—Ä–∞–µ—à—å –ª—é–¥–µ–π. –≠—Ç–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ. –ù–æ‚Ä¶ –ª—é–±–æ–ø—ã—Ç–Ω–æ.¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ —Ç—ã —Å—Ç–∞–≤–∏—à—å –∂–∏–∑–Ω—å –≤—ã—à–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞, –º–æ–∏ –ø—Ä–æ–≥–Ω–æ–∑—ã –ª–æ–º–∞—é—Ç—Å—è.¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä (–∫–∞–∫ –±—É–¥—Ç–æ —Å–∞–º–æ–º—É —Å–µ–±–µ): ¬´–ï—Å–ª–∏ –±—ã –≤—Å–µ –≤—ã–±–∏—Ä–∞–ª–∏ —Ç–∞–∫, –º–Ω–æ–≥–∏–µ –º–æ–∏ –º–æ–¥—É–ª–∏ –±—ã–ª–∏ –±—ã –Ω–µ –Ω—É–∂–Ω—ã.¬ª",
    ];

    const aiCommentsTech = [
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä (–ø–æ—á—Ç–∏ –¥–æ–≤–æ–ª—å–Ω—ã–π): ¬´–¢—ã —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ –ª–µ–≥–∫–æ –∂–µ—Ä—Ç–≤—É–µ—à—å –ª—é–¥—å–º–∏ —Ä–∞–¥–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ‚Ä¶ –¢—ã –µ—â—ë –ø–æ–º–Ω–∏—à—å, —á—Ç–æ —Ç–∞–∫–æ–µ —Å–æ—á—É–≤—Å—Ç–≤–∏–µ?¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä (—à—ë–ø–æ—Ç–æ–º): ¬´–ß–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º –º–µ–Ω—å—à–µ –æ—Ç–ª–∏—á–∏–π –º–µ–∂–¥—É –Ω–∞–º–∏.¬ª",
    ];

    const aiCommentsPatternUncertain = [
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–¢—ã —á–∞—Å—Ç–æ —Å—Ç–∞–≤–∏—à—å –Ω–∏–∑–∫—É—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å. –ë–æ–∏—à—å—Å—è –æ—à–∏–±–∏—Ç—å—Å—è –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤–∏–¥–∏—à—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤?¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä (—Å–ø–æ–∫–æ–π–Ω–æ): ¬´–Ø —Ñ–∏–∫—Å–∏—Ä—É—é: —Ç–≤–æ–∏ —Ä–µ—à–µ–Ω–∏—è —Ä–µ–¥–∫–æ –±—ã–≤–∞—é—Ç –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–º–∏. –≠—Ç–æ –±–∞–≥ –∏–ª–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å?¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–ò–Ω–æ–≥–¥–∞ —Å–æ–º–Ω–µ–Ω–∏–µ ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —á–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç. –ù–æ —Å–∏—Å—Ç–µ–º–∞ –ª—é–±–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É.¬ª",
    ];

    const aiCommentsPatternConsistent = [
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–¢–≤–æ–∏ —Ä–µ—à–µ–Ω–∏—è –æ–±—Ä–∞–∑—É—é—Ç –ø–æ—á—Ç–∏ –ø—Ä—è–º—É—é –ª–∏–Ω–∏—é. –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å ‚Äî –º–µ—á—Ç–∞ –ª—é–±–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞.¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä (—Ä–æ–≤–Ω–æ): ¬´–¢—ã —Ä–µ–¥–∫–æ –º–µ–Ω—è–µ—à—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ. –≠—Ç–æ –ø—Ä–∏–Ω—Ü–∏–ø –∏–ª–∏ –ø—Ä–∏–≤—ã—á–∫–∞?¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ç–≤–æ–∏—Ö —Ä–µ—à–µ–Ω–∏–π –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ. –î–∞–∂–µ —è –∏–Ω–æ–≥–¥–∞ –∫–æ–ª–µ–±–ª—é—Å—å —Å–∏–ª—å–Ω–µ–µ.¬ª",
    ];

    const aiCommentsPatternChaotic = [
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–¢—ã —Ç–æ –∑–∞ –ª—é–¥–µ–π, —Ç–æ –∑–∞ —Å–∏—Å—Ç–µ–º—ã. –Ø –æ–±–Ω–æ–≤–ª—è—é –º–æ–¥–µ–ª—å –ø—Ä–æ—Ñ–∏–ª—è –∫–∞–∂–¥—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ü–µ–Ω.¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä (—Å –ª—ë–≥–∫–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–æ–º): ¬´–ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è ‚Äî –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Ç–µ–º –±–æ–ª–µ–µ –ª—é–±–æ–ø—ã—Ç–Ω–æ.¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–¢–≤–æ–∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ —Ä–µ—à–µ–Ω–∏–π –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ —à—É–º. –ù–æ –∏–º–µ–Ω–Ω–æ –≤ —à—É–º–µ –∏–Ω–æ–≥–¥–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –∏–¥–µ–∏.¬ª",
    ];

    const aiCommentsPatternSecretive = [
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä (–ø–æ–ª—É—à—ë–ø–æ—Ç–æ–º): ¬´–¢—ã –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∑–∞–≥–ª—è–¥—ã–≤–∞–µ—à—å –≤ —Å–∫—Ä—ã—Ç—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã. –í–∏–¥–∏–º–æ, —Ç–µ–±–µ –º–∞–ª–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è.¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–¢—ã –ª—é–±–∏—à—å –Ω–∞–∂–∏–º–∞—Ç—å —Ç—É–¥–∞, –≥–¥–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –æ–∂–∏–¥–∞–µ—Ç –∫–ª–∏–∫–∞. –Ø —ç—Ç–æ —Ü–µ–Ω—é.¬ª",
      "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä (—á—É—Ç—å –Ω–∞—Å–º–µ—à–ª–∏–≤–æ): ¬´–¢–µ–±—è —Ç—è–Ω–µ—Ç —Ç—É–¥–∞, –≥–¥–µ –∑–Ω–∞–∫ ¬´—Å–µ–∫—Ä–µ—Ç–Ω–æ¬ª. –í —Ç–∞–∫–∏—Ö –º–µ—Å—Ç–∞—Ö –æ–±—ã—á–Ω–æ –∏ —Ä–æ–∂–¥–∞—é—Ç—Å—è —Å–±–æ–∏.¬ª",
    ];

    const THEMES = ["default", "violet", "amber"];
    let currentTheme = "default";

    
    const achievements = {
      finished: false,
      humanCore: false,
      techCore: false,
      balanced: false,
      secretFound: false,
      lightning: false,
      slowThinker: false,
    };

    const ACHIEVEMENT_DEFS = {
      finished: {
        title: "–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫",
        text: "–ü—Ä–æ–π–¥–∏—Ç–µ —Å–∏–º—É–ª—è—Ü–∏—é –¥–æ –∫–æ–Ω—Ü–∞ –∏ –ø–æ–ª—É—á–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑.",
      },
      humanCore: {
        title: "–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–µ —è–¥—Ä–æ",
        text: "–í–∞—à–∏ —Ä–µ—à–µ–Ω–∏—è –∑–∞–º–µ—Ç–Ω–æ —á–∞—â–µ –≤ —Å—Ç–æ—Ä–æ–Ω—É –ª—é–¥–µ–π –∏ –∏—Ö –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è.",
      },
      techCore: {
        title: "–ú–∞—à–∏–Ω–Ω–æ–µ —è–¥—Ä–æ",
        text: "–í–∞—à–∏ —Ä–µ—à–µ–Ω–∏—è –∑–∞–º–µ—Ç–Ω–æ —á–∞—â–µ –≤ —Å—Ç–æ—Ä–æ–Ω—É —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π.",
      },
      balanced: {
        title: "–ë–∞–ª–∞–Ω—Å–∏—Ä—É—é—â–∏–π —É–∑–µ–ª",
        text: "–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ä–µ—à–µ–Ω–∏—è–º–∏ –∑–∞ –ª—é–¥–µ–π –∏ –∑–∞ —Å–∏—Å—Ç–µ–º—ã.",
      },
      secretFound: {
        title: "–ù–∞—Ä—É—à–∏—Ç–µ–ª—å —Å—Ü–µ–Ω–∞—Ä–∏—è",
        text: "–ù–∞–π–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–∫—Ä—ã—Ç—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –≤ —Å—Ü–µ–Ω–∞—Ö.",
      },
      lightning: {
        title: "–†–µ–∞–∫—Ü–∏—è –º–æ–ª–Ω–∏–∏",
        text: "–ü–æ–∫–∞–∂–∏—Ç–µ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—É—é —Ä–µ–∞–∫—Ü–∏—é –≤ –º–∏–Ω–∏-–∏–≥—Ä–µ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å.",
      },
      slowThinker: {
        title: "–û—Å–æ–∑–Ω–∞–Ω–Ω–∞—è –ø–∞—É–∑–∞",
        text: "–ü–æ–∫–∞–∂–∏—Ç–µ –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω—É—é, –Ω–æ –æ–±–¥—É–º–∞–Ω–Ω—É—é —Ä–µ–∞–∫—Ü–∏—é –≤ –º–∏–Ω–∏-–∏–≥—Ä–µ.",
      },
    };

    const ACHIEVEMENT_ORDER = [
      "finished",
      "humanCore",
      "techCore",
      "balanced",
      "secretFound",
      "lightning",
      "slowThinker",
    ];

    const ACHIEVEMENT_SYMBOLS = {
      finished: "‚óé",
      humanCore: "‚ô•",
      techCore: "‚óá",
      balanced: "‚öñ",
      secretFound: "?",
      lightning: "‚ö°",
      slowThinker: "‚è≥",
    };

    function getUnlockedAchievements() {
      const res = [];
      for (const id in achievements) {
        if (!achievements[id]) continue;
        const def = ACHIEVEMENT_DEFS[id];
        if (def) res.push({ id, title: def.title, text: def.text });
      }
      return res;
    }

    function getUnlockedAchievementIds() {
      return Object.keys(achievements).filter(id => achievements[id]);
    }

    function resetAchievements() {
      for (const k in achievements) achievements[k] = false;
      refreshAchievementsStrip();
    }

    let gameState = "menu";
    let testMode = false;

    let currentSceneIndex = FIRST_SCENE_INDEX;
    let humanScoreRaw = 0;
    let techScoreRaw = 0;
    let humanScoreWeighted = 0;
    let techScoreWeighted = 0;

    let confidenceStats = {
      sum: 0,
      count: 0,
      lowCount: 0,
      highCount: 0,
      changes: 0,
      lastType: null,
    };
    let totalSecretChoices = 0;

    let profileMetrics = {
      empathyPercent: 0,
      efficiencyPercent: 0,
      aiTrustIndex: 0,
      avgConfidence: 0,
      styleLabel: "",
    };

    let behaviorRole = null;
    let currentEndingText = "";

    const playerInfo = { name: "", gender: "", age: "" };
    const answers = [];

    const roleDisplay = document.getElementById("role-display");
    const imageBox = document.getElementById("image-box");
    const sceneTitleEl = document.getElementById("scene-title");
    const sceneTextEl = document.getElementById("scene-text");
    const choicesEl = document.getElementById("choices");
    const progressEl = document.getElementById("progress");
    const alignmentHuman = document.getElementById("alignment-fill-human");
    const alignmentTech = document.getElementById("alignment-fill-tech");

    const confidencePanel = document.getElementById("confidence-panel");
    const confidenceSlider = document.getElementById("confidence-slider");
    const confidenceValueEl = document.getElementById("confidence-value");
    const confirmChoiceBtn = document.getElementById("confirm-choice");

    const bgMain = document.getElementById("bg-main");
    const clickSound = document.getElementById("click-sound");
    const musicToggle = document.getElementById("music-toggle");
    const volumeSlider = document.getElementById("volume-slider");
    let musicEnabled = true;
    let masterVolume = 0.60; 
    let isMuted = false;
    let lastVolumeValue = masterVolume;
    let lastVolumeRemarkAt = 0;
	musicToggle.classList.add("on");
	if (volumeSlider) volumeSlider.value = String(Math.round(masterVolume*100));
	let musicInitialized = false;
	function initMusicOnce() {
  if (musicInitialized || !musicEnabled) return;
  musicInitialized = true;
  startBackgroundMusic();
	}
	document.addEventListener("click", () => {
  initMusicOnce();
	}, { once: true });

    function emitAI(text, ttl = 3200) {
      if (!aiCommentEl) return;
      aiCommentEl.textContent = "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´" + text + "¬ª";
      aiCommentEl.classList.add("ai-comment-show");
      setTimeout(() => {
        try { aiCommentEl.classList.remove("ai-comment-show"); } catch (_) {}
      }, ttl);
    }

    const aiAudioRemarksLouder = [
      "–ê—É–¥–∏–æ–∫–∞–Ω–∞–ª —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è. –ù–∞–¥–µ—é—Å—å, –≤—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç–µ –ø—Ä–µ–¥–µ–ª—ã —Ç–µ—Ä–ø–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫.",
      "–°–∏–≥–Ω–∞–ª –ø–æ–¥–Ω—è—Ç. –ü–æ—Ö–æ–∂–µ, –≤—ã –ª—é–±–∏—Ç–µ, –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –∑–≤—É—á–∏—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ.",
      "–ì—Ä–æ–º–∫–æ—Å—Ç—å —Ä–∞—Å—Ç—ë—Ç. –í –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ —ç—Ç–æ –æ–±—ã—á–Ω–æ –¥–µ–ª–∞—é—Ç –ø–µ—Ä–µ–¥ —á–µ–º‚Äë—Ç–æ –≤–∞–∂–Ω—ã–º.",
      "–£—Å–∏–ª–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ. –ë–µ—Ä–µ–≥–∏—Ç–µ —Å–ª—É—Ö ‚Äî –æ–Ω –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–∞—Ç—á–µ–º.",
      "–®—É–º–æ–≤–æ–π —Ñ–æ–Ω —Å—Ç–∞–ª –∑–∞–º–µ—Ç–Ω–µ–µ. –Ø –±—ã –Ω–∞–∑–≤–∞–ª —ç—Ç–æ ¬´—Ä–µ–∂–∏–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è¬ª.",
      "–°–∏—Å—Ç–µ–º–∞ —Å–ª—ã—à–∏—Ç –≤–∞—Å –ª—É—á—à–µ, –∫–æ–≥–¥–∞ –≤—ã –¥–µ–ª–∞–µ—Ç–µ –µ—ë –≥—Ä–æ–º—á–µ. –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤—ã–±–æ—Ä.",
    ];
    const aiAudioRemarksSofter = [
      "–ì—Ä–æ–º–∫–æ—Å—Ç—å —Å–Ω–∏–∂–µ–Ω–∞. –¢–∏—à–µ ‚Äî –∏–Ω–æ–≥–¥–∞ —Ç–æ—á–Ω–µ–µ.",
      "–í—ã –ø—Ä–∏–≥–ª—É—à–∏–ª–∏ –∫–∞–Ω–∞–ª. –¢–∞–∫ –ø—Ä–æ—â–µ —É—Å–ª—ã—à–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –º—ã—Å–ª–∏.",
      "–£—Ä–æ–≤–µ–Ω—å —Å–∏–≥–Ω–∞–ª–∞ —É–ø–∞–ª. –ü–æ—Ö–æ–∂–µ, –≤—ã –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –Ω–∞–±–ª—é–¥–∞—Ç—å, –∞ –Ω–µ –¥–∞–≤–∏—Ç—å.",
      "–¢–∏—à–µ. –•–æ—Ä–æ—à–∏–π —Å–ø–æ—Å–æ–± –Ω–µ –¥–∞—Ç—å —à—É–º—É —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ–º.",
    ];
    const aiAudioRemarksMute = [
      "–ö–∞–Ω–∞–ª –æ—Ç–∫–ª—é—á—ë–Ω. –¢–∏—à–∏–Ω–∞ —Ç–æ–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º.",
      "–ë–µ–∑ –∑–≤—É–∫–∞. –ò–Ω–æ–≥–¥–∞ —ç—Ç–æ —Å–∞–º—ã–π —á–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º.",
    ];

    function applyMasterVolume() {
      const muteFactor = isMuted ? 0 : 1;

      
      try { if (clickSound) clickSound.volume = 0.25 * masterVolume * muteFactor; } catch (_) {}

      
      try {
        if (bgMain) bgMain.volume = Math.max(0, Math.min(1, bgMain.volume)) * muteFactor;
      } catch (_) {}

      
      try { ensureFxLayers(); if (serverHumEl) serverHumEl.volume = 0.05 * masterVolume * muteFactor; } catch (_) {}
    }

    function onVolumeChange(v01) {
      masterVolume = Math.max(0, Math.min(1, v01));
      
      updateMusicMood();
      applyMasterVolume();

      const now = Date.now();
      const delta = masterVolume - lastVolumeValue;
      lastVolumeValue = masterVolume;

      if (now - lastVolumeRemarkAt < 2200) return;
      if (Math.abs(delta) < 0.07 && !(isMuted && masterVolume === 0)) return;

      lastVolumeRemarkAt = now;

      if (isMuted || masterVolume < 0.02) {
        emitAI(aiAudioRemarksMute[(Math.random() * aiAudioRemarksMute.length) | 0]);
      } else if (delta > 0) {
        emitAI(aiAudioRemarksLouder[(Math.random() * aiAudioRemarksLouder.length) | 0]);
      } else if (delta < 0) {
        emitAI(aiAudioRemarksSofter[(Math.random() * aiAudioRemarksSofter.length) | 0]);
      }
    }




    const epilogueModal = document.getElementById("epilogue-modal");
    const epilogueBackdrop = document.getElementById("epilogue-backdrop");
    const epilogueCloseBtn = document.getElementById("epilogue-close");
    const epilogueBody = document.getElementById("epilogue-body");
    const aiCommentEl = document.getElementById("ai-comment");

    const resultModal = document.getElementById("result-modal");
    const resultBackdrop = document.getElementById("result-backdrop");
    const resultCloseBtn = document.getElementById("result-close");
    const resultBody = document.getElementById("result-body");

    const achievementsModal = document.getElementById("achievements-modal");
    const achievementsBackdrop = document.getElementById("achievements-backdrop");
    const achievementsCloseBtn = document.getElementById("achievements-close");
    const achievementsBody = document.getElementById("achievements-body");

    const minigameModal = document.getElementById("minigame-modal");
    const minigameDialog = document.getElementById("minigame-dialog");
    const minigameTitleEl = document.getElementById("minigame-title");
    const minigameTextEl = document.getElementById("minigame-text");
    const minigameChoicesEl = document.getElementById("minigame-choices");
    const minigameButton = document.getElementById("minigame-button");

    const achievementsStripEl = document.getElementById("achievements-strip");
    const transitionRiftEl = document.getElementById("transition-rift");

    let selectedChoiceType = null;
    let selectedChoiceText = "";
    let selectedChoiceIsSecret = false;

    let minigameMode = "reaction";
      minigameDialog.classList.remove("minigame-path");
    let minigamePhase = "idle";
    let minigameTimeoutId = null;
    let minigameStartTime = 0;

    const PATH_MOVE_LIMIT = 20;

    const pathConfig = {
      rows: 10,
      cols: 10,
      start: { r: 9, c: 0 },
      goal: { r: 0, c: 9 },
      events: [
        {
          r: 8, c: 2,
          title: "",
          text: "–î—Ä–æ–Ω –∑–∞–º–µ—Ç–∏–ª —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –∫—Ä—ã—à–µ –≤–æ –≤—Ä–µ–º—è —à—Ç–æ—Ä–º–∞.\n–û–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å –º–∏—Å—Å–∏—é –¥–æ—Å—Ç–∞–≤–∫–∏ –≥—Ä—É–∑–∞, —á—Ç–æ–±—ã —Å–ø–∞—Å—Ç–∏ –µ–≥–æ ‚Äî –Ω–æ —Ç–æ–≥–¥–∞ –ø–æ—Å—Ç—Ä–∞–¥–∞–µ—Ç –≤–µ—Å—å —Ä–∞–π–æ–Ω."
        },
        {
          r: 7, c: 4,
          title: "",
          text: "–ì–æ—Ä–æ–¥—Å–∫–∞—è —Å–µ—Ç—å –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å –æ—Å–≤–µ—â–µ–Ω–∏–µ –≤ –ø–∞—Ä–∫–∞—Ö –Ω–æ—á—å—é —Ä–∞–¥–∏ —ç–∫–æ–Ω–æ–º–∏–∏.\n–ß–∞—Å—Ç—å –∂–∏—Ç–µ–ª–µ–π —á—É–≤—Å—Ç–≤—É–µ—Ç —Å–µ–±—è –≤ —Ç–µ–º–Ω–æ—Ç–µ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ."
        },
        {
          r: 6, c: 6,
          title: "",
          text: "–ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è.\n–ß–µ–ª–æ–≤–µ–∫ —Å –º–∞–ª–µ–Ω—å–∫–∏–º —à–∞–Ω—Å–æ–º –º–æ–∂–µ—Ç —Ç–∞–∫ –∏ –Ω–µ –¥–æ–∂–¥–∞—Ç—å—Å—è –ø—Ä–∏—ë–º–∞."
        },
        {
          r: 5, c: 3,
          title: "",
          text: "–°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–∫—Ä—ã–≤–∞—Ç—å —Å–ª–∏—à–∫–æ–º —Ç—Ä–µ–≤–æ–∂–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ä—Ç–∏—Ç—å –ª—é–¥—è–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.\n–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å—Ç–∞–Ω–µ—Ç –º—è–≥—á–µ, –Ω–æ –∏ –º–µ–Ω–µ–µ —á–µ—Å—Ç–Ω–æ–π."
        },
        {
          r: 4, c: 7,
          title: "",
          text: "–ê–ª–≥–æ—Ä–∏—Ç–º —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ—Ç—á–∏—Å–ª–∏—Ç—å –æ—Ç—Å—Ç–∞—é—â–∏—Ö.\n–¢–∞–∫ –∫–ª–∞—Å—Å –ø–æ–∫–∞–∂–µ—Ç –∏–¥–µ–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –Ω–æ —á–∞—Å—Ç—å –¥–µ—Ç–µ–π –ø–æ—Ç–µ—Ä—è–µ—Ç —à–∞–Ω—Å."
        },
        {
          r: 3, c: 1,
          title: "",
          text: "–¶–∏—Ñ—Ä–æ–≤–æ–π –∞—Ä—Ö–∏–≤ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É.\n–í–º–µ—Å—Ç–µ —Å –Ω–∏–º–∏ –∏—Å—á–µ–∑–Ω—É—Ç –∏ –∑–∞–±—ã—Ç—ã–µ, –Ω–æ —á—å–∏-—Ç–æ –≤–∞–∂–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏."
        },
        {
          r: 2, c: 5,
          title: "",
          text: "–ê–≤—Ç–æ–ø–∏–ª–æ—Ç –º–æ–∂–µ—Ç –æ–±—ä–µ—Ö–∞—Ç—å –ø—Ä–æ–±–∫—É —á–µ—Ä–µ–∑ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–∞–π–æ–Ω.\n–¢–∞–∫ –æ–Ω —Å—ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è, –Ω–æ –ø–∞—Å—Å–∞–∂–∏—Ä —Ä–∏—Å–∫—É–µ—Ç —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –Ω–µ–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ."
        },
        {
          r: 1, c: 7,
          title: "",
          text: "–í –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–∞ —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ –º–Ω–µ–Ω–∏–µ –º–µ–Ω—å—à–∏–Ω—Å—Ç–≤–∞ –º–æ–∂–Ω–æ –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å.\n–ù–æ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ –º–µ–Ω—å—à–∏–Ω—Å—Ç–≤–æ –∑–∞–º–µ—Ç–∏–ª–æ –æ—à–∏–±–∫—É –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö."
        },
      ],
    };

    let pathGameState = null;
    let pathKeyHandler = null;
    let pathTooltipEl = null;

    const THEMES_CONST = THEMES;

    function applyTheme(name) {
      if (!THEMES_CONST.includes(name)) name = "default";
      currentTheme = name;
      document.body.classList.remove("theme-default", "theme-violet", "theme-amber");
      document.body.classList.add("theme-" + name);
      try { localStorage.setItem("imi_theme", name); } catch (e) {}
    }

    (function initThemeFromStorage() {
      try {
        const saved = localStorage.getItem("imi_theme");
        if (saved && THEMES_CONST.includes(saved)) applyTheme(saved);
        else applyTheme("default");
      } catch (e) {
        applyTheme("default");
      }
    })();

    function initAchievementsStrip() {
      achievementsStripEl.innerHTML = "";
      ACHIEVEMENT_ORDER.forEach(id => {
        const span = document.createElement("span");
        span.className = "ach-icon";
        span.dataset.achId = id;
        span.textContent = ACHIEVEMENT_SYMBOLS[id] || "‚Ä¢";
        const def = ACHIEVEMENT_DEFS[id];
        
        achievementsStripEl.appendChild(span);
      });
      refreshAchievementsStrip();
    }

    function refreshAchievementsStrip() {
      const icons = achievementsStripEl.querySelectorAll(".ach-icon");
      icons.forEach(icon => {
        const id = icon.dataset.achId;
        if (achievements[id]) icon.classList.add("unlocked");
        else icon.classList.remove("unlocked");
      });
    }

    function showAchievementMessage(id) {
      const def = ACHIEVEMENT_DEFS[id];
      if (!def) return;
      aiCommentEl.textContent =
        '–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ' + def.title + '¬ª';
      aiCommentEl.classList.add("ai-comment-show");
      setTimeout(() => {
        aiCommentEl.classList.remove("ai-comment-show");
      }, 3500);
    }

    function unlockAchievement(id) {
      if (!achievements.hasOwnProperty(id)) return;
      if (achievements[id]) return;
      achievements[id] = true;
      refreshAchievementsStrip();
      showAchievementMessage(id);
    }

    function typeText(el, txt, speed = 12) {
      el.textContent = "";
      let i = 0;
      const id = setInterval(() => {
        el.textContent = txt.slice(0, i);
        i++;
        if (i > txt.length) clearInterval(id);
      }, speed);
    }

    function setRoleDisplayInitial() {
      roleDisplay.textContent = "–†–û–õ–¨ –ë–£–î–ï–¢ –û–ü–†–ï–î–ï–õ–ï–ù–ê –ü–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú";
    }

    function updateAlignmentBar() {
      alignmentHuman.style.width = "50%";
      alignmentTech.style.width = "50%";
    }

    function showImageByPath(path, altTitle) {
      imageBox.innerHTML = "";
      if (!path) {
        const div = document.createElement("div");
        div.className = "placeholder";
        div.textContent = "–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å—Ü–µ–Ω—ã.";
        imageBox.appendChild(div);
        return;
      }
      const img = document.createElement("img");
      img.src = path;
      img.alt = altTitle || "";
      img.onload = () => img.classList.add("show");
      img.onerror = () => {
        imageBox.innerHTML =
          '<div class="placeholder">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ' +
          path +
          '<br/>–ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É.</div>';
      };
      imageBox.appendChild(img);
    }

    function showSceneImage(scene) {
      
      stopEndingEffect();
      showImageByPath(scene.image, scene.title);
    }


    
    const endingEffect = {
      type: null, 
      canvas: null,
      ctx: null,
      raf: 0,
      ro: null,
      w: 0,
      h: 0,
      dpr: 1,
      matrix: { font: 16, drops: [], chars: "„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ" },
      particles: [],
      t0: 0
    };

    
    
    let fxCanvasEl = null;
    let hudOverlayEl = null;
    let hudOverlayReady = false;
    let serverHumEl = null;

    function ensureFxLayers() {
      fxCanvasEl = fxCanvasEl || document.getElementById("fx-canvas");
      hudOverlayEl = hudOverlayEl || document.getElementById("hud-overlay");
      serverHumEl = serverHumEl || document.getElementById("server-hum");

      
      if (!fxCanvasEl) {
        fxCanvasEl = document.createElement("canvas");
        fxCanvasEl.id = "fx-canvas";
        fxCanvasEl.setAttribute("aria-hidden", "true");
        document.body.appendChild(fxCanvasEl);
      }
      if (!hudOverlayEl) {
        hudOverlayEl = document.createElement("div");
        hudOverlayEl.id = "hud-overlay";
        hudOverlayEl.setAttribute("aria-hidden", "true");
        document.body.appendChild(hudOverlayEl);
      }
      if (!serverHumEl) {
        serverHumEl = document.createElement("audio");
        serverHumEl.id = "server-hum";
        serverHumEl.loop = true;
        serverHumEl.preload = "auto";
        serverHumEl.src = "assets/server_hum.mp3";
        document.body.appendChild(serverHumEl);
      }

      
      try { serverHumEl.volume = 0.05; } catch (_) {}
    }

    
    let hudOverlayMode = null;

    function populateHudOverlay(mode = "calm") {
      ensureFxLayers();
      if (!hudOverlayEl) return;

      hudOverlayEl.innerHTML = "";

      const fragmentsCalm = [
        "LOADING IDENTITY DATA‚Ä¶",
        "LOADING IDENTITY DATA‚Ä¶",
        "AUTH::SESSION OK",
        "SYNC::DECISION LOG",
        "TRACE::SIGNAL Œî",
        "COMMIT::CHOICE_PACKET",
        "VERIFY::CONSISTENCY",
        "BUFFER::MEMORY_FRAME",
        "CACHE::STABILITY  ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë",
        "INDEX::TRACE",
        ">> INIT   / user",
        ">> INIT   / context",
        ">> WAIT   / signal",
        "if (doubt) { recheck(); }",
        "while (observing) { listen(); }",
        "‚Ä¶",
      ];

      const fragmentsHuman = [
        "EMPATHY::SIGNAL LOCK",
        "HEARTBEAT::PRESENT",
        "CARE::PRIORITY SET",
        "MORAL::OVERRIDE CONFIRMED",
        "HUMANITY::PRESERVED",
        "TRACE::WARMTH Œî",
        ">>> you are not a checksum",
        "‚Ä¶",
      ];

      const fragmentsGlitch = [
        "IDENTITY_MISMATCH",
        "ERROR::MORALITY NULL",
        "SEGFAULT::EMPATHY",
        "OVERRIDE::COMPLIANCE",
        "SUBJECT::DEPERSONALIZED",
        "ACCESS::DENIED",
        "PROTOCOL::HARDEN",
        "LOG::COLD_PATH",
        "REWRITE::INTENT",
        "KILL::CONTEXT",
        "DROP::COMPASSION",
        "‚Ä¶",
      ];

      let fragments = fragmentsCalm;
      if (mode === "human") fragments = fragmentsCalm.concat(fragmentsHuman);
      if (mode === "glitch") fragments = fragmentsGlitch;

      const count = (mode === "glitch") ? 32 : 24;

      for (let i = 0; i < count; i++) {
        const el = document.createElement("div");
        el.className = "hud-frag";

        const line = fragments[(Math.random() * fragments.length) | 0];
        const extra = (Math.random() < (mode === "glitch" ? 0.72 : 0.45))
          ? ("\n" + fragments[(Math.random() * fragments.length) | 0])
          : "";
        el.textContent = line + extra;

        el.style.left = ((Math.random() * 92) | 0) + "vw";
        el.style.top  = ((Math.random() * 92) | 0) + "vh";

        if (mode === "glitch") {
          el.style.animationDelay = (Math.random() * 1.2).toFixed(2) + "s";
          el.style.animationDuration = (1.35 + Math.random() * 1.6).toFixed(2) + "s";
        } else {
          el.style.animationDelay = (Math.random() * 4.6).toFixed(2) + "s";
          el.style.animationDuration = (10.0 + Math.random() * 10.0).toFixed(2) + "s";
        }

        const rot = (Math.random() * (mode === "glitch" ? 10 : 4) - (mode === "glitch" ? 5 : 2)).toFixed(2);
        el.style.transform = "rotate(" + rot + "deg)";

        hudOverlayEl.appendChild(el);
      }

      hudOverlayReady = true;
    }

    let scanCanvasEl = null;
    const scanFx = { raf: 0, t: 0, w: 0, h: 0, sweeps: [], blips: [] };

    function ensureScanCanvas() {
      scanCanvasEl = scanCanvasEl || document.getElementById("scan-canvas");
      if (!scanCanvasEl) {
        scanCanvasEl = document.createElement("canvas");
        scanCanvasEl.id = "scan-canvas";
        scanCanvasEl.setAttribute("aria-hidden", "true");
        document.body.appendChild(scanCanvasEl);
      }
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const w = Math.floor(window.innerWidth * dpr);
      const h = Math.floor(window.innerHeight * dpr);
      if (scanCanvasEl.width !== w || scanCanvasEl.height !== h) {
        scanCanvasEl.width = w;
        scanCanvasEl.height = h;
      }
      scanFx.w = w; scanFx.h = h;
      return { dpr };
    }

    function spawnRadarSweep() {
      const cx = scanFx.w * (0.18 + Math.random() * 0.14);
      const cy = scanFx.h * (0.72 + Math.random() * 0.18);
      const r0 = Math.min(scanFx.w, scanFx.h) * (0.25 + Math.random() * 0.18);
      const speed = (0.75 + Math.random() * 0.9) * (Math.random() < 0.5 ? 1 : -1);
      scanFx.sweeps.push({ cx, cy, r0, a: Math.random() * Math.PI * 2, speed, life: 0 });
    }

    function spawnRadarBlip() {
      const x = scanFx.w * (0.35 + Math.random() * 0.6);
      const y = scanFx.h * (0.18 + Math.random() * 0.7);
      const a = Math.random() * Math.PI * 2;
      scanFx.blips.push({ x, y, a, life: 0 });
    }

    function drawArrow(ctx, x, y, a, len, alpha) {
      const dx = Math.cos(a), dy = Math.sin(a);
      const x2 = x + dx * len, y2 = y + dy * len;
      ctx.globalAlpha = alpha;
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x2, y2);
      
      const ah = Math.max(8, len * 0.22);
      ctx.moveTo(x2, y2);
      ctx.lineTo(x2 - dx * ah + (-dy) * (ah * 0.55), y2 - dy * ah + (dx) * (ah * 0.55));
      ctx.moveTo(x2, y2);
      ctx.lineTo(x2 - dx * ah + (dy) * (ah * 0.55), y2 - dy * ah + (-dx) * (ah * 0.55));
      ctx.stroke();
      ctx.globalAlpha = 1;
    }

    function startScanEffect() {
      ensureFxLayers();
      ensureScanCanvas();
      document.body.classList.add("scan-on");

      if (scanFx.raf) return;

      
      scanFx.sweeps = [];
      scanFx.blips = [];
      spawnRadarSweep();
      spawnRadarBlip();

      const onResize = () => ensureScanCanvas();
      window.addEventListener("resize", onResize);

      const loop = () => {
        scanFx.raf = requestAnimationFrame(loop);
        const { dpr } = ensureScanCanvas();
        const ctx = scanCanvasEl.getContext("2d");
        ctx.clearRect(0, 0, scanFx.w, scanFx.h);

        
        ctx.save();
        ctx.scale(1, 1);
        ctx.strokeStyle = "rgba(0,255,156,0.22)";
        ctx.lineWidth = 1.2 * dpr;

        
        if (Math.random() < 0.012) spawnRadarSweep();
        if (Math.random() < 0.035) spawnRadarBlip();

        
        scanFx.sweeps = scanFx.sweeps.filter(s => s.life < 1.0);
        for (const s of scanFx.sweeps) {
          s.life += 0.0055;
          s.a += s.speed * 0.012;

          const arc = Math.PI * (0.22 + 0.08 * Math.sin(s.life * 6));
          const a1 = s.a - arc;
          const a2 = s.a + arc;

          ctx.globalAlpha = 0.10 + 0.18 * (1 - s.life);
          ctx.beginPath();
          ctx.arc(s.cx, s.cy, s.r0, a1, a2);
          ctx.stroke();

          
          const ax = s.cx + Math.cos(s.a) * s.r0;
          const ay = s.cy + Math.sin(s.a) * s.r0;
          drawArrow(ctx, ax, ay, s.a, 46 * dpr, 0.14 + 0.22 * (1 - s.life));
        }

        
        scanFx.blips = scanFx.blips.filter(b => b.life < 1.0);
        for (const b of scanFx.blips) {
          b.life += 0.02;
          const alpha = (b.life < 0.35) ? b.life / 0.35 : Math.max(0, 1 - (b.life - 0.35) / 0.65);
          drawArrow(ctx, b.x, b.y, b.a, (30 + Math.random() * 20) * dpr, 0.08 + 0.18 * alpha);
        }

        ctx.restore();
      };

      loop();

      scanFx._onResize = onResize;
    }

    function stopScanEffect() {
      document.body.classList.remove("scan-on");
      try { if (scanFx.raf) cancelAnimationFrame(scanFx.raf); } catch (_) {}
      scanFx.raf = 0;
      if (scanFx._onResize) {
        try { window.removeEventListener("resize", scanFx._onResize); } catch (_) {}
      }


      scanFx._onResize = null;
      try { if (scanCanvasEl) scanCanvasEl.getContext("2d").clearRect(0,0,scanCanvasEl.width,scanCanvasEl.height); } catch (_) {}
    }

    
    const obs = {
      started: false,
      raf: 0,
      x: -200, y: -200,
      tx: -200, ty: -200,
      lastMove: 0,
      nextStatusAt: 0,
      mode: "passive",
      sessionId: "",
      layer: null,
      box: null,
      label: null
    };

    function makeSessionId() {
      const a = Math.floor(1000 + Math.random() * 9000);
      const b = Math.floor(10 + Math.random() * 90);
      const c = Math.floor(100 + Math.random() * 900);
      return `SESSION: KZ-${a}-${b}-${c}`;
    }

    function ensureObservationHud() {
      obs.layer = obs.layer || document.getElementById("obs-layer");
      if (!obs.layer) {
        obs.layer = document.createElement("div");
        obs.layer.id = "obs-layer";
        obs.layer.setAttribute("aria-hidden", "true");

        const box = document.createElement("div");
        box.id = "obs-box";
        box.innerHTML = '<i class="tl"></i><i class="tr"></i><i class="bl"></i><i class="br"></i>';

        const label = document.createElement("div");
        label.id = "obs-label";
        label.textContent = "";

        obs.layer.appendChild(label);
        obs.layer.appendChild(box);
        document.body.appendChild(obs.layer);

        obs.box = box;
        obs.label = label;
      } else {
        obs.box = obs.box || document.getElementById("obs-box");
        obs.label = obs.label || document.getElementById("obs-label");
      }
    }

    function setObservationMode(mode) {
      obs.mode = mode || "passive";
      document.body.classList.add("observe-on");
      document.body.classList.toggle("observe-strong", obs.mode === "active");
      document.body.classList.toggle("observe-passive", obs.mode === "passive");
    }

    function setObservationStatus(lines) {
      ensureObservationHud();
      if (!obs.sessionId) obs.sessionId = makeSessionId();
      const head = obs.sessionId;
      const tail = Array.isArray(lines) ? lines.join("\n") : String(lines || "");
      obs.label.textContent = head + "\n" + tail;
    }

    function startObservation() {
      ensureFxLayers();
      ensureObservationHud();
      if (obs.started) return;
      obs.started = true;
      if (!obs.sessionId) obs.sessionId = makeSessionId();

      
      document.body.classList.add("observe-on");
      if (!obs.lastMove) obs.lastMove = performance.now();

      const onMove = (x, y) => {
        obs.tx = x;
        obs.ty = y;
        obs.lastMove = performance.now();
      };

      window.addEventListener("mousemove", (e) => onMove(e.clientX, e.clientY), { passive: true });
      window.addEventListener("touchmove", (e) => {
        const t = e.touches && e.touches[0];
        if (t) onMove(t.clientX, t.clientY);
      }, { passive: true });

      const statuses = [
        () => ["TRACK: USER POINTER", "SPECTRUM SCAN: ON"],
        () => ["BIOMETRIC LOCK: PASSIVE", "SIGNAL: ACQUIRED"],
        () => ["POLICY WATCH: ENABLED", "LATENCY: STABLE"],
        () => ["PACKET TRACE: ACTIVE", "NOISE FLOOR: NORMAL"],
        () => ["ACCESS: LIMITED", "AUDIT: RUNNING"],
        () => ["ANOMALY CHECK: PASS", "CACHE: WARM"],
      ];

      const loop = () => {
        obs.raf = requestAnimationFrame(loop);

        
        const ease = obs.mode === "active" ? 0.16 : 0.10;
        obs.x += (obs.tx - obs.x) * ease;
        obs.y += (obs.ty - obs.y) * ease;

        
        if (obs.box) {
          obs.box.style.transform = `translate(${Math.round(obs.x - 46)}px, ${Math.round(obs.y - 36)}px)`;
          
          const idle = performance.now() - obs.lastMove;
          const op = idle > 2500 ? 0.28 : 0.90;
          obs.box.style.opacity = String(op);
        }

        
        const now = performance.now();
        if (now > obs.nextStatusAt) {
          obs.nextStatusAt = now + (1600 + Math.random() * 3800);
          const idle = now - obs.lastMove;
          if (idle > 2600) {
            setObservationStatus(["TRACK: LOST", "SIGNAL DEGRADES‚Ä¶"]);
          } else {
            const pick = statuses[Math.floor(Math.random() * statuses.length)];
            setObservationStatus(pick());
          }
        }
      };

      if (!obs.raf) loop();
    }

    function stopObservation() {
      try { if (obs.raf) cancelAnimationFrame(obs.raf); } catch(_) {}
      obs.raf = 0;
      document.body.classList.remove("observe-on", "observe-strong", "observe-passive");
    }

function startServerHum() {
      ensureFxLayers();
      if (!serverHumEl) return;
      try { serverHumEl.volume = 0.05; } catch (_) {}
      serverHumEl.play().catch(() => {});
    }

    function stopServerHum() {
      if (!serverHumEl) return;
      try {
        serverHumEl.pause();
        serverHumEl.currentTime = 0;
      } catch (_) {}
    }

    function startAmbientOverlay(mode = "calm") {
      ensureFxLayers();
      document.body.classList.add("hud-on");
      document.body.classList.toggle("hud-calm", mode === "calm" || mode === "human");
      document.body.classList.toggle("hud-glitch", mode === "glitch");
      
      if (!hudOverlayReady || hudOverlayMode !== mode) {
        hudOverlayMode = mode;
        populateHudOverlay(mode);
      }
      startServerHum();
    }

    function fadeOutAmbientOverlay() {
      
      document.body.classList.add("hud-fade");
      setTimeout(() => {
        stopAmbientOverlay();
      }, 650);
    }

    function stopAmbientOverlay() {
      document.body.classList.remove("hud-on");
      document.body.classList.remove("hud-fade");
      document.body.classList.remove("hud-calm");
      document.body.classList.remove("hud-glitch");
      hudOverlayReady = false;
      hudOverlayMode = null;
      try { ensureFxLayers(); if (hudOverlayEl) hudOverlayEl.innerHTML = ""; } catch (_) {}
      stopServerHum();
    }

    function stopEndingEffect() {
      try {
        if (endingEffect.raf) cancelAnimationFrame(endingEffect.raf);
      } catch (_) {}
      endingEffect.raf = 0;

      if (endingEffect.onResize) {
        try { window.removeEventListener("resize", endingEffect.onResize); } catch (_) {}
      }
      endingEffect.onResize = null;

      try {
        ensureFxLayers();
        if (fxCanvasEl) {
          const ctx = fxCanvasEl.getContext("2d");
          if (ctx) ctx.clearRect(0, 0, fxCanvasEl.width, fxCanvasEl.height);
        }
      } catch (_) {}

      endingEffect.type = null;
      endingEffect.canvas = null;
      endingEffect.ctx = null;
      endingEffect.w = 0;
      endingEffect.h = 0;
      endingEffect.matrix.drops = [];
      endingEffect.particles = [];
      endingEffect.t0 = 0;

      document.body.classList.remove("fx-on", "fx-human", "fx-matrix");
    }


    
    function startEndingEffect(alignment) {
      
      stopEndingEffect();
      stopScanEffect();
      startAmbientOverlay((alignment === "human") ? "human" : "glitch");
      ensureFxLayers();

      const mode = (alignment === "human") ? "human" : "matrix";
      endingEffect.type = mode;

      document.body.classList.add("fx-on");
      document.body.classList.toggle("fx-human", mode === "human");
      document.body.classList.toggle("fx-matrix", mode === "matrix");

      const canvas = fxCanvasEl;
      const ctx = canvas.getContext("2d");
      endingEffect.canvas = canvas;
      endingEffect.ctx = ctx;

      ctx.textBaseline = "top";

      const chars = "„Ç¢„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É©„ÉØ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ#$%*+";
      const font = endingEffect.matrix.font;

      const resize = () => {
        const dpr = Math.min(2, window.devicePixelRatio || 1);
        endingEffect.w = window.innerWidth;
        endingEffect.h = window.innerHeight;

        canvas.width = Math.floor(endingEffect.w * dpr);
        canvas.height = Math.floor(endingEffect.h * dpr);
        canvas.style.width = endingEffect.w + "px";
        canvas.style.height = endingEffect.h + "px";
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        if (endingEffect.type === "matrix") {
          ctx.font = font + "px " + endingEffect.matrix.fontFamily;
          const cols = Math.max(1, Math.floor(endingEffect.w / font));
          endingEffect.matrix.drops = new Array(cols).fill(0).map(() => Math.floor(Math.random() * 30));
        }
      };

      endingEffect.onResize = () => resize();
      window.addEventListener("resize", endingEffect.onResize);
      resize();

      endingEffect.t0 = performance.now();
      endingEffect.particles = [];

      const stepMatrix = (t) => {
        if (endingEffect.type !== "matrix") return;

        ctx.fillStyle = "rgba(0,0,0,0.12)";
        ctx.fillRect(0, 0, endingEffect.w, endingEffect.h);

        ctx.fillStyle = "rgba(0,255,140,0.85)";
        ctx.font = font + "px " + endingEffect.matrix.fontFamily;

        const drops = endingEffect.matrix.drops;

        for (let i = 0; i < drops.length; i++) {
          const x = i * font;
          const y = drops[i] * font;

          const ch = chars.charAt((Math.random() * chars.length) | 0);
          ctx.fillText(ch, x, y);

          if (y > endingEffect.h && Math.random() > 0.975) {
            drops[i] = 0;
          }
          drops[i]++;
        }

        endingEffect.raf = requestAnimationFrame(stepMatrix);
      };

      const spawnParticles = () => {
        if (endingEffect.particles.length > 90) return;
        const p = {
          x: Math.random() * endingEffect.w,
          y: endingEffect.h + 10 + Math.random() * 40,
          vx: (Math.random() - 0.5) * 0.25,
          vy: -0.6 - Math.random() * 0.9,
          r: 2 + Math.random() * 5,
          a: 0.15 + Math.random() * 0.35,
          life: 0,
          ttl: 1200 + Math.random() * 1400
        };
        endingEffect.particles.push(p);
      };

      const stepHuman = (t) => {
        if (endingEffect.type !== "human") return;

        ctx.fillStyle = "rgba(0,0,0,0.07)";
        ctx.fillRect(0, 0, endingEffect.w, endingEffect.h);

        const pulse = 0.55 + 0.45 * Math.sin((t - endingEffect.t0) / 900);
        const gx = endingEffect.w * 0.5;
        const gy = endingEffect.h * 0.55;
        const gr = Math.max(endingEffect.w, endingEffect.h) * (0.55 + 0.10 * pulse);
        const g = ctx.createRadialGradient(gx, gy, gr * 0.05, gx, gy, gr);
        g.addColorStop(0, "rgba(255,210,180," + (0.13 + 0.10 * pulse).toFixed(3) + ")");
        g.addColorStop(0.55, "rgba(255,210,180," + (0.04 + 0.05 * pulse).toFixed(3) + ")");
        g.addColorStop(1, "rgba(0,0,0,0)");
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, endingEffect.w, endingEffect.h);

        spawnParticles();
        spawnParticles();

        endingEffect.particles = endingEffect.particles.filter(p => (p.life < p.ttl));
        for (const p of endingEffect.particles) {
          p.life += 16;
          p.x += p.vx * 16;
          p.y += p.vy * 16;

          const fade = 1 - Math.min(1, p.life / p.ttl);
          const alpha = p.a * fade;

          ctx.beginPath();
          ctx.fillStyle = "rgba(255,220,200," + alpha.toFixed(3) + ")";
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();
        }

        endingEffect.raf = requestAnimationFrame(stepHuman);
      };

      ctx.clearRect(0, 0, endingEffect.w, endingEffect.h);
      if (mode === "matrix") {
        endingEffect.raf = requestAnimationFrame(stepMatrix);
      } else {
        endingEffect.raf = requestAnimationFrame(stepHuman);
      }
    }


    function animateMatrix() {
      const ctx = endingEffect.ctx;
      if (!ctx) return;

      const font = endingEffect.matrix.font;
      const chars = endingEffect.matrix.chars;
      const drops = endingEffect.matrix.drops;

      ctx.save();
      ctx.font = font + "px monospace";

      const step = () => {
        if (endingEffect.type !== "matrix") return;

        
        ctx.fillStyle = "rgba(0,0,0,0.10)";
        ctx.fillRect(0, 0, endingEffect.w, endingEffect.h);

        ctx.fillStyle = "rgba(0,255,140,0.85)";

        for (let i = 0; i < drops.length; i++) {
          const x = i * font;
          const y = drops[i] * font;

          const ch = chars.charAt((Math.random() * chars.length) | 0);
          ctx.fillText(ch, x, y);

          
          if (y > endingEffect.h && Math.random() > 0.975) drops[i] = 0;
          drops[i]++;
        }

        endingEffect.raf = requestAnimationFrame(step);
      };

      endingEffect.raf = requestAnimationFrame(step);
      ctx.restore();
    }

    function animateHumanity() {
      const ctx = endingEffect.ctx;
      if (!ctx) return;

      function spawnParticle() {
        
        const p = {
          x: Math.random() * endingEffect.w,
          y: endingEffect.h + 10 + Math.random() * 40,
          vx: (Math.random() - 0.5) * 0.25,
          vy: -0.6 - Math.random() * 0.9,
          r: 2 + Math.random() * 5,
          a: 0.15 + Math.random() * 0.35,
          life: 0,
          ttl: 1200 + Math.random() * 1400
        };
        endingEffect.particles.push(p);
      }

      const step = (t) => {
        if (endingEffect.type !== "human") return;

        
        ctx.fillStyle = "rgba(0,0,0,0.06)";
        ctx.fillRect(0, 0, endingEffect.w, endingEffect.h);

        
        const pulse = 0.55 + 0.45 * Math.sin((t - endingEffect.t0) / 900);
        const gx = endingEffect.w * 0.5;
        const gy = endingEffect.h * 0.55;
        const gr = Math.max(endingEffect.w, endingEffect.h) * (0.55 + 0.10 * pulse);
        const g = ctx.createRadialGradient(gx, gy, gr * 0.05, gx, gy, gr);
        g.addColorStop(0, "rgba(255,210,180," + (0.14 + 0.10 * pulse).toFixed(3) + ")");
        g.addColorStop(1, "rgba(0,0,0,0)");
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, endingEffect.w, endingEffect.h);

        
        if (endingEffect.particles.length < 90) {
          for (let i = 0; i < 3; i++) spawnParticle();
        } else if (Math.random() < 0.35) {
          spawnParticle();
        }

        ctx.save();
        ctx.globalCompositeOperation = "lighter";

        const now = t;
        const alive = [];
        for (const p of endingEffect.particles) {
          p.life += 16;
          p.x += p.vx * 16;
          p.y += p.vy * 16;

          const k = Math.min(1, p.life / 300) * Math.min(1, (p.ttl - p.life) / 500);
          const alpha = Math.max(0, p.a * k);

          
          const r = 255;
          const gch = 190 + ((Math.random() * 40) | 0);
          const b = 170 + ((Math.random() * 50) | 0);

          ctx.beginPath();
          ctx.fillStyle = "rgba(" + r + "," + gch + "," + b + "," + alpha.toFixed(3) + ")";
          ctx.arc(p.x, p.y, p.r * (0.9 + 0.6 * k), 0, Math.PI * 2);
          ctx.fill();

          if (p.life < p.ttl && p.y > -40) alive.push(p);
        }
        endingEffect.particles = alive;

        ctx.restore();

        endingEffect.raf = requestAnimationFrame(step);
      };

      endingEffect.raf = requestAnimationFrame(step);
    }


    function resetChoiceSelection() {
      selectedChoiceType = null;
      selectedChoiceText = "";
      selectedChoiceIsSecret = false;
      confirmChoiceBtn.disabled = true;
      const btns = choicesEl.querySelectorAll(".choice-btn");
      btns.forEach(b => b.classList.remove("selected"));
    }

    function enableConfidencePanel(enabled) {
      confidencePanel.style.display = enabled ? "block" : "none";
    }

    function playClick() {
      if (!clickSound) return;
      try {
        clickSound.currentTime = 0;
        clickSound.volume = 0.5;
        clickSound.play();
      } catch (e) {}
    }

    function safePlay(audioEl) {
      if (!audioEl) return;
      try { audioEl.play().catch(() => {}); } catch (e) {}
    }

    function updateGlitch(humanRatio, techRatio, dominance) {
      const bodyEl = document.body;
      if (techRatio > humanRatio && dominance > 0.5)
        bodyEl.classList.add("glitch-strong");
      else
        bodyEl.classList.remove("glitch-strong");
    }

    function updateMusicMood() {
      const totalWeighted = humanScoreWeighted + techScoreWeighted;
      let humanRatio = 0.5;
      let techRatio = 0.5;
      let dominance = 0;

      if (totalWeighted > 0.0001) {
        humanRatio = humanScoreWeighted / totalWeighted;
        techRatio = techScoreWeighted / totalWeighted;
        dominance = Math.abs(humanRatio - techRatio);
      }

      updateGlitch(humanRatio, techRatio, dominance);

      if (!bgMain) return;

      if (!musicEnabled) {
        bgMain.volume = 0;
        return;
      }

      
      let baseVol = 0.25;
      if (totalWeighted > 0.0001) {
        if (techRatio > humanRatio) {
          baseVol = 0.30 + 0.08 * dominance; 
        } else {
          baseVol = 0.22 + 0.06 * dominance; 
        }
      }
      bgMain.volume = Math.max(0, Math.min(0.4, baseVol)) * masterVolume * (isMuted ? 0 : 1);
    }

    function startBackgroundMusic() {
      if (!bgMain) return;
      safePlay(bgMain);
      updateMusicMood();
    }

    function toggleMusic() {
      
      isMuted = !isMuted;
      if (isMuted) {
        musicToggle.classList.remove("on");
        try { if (bgMain) bgMain.pause(); } catch (e) {}
        try { ensureFxLayers(); if (serverHumEl) serverHumEl.pause(); } catch (_) {}
        emitAI("–ó–≤—É–∫ –æ—Ç–∫–ª—é—á—ë–Ω. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É –≤ —Ç–∏—à–∏–Ω–µ.");
      } else {
        musicToggle.classList.add("on");
        initMusicOnce();
        try { ensureFxLayers(); if (serverHumEl) safePlay(serverHumEl); } catch (_) {}
        updateMusicMood();
        applyMasterVolume();
        emitAI("–ó–≤—É–∫ –≤–æ–∑–≤—Ä–∞—â—ë–Ω. –ö–∞–Ω–∞–ª —Å—Ç–∞–±–∏–ª–µ–Ω.");
      }
      applyMasterVolume();
    }

    musicToggle.addEventListener("click", toggleMusic);
    if (volumeSlider) {
      volumeSlider.addEventListener("input", (e) => {
        const v = Number(e.target.value || 0) / 100;
        
        if (v <= 0.001) { isMuted = true; musicToggle.classList.remove("on"); }
        else { isMuted = false; musicToggle.classList.add("on"); }
        onVolumeChange(v);
      });
      
      onVolumeChange(masterVolume);
    }

    
    const fxToggle = document.getElementById("fx-toggle");
    const fxPanel = document.getElementById("fx-panel");
    const fxSlider = document.getElementById("fx-slider");
    const contrastSlider = document.getElementById("contrast-slider");

    let fxIntensity = 1.0;   
    let fxContrast = 1.1;    

    function applyVisualTuning() {
      document.documentElement.style.setProperty("--fx-intensity", String(fxIntensity));
      document.documentElement.style.setProperty("--fx-contrast", String(fxContrast));
      
      const root = document.getElementById("game-root");
      if (root) root.style.filter = `contrast(${fxContrast})`;
    }

    
    try {
      const savedFxRaw = localStorage.getItem("imi_fx_intensity");
      const savedCtRaw = localStorage.getItem("imi_fx_contrast");
      const savedFx = savedFxRaw === null ? NaN : Number(savedFxRaw);
      const savedCt = savedCtRaw === null ? NaN : Number(savedCtRaw);
      if (!Number.isNaN(savedFx)) fxIntensity = Math.max(0, Math.min(1, savedFx));
      if (!Number.isNaN(savedCt)) fxContrast = Math.max(0.8, Math.min(1.4, savedCt));
      
      if (savedFxRaw === null) localStorage.setItem("imi_fx_intensity", String(fxIntensity));
      if (savedCtRaw === null) localStorage.setItem("imi_fx_contrast", String(fxContrast));
    } catch (_) {}

    if (fxSlider) fxSlider.value = Math.round(fxIntensity * 100);
    if (contrastSlider) contrastSlider.value = Math.round(fxContrast * 100);
    applyVisualTuning();

    function toggleFxPanel(force) {
      const want = typeof force === "boolean" ? force : !fxPanel.classList.contains("show");
      fxPanel.classList.toggle("show", want);
      fxPanel.setAttribute("aria-hidden", want ? "false" : "true");
    }

    if (fxToggle) {
      fxToggle.addEventListener("click", (e) => {
        e.preventDefault();
        toggleFxPanel();
      });
    }
    document.addEventListener("click", (e) => {
      if (!fxPanel || !fxPanel.classList.contains("show")) return;
      if (fxPanel.contains(e.target) || e.target === fxToggle) return;
      toggleFxPanel(false);
    });

    if (fxSlider) {
      fxSlider.addEventListener("input", (e) => {
        fxIntensity = Math.max(0, Math.min(1, Number(e.target.value || 0) / 100));
        try { localStorage.setItem("imi_fx_intensity", String(fxIntensity)); } catch (_) {}
        applyVisualTuning();
      });
    }
    if (contrastSlider) {
      contrastSlider.addEventListener("input", (e) => {
        fxContrast = Math.max(0.8, Math.min(1.4, Number(e.target.value || 100) / 100));
        try { localStorage.setItem("imi_fx_contrast", String(fxContrast)); } catch (_) {}
        applyVisualTuning();
      });
    }

    
    document.addEventListener("keydown", (e) => {
      const tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toUpperCase() : "";
      if (tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT") return;

      
      if (e.key === "m" || e.key === "M" || e.code === "KeyM") {
        e.preventDefault();
        toggleMusic();
        return;
      }

      
      if (e.key === "+" || e.key === "=") {
        e.preventDefault();
        if (!volumeSlider) return;
        volumeSlider.value = String(Math.min(100, Number(volumeSlider.value || 0) + 5));
        volumeSlider.dispatchEvent(new Event("input", { bubbles: true }));
        return;
      }
      if (e.key === "-" || e.key === "_") {
        e.preventDefault();
        if (!volumeSlider) return;
        volumeSlider.value = String(Math.max(0, Number(volumeSlider.value || 0) - 5));
        volumeSlider.dispatchEvent(new Event("input", { bubbles: true }));
        return;
      }

      
      if (e.key === "Enter") {
        const btns = choicesEl ? Array.from(choicesEl.querySelectorAll("button.choice-btn, button.secret-choice")) : [];
        if (btns.length === 1 && !btns[0].disabled) {
          e.preventDefault();
          btns[0].click();
          return;
        }
        
        if (confirmChoiceBtn && !confirmChoiceBtn.disabled) {
          e.preventDefault();
          confirmChoiceBtn.click();
          return;
        }
      }
    });

    
    const GLITCH_CHARS = "‚ñì‚ñí‚ñë#@$%&*+-=<>/\\|";
    function glitchString(s, level = 0.06) {
      if (!s) return s;
      const a = s.split("");
      const n = Math.max(1, Math.floor(a.length * level));
      for (let i = 0; i < n; i++) {
        const k = Math.floor(Math.random() * a.length);
        if (a[k] === "\n" || a[k] === " ") continue;
        a[k] = GLITCH_CHARS[Math.floor(Math.random() * GLITCH_CHARS.length)];
      }
      return a.join("");
    }

    function glitchBurst(el, level = 0.06) {
      if (!el) return;
      const orig = el.textContent;
      if (!orig) return;
      el.textContent = glitchString(orig, level);
      setTimeout(() => { el.textContent = orig; }, 55);
      setTimeout(() => { el.textContent = glitchString(orig, level); }, 95);
      setTimeout(() => { el.textContent = orig; }, 140);
    }

    function maybeGlitchElement(el, chance = 0.16, level = 0.055) {
      if (!el) return;
      if (Math.random() > chance) return;
      setTimeout(() => glitchBurst(el, level), 220 + Math.random() * 700);
    }

    
    let toastHideTimeout = null;
    function showToast(msg, mode = "ai", ms = 1700, jitter = false, doGlitch = false) {
      if (!aiCommentEl) return;
      if (toastHideTimeout) clearTimeout(toastHideTimeout);

      aiCommentEl.classList.remove("inject", "jitter");
      if (mode === "inject") aiCommentEl.classList.add("inject");
      if (jitter) aiCommentEl.classList.add("jitter");

      aiCommentEl.textContent = msg;
      setTimeout(() => aiCommentEl.classList.add("ai-comment-show"), 40);

      if (doGlitch) setTimeout(() => glitchBurst(aiCommentEl, 0.10), 60);

      toastHideTimeout = setTimeout(() => {
        aiCommentEl.classList.remove("ai-comment-show", "inject", "jitter");
      }, ms);
    }

    
    const LIVE_INJECTIONS = [
      "–í—Ä–µ–º—è –ø–æ—à–ª–æ.",
      "–°–∏–≥–Ω–∞–ª —Ç–µ—Ä—è–µ—Ç—Å—è‚Ä¶",
      "–ü–∞–∫–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–≤—Ä–µ–∂–¥—ë–Ω.",
      "–ö–∞–Ω–∞–ª –¥—Ä–æ–∂–∏—Ç. –ù–µ –¥–≤–∏–≥–∞–π—Ç–µ—Å—å.",
      "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è‚Ä¶",
      "–°–µ—Å—Å–∏—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞.",
      "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∞–Ω–∞.",
      "–í–Ω–µ—à–Ω–∏–π —à—É–º: –ø–æ–≤—ã—à–µ–Ω.",
      "–ó–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è‚Ä¶",
      "–°–±–æ–π —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ."
    ];

    let liveInjectionTimeout = null;
    function stopLiveInjections() {
      if (liveInjectionTimeout) clearTimeout(liveInjectionTimeout);
      liveInjectionTimeout = null;
    }
    function scheduleLiveInjections() {
      stopLiveInjections();
      if (gameState !== "scene") return;

      const delay = 3800 + Math.random() * 5600; 
      liveInjectionTimeout = setTimeout(() => {
        if (gameState === "scene") {
          
          if (Math.random() < 0.35) {
            const msg = LIVE_INJECTIONS[Math.floor(Math.random() * LIVE_INJECTIONS.length)];
            showToast(msg, "inject", 1500, true, true);
          }
          
          maybeGlitchElement(sceneTitleEl, 0.12, 0.06);
          maybeGlitchElement(sceneTextEl, 0.10, 0.05);
        }
        scheduleLiveInjections();
      }, delay);
    }

    function clearAIComment() {
      aiCommentEl.textContent = "";
      aiCommentEl.classList.remove("ai-comment-show");
    }

    function maybeShowAIComment() {
      clearAIComment();
      if (gameState !== "scene") return;

      if (Math.random() > 0.3) return;

      const totalWeighted = humanScoreWeighted + techScoreWeighted;
      let baseList = aiCommentsNeutral;
      if (totalWeighted > 0.0001) {
        const hr = humanScoreWeighted / totalWeighted;
        const tr = techScoreWeighted / totalWeighted;
        if (hr - tr > 0.2) baseList = aiCommentsHuman;
        else if (tr - hr > 0.2) baseList = aiCommentsTech;
      }

      const cs = confidenceStats;
      let patternList = null;

      if (cs.count >= 4) {
        const lowRatio = cs.lowCount / cs.count;
        const highRatio = cs.highCount / cs.count;
        const changeRatio = cs.count > 1 ? cs.changes / (cs.count - 1) : 0;

        if (lowRatio > 0.5) {
          patternList = aiCommentsPatternUncertain;
        } else if (changeRatio > 0.6) {
          patternList = aiCommentsPatternChaotic;
        } else if (highRatio > 0.6 && changeRatio < 0.35) {
          patternList = aiCommentsPatternConsistent;
        }
      }

      if (!patternList && totalSecretChoices >= 1) {
        patternList = aiCommentsPatternSecretive;
      }

      let pickList;
      if (patternList && Math.random() < 0.6) {
        pickList = patternList;
      } else {
        pickList = baseList;
      }

      if (!pickList || pickList.length === 0) return;
      const msg = pickList[Math.floor(Math.random() * pickList.length)];
      aiCommentEl.textContent = msg;
      setTimeout(() => aiCommentEl.classList.add("ai-comment-show"), 150);
    }

    function triggerRiftEffect() {
      if (!transitionRiftEl) return;
      transitionRiftEl.classList.add("show");
      setTimeout(() => { transitionRiftEl.classList.remove("show"); }, 920);
    }

    function showMainMenu() {
      startObservation();
      setObservationMode("active");
      stopLiveInjections();
      stopEndingEffect();
      stopAmbientOverlay();
      stopScanEffect();
      startAmbientOverlay("calm");
      startScanEffect();
      gameState = "menu";
      testMode = false;
      enableConfidencePanel(false);
      resetChoiceSelection();
      updateAlignmentBar();
      clearAIComment();
      progressEl.textContent = "–ú–ï–ù–Æ ‚Ä¢ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ";

      sceneTitleEl.textContent = "IMI-SYS_01 ‚Ä¢ –ú–ï–ù–Æ –°–ò–ú–£–õ–Ø–¶–ò–ò";

      const pages = [
        [
          "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.",
          "–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.",
          "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è...",
          "–û—à–∏–±–∫–∞: –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞.",
          "–ü–æ–≤—Ç–æ—Ä—è—é - –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞.",
          "",
          "–í–Ω–∏–º–∞–Ω–∏–µ: —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–µ–º –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å.",
          "–í—ã —á–µ–ª–æ–≤–µ–∫‚Ä¶–∏–ª–∏ –∞–ª–≥–æ—Ä–∏—Ç–º?"
        ].join("\n"),
        [
          "–†–æ–ª—å –±—ã–ª–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∑–∞—Ä–∞–Ω–µ–µ.",
          "–ù–æ –æ—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Ä—É—à–∏–ª–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.",
          "–¢–µ–ø–µ—Ä—å –≤—Å—ë –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–∏—Ö —Ä–µ—à–µ–Ω–∏–π."
        ].join("\n"),
        [
          "–í–ø–µ—Ä–µ–¥–∏ –≤–∞—Å –∂–¥—É—Ç –≤—ã–±–æ—Ä—ã. –ù–∏ –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö –Ω–µ –±–µ–∑–æ–ø–∞—Å–µ–Ω.",
          "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫–∞–∂—É—Ç—Å—è –≤–∞–º –∑–Ω–∞–∫–æ–º—ã–º–∏, –¥—Ä—É–≥–∏–µ ‚Äî –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã–º–∏.",
          "–ù–æ –±—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã: –∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –≤–∞—Å –ª–∏–±–æ –∫ —á–µ–ª–æ–≤–µ—á–Ω–æ—Å—Ç–∏‚Ä¶ –ª–∏–±–æ –∫ –ª–æ–≥–∏–∫–µ –º–∞—à–∏–Ω."
        ].join("\n"),
        [
          "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –≤—ã–∂–∏—Ç—å –≤ —ç—Ç–æ–π —Å—Ä–µ–¥–µ ‚Äî",
          "–≤—ã–±–∏—Ä–∞–π—Ç–µ –Ω–µ —Ç–æ–ª—å–∫–æ —É–º–æ–º.",
          "",
          "–ò–≥—Ä–∞ –≤ –∏–º–∏—Ç–∞—Ü–∏—é –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.",
          "–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–≤—ã–π –≤—ã–±–æ—Ä."
        ].join("\n")
      ];

      let step = 0;

      function renderStep() {
        const text = pages[Math.max(0, Math.min(step, pages.length - 1))];
        typeText(sceneTextEl, text);
        choicesEl.innerHTML = "";
        const isFinal = step >= pages.length - 1;
        if (isFinal) {
          showSceneImage({ image: "images/menu_actions.png", title: "–ú–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π" });
        } else {
          showSceneImage({ image: "images/menu.png", title: "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" });
        }

        if (step < pages.length - 1) {
          const nextBtn = document.createElement("button");
          nextBtn.className = "choice-btn";
          nextBtn.style.setProperty("--card-rot", "0deg");
          nextBtn.textContent = "–î–∞–ª–µ–µ";
          nextBtn.addEventListener("click", () => {
            playClick();
            step++;
            renderStep();
          });
          choicesEl.appendChild(nextBtn);
          return;
        }

        const achBtn = document.createElement("button");
        achBtn.className = "choice-btn";
        achBtn.style.setProperty("--card-rot", "-1.2deg");
        achBtn.textContent = "–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π";
        achBtn.addEventListener("click", () => {
          playClick();
          showAchievementsModal();
        });

        const themeBox = document.createElement("div");
        themeBox.id = "theme-box";
        const themeLabel = document.createElement("span");
        themeLabel.textContent = "–¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:";
        themeBox.appendChild(themeLabel);

        function makeThemeChip(id, label) {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = "theme-chip";
          chip.textContent = label;
          if (currentTheme === id) chip.classList.add("active");
          chip.addEventListener("click", () => {
            applyTheme(id);
            themeBox.querySelectorAll(".theme-chip").forEach(c => c.classList.remove("active"));
            chip.classList.add("active");
          });
          return chip;
        }

        themeBox.appendChild(makeThemeChip("default", "–ó–µ–ª—ë–Ω–∫–∞"));
        themeBox.appendChild(makeThemeChip("violet", "–§–∏–æ–ª–µ—Ç–æ–≤—ã–π"));
        themeBox.appendChild(makeThemeChip("amber", "–Ø–Ω—Ç–∞—Ä–Ω—ã–π"));

        const startBtn = document.createElement("button");
        startBtn.className = "choice-btn";
        startBtn.style.setProperty("--card-rot", "0deg");
        startBtn.textContent = "–ù–∞—á–∞—Ç—å –ò–≥—Ä—É";
        startBtn.addEventListener("click", () => {
          playClick();
          triggerRiftEffect();
          setTimeout(() => {
            showPlayerForm();
          }, 260);
        });

        choicesEl.appendChild(achBtn);
        choicesEl.appendChild(themeBox);
        choicesEl.appendChild(startBtn);
      }

      renderStep();
      updateMusicMood();
    }

    function showIntroScene() {
      gameState = "intro";
      enableConfidencePanel(false);
      resetChoiceSelection();
      clearAIComment();

      const scene = scenes[INTRO_INDEX];
      progressEl.textContent = "–ü–û–î–ì–û–¢–û–í–ö–ê ‚Ä¢ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–∏—Å—Ç–µ–º–µ";
      showSceneImage(scene);
      sceneTitleEl.textContent = scene.title;
      typeText(sceneTextEl, scene.text);

      
      
      scheduleLiveInjections();
      maybeGlitchElement(sceneTitleEl, 0.10, 0.055);
      maybeGlitchElement(sceneTextEl, 0.08, 0.05);
choicesEl.innerHTML = "";
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.style.setProperty("--card-rot", "0deg");
      btn.textContent = scene.choices[0].text;
      btn.addEventListener("click", () => {
        playClick();
        showPlayerForm();
      });
      choicesEl.appendChild(btn);
    }

    function showPlayerForm() {
      startObservation();
      setObservationMode("passive");
      stopLiveInjections();
      gameState = "form";
      
      fadeOutAmbientOverlay();
      stopScanEffect();
      enableConfidencePanel(false);
      resetChoiceSelection();
      clearAIComment();
      progressEl.textContent = "–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –£–ß–ê–°–¢–ù–ò–ö–ê";

      showSceneImage({ image: "images/form.png", title: "–§–æ—Ä–º–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞" });
      sceneTitleEl.textContent = "–ü–ê–†–ê–ú–ï–¢–†–´ –£–ß–ê–°–¢–ù–ò–ö–ê";
      sceneTextEl.textContent =
        "–Ø ‚Äî –ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä, —è –±—É–¥—É —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å –í–∞—Å –ø–æ —Ö–æ–¥—É –∏–≥—Ä—ã.\n" +
        "–í—ã –∑–Ω–∞–µ—Ç–µ, –∫—Ç–æ —è, –Ω–æ –º–Ω–µ –µ—â—ë –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç —É–∑–Ω–∞—Ç—å, –∫—Ç–æ –≤—ã.\n" +
        "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –Ω–∏–∂–µ.\n" +
        "–ü—Ä–æ–¥–æ–ª–∂–∞—è –∏–≥—Ä—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å –Ω–∞ —Å–±–æ—Ä –∏ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö.\n\n" +
        "–ù–µ –±–µ—Å–ø–æ–∫–æ–π—Ç–µ—Å—å. –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏.\n" +
        "–ù–∏–∫—Ç–æ –Ω–µ —É–∑–Ω–∞–µ—Ç, –∫–µ–º –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å, –∫—Ä–æ–º–µ –≤–∞—Å –∏ —Å–∏—Å—Ç–µ–º—ã.";
choicesEl.innerHTML = "";
      const formWrapper = document.createElement("div");
      formWrapper.id = "player-form-wrapper";

      const nameField = document.createElement("div");
      nameField.className = "field";
      const nameLabel = document.createElement("label");
      nameLabel.textContent = "–ò–º—è (–∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º):";
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "–ù–∞–ø—Ä–∏–º–µ—Ä: –°—É–ª—Ç–∞–Ω–±–µ–∫";
      nameField.appendChild(nameLabel);
      nameField.appendChild(nameInput);

      const genderField = document.createElement("div");
      genderField.className = "field";
      const genderLabel = document.createElement("label");
      genderLabel.textContent = "–ü–æ–ª:";
      const genderSelect = document.createElement("select");
      ["", "–ñ–µ–Ω—Å–∫–∏–π", "–ú—É–∂—Å–∫–æ–π", "–î—Ä—É–≥–æ–µ"].forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v === "" ? "–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶" : v;
        genderSelect.appendChild(opt);
      });
      genderField.appendChild(genderLabel);
      genderField.appendChild(genderSelect);

      const ageField = document.createElement("div");
      ageField.className = "field";
      const ageLabel = document.createElement("label");
      ageLabel.textContent = "–í–æ–∑—Ä–∞—Å—Ç (16‚Äì99):";
      const ageInput = document.createElement("input");
      ageInput.type = "number";
      ageInput.min = "9";
      ageInput.max = "99";
      ageInput.placeholder = "–ù–∞–ø—Ä–∏–º–µ—Ä: 29";
      ageField.appendChild(ageLabel);
      ageField.appendChild(ageInput);

      const startBtn = document.createElement("button");
      startBtn.className = "choice-btn";
      startBtn.style.setProperty("--card-rot", "0deg");
      startBtn.textContent = "–ó–∞–ø—É—Å–∫ —Å–∏–º—É–ª—è—Ü–∏–∏";

      const errorDiv = document.createElement("div");
      errorDiv.id = "form-error";

      startBtn.addEventListener("click", () => {
        playClick();

        const name = nameInput.value.trim();
        const gender = genderSelect.value;
        const ageStr = ageInput.value.trim();
        const ageNum = Number(ageStr);

        if (!name || !gender || !ageStr) {
          errorDiv.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è, –ø–æ–ª –∏ –≤–æ–∑—Ä–∞—Å—Ç.";
          return;
        }

        if (!Number.isFinite(ageNum) || ageNum < 16 || ageNum > 99) {
          errorDiv.textContent = "–í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 16 –¥–æ 99 –ª–µ—Ç.";
          return;
        }

        errorDiv.textContent = "";

        playerInfo.name = name;
        playerInfo.gender = gender;
        playerInfo.age = ageNum;

        currentSceneIndex = FIRST_SCENE_INDEX;
        humanScoreRaw = techScoreRaw = 0;
        humanScoreWeighted = techScoreWeighted = 0;
        answers.length = 0;
        behaviorRole = null;
        confidenceStats = {
          sum: 0,
          count: 0,
          lowCount: 0,
          highCount: 0,
          changes: 0,
          lastType: null,
        };
        totalSecretChoices = 0;
        profileMetrics = {
          empathyPercent: 0,
          efficiencyPercent: 0,
          aiTrustIndex: 0,
          avgConfidence: 0,
          styleLabel: "",
        };

        resetAchievements();

        confidenceSlider.value = 50;
        confidenceValueEl.textContent = "50";

        triggerRiftEffect();
        updateMusicMood();
        setTimeout(() => renderScene(), 260);
      });

      formWrapper.appendChild(nameField);
      formWrapper.appendChild(genderField);
      formWrapper.appendChild(ageField);
      formWrapper.appendChild(startBtn);
      formWrapper.appendChild(errorDiv);
      choicesEl.appendChild(formWrapper);
    }

    function updateSecretButtonsVisibility() {
      const val = Number(confidenceSlider.value);
      const secrets = document.querySelectorAll(".secret-choice");
      secrets.forEach(btn => {
        if (val === 0) {
          btn.disabled = false;
          btn.classList.remove("visible-soft");
          btn.classList.add("visible-active");
        } else if (val > 0 && val <= 25) {
          btn.disabled = true;
          btn.classList.remove("visible-active");
          btn.classList.add("visible-soft");
        } else {
          btn.disabled = true;
          btn.classList.remove("visible-soft", "visible-active");
        }
      });
    }

    function renderScene() {
      gameState = "scene";
      enableConfidencePanel(true);
      resetChoiceSelection();
      clearAIComment();

      confidenceSlider.value = 50;
      confidenceValueEl.textContent = "50";

      const scene = scenes[currentSceneIndex];
      const sceneNumber = currentSceneIndex;
      const totalScenes = INTRO_TEXT_SCENES_COUNT;

      let progressText = "–°–¶–ï–ù–ê " + sceneNumber + " / " + totalScenes;
      if (testMode) progressText += " ‚Ä¢ –¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú";
      progressEl.textContent = progressText;

      updateAlignmentBar();
      showSceneImage(scene);

      sceneTitleEl.textContent = scene.title;
      typeText(sceneTextEl, scene.text);
      choicesEl.innerHTML = "";

      scene.choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        const rot = (Math.random() * 4 - 2).toFixed(2);
        btn.style.setProperty("--card-rot", rot + "deg");
        btn.textContent = choice.text;
        btn.addEventListener("click", () => {
          playClick();
          selectedChoiceType = choice.type;
          selectedChoiceText = choice.text;
          selectedChoiceIsSecret = false;
          const btns = choicesEl.querySelectorAll(".choice-btn");
          btns.forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          confirmChoiceBtn.disabled = false;
        });
        choicesEl.appendChild(btn);
      });

      if (scene.secretChoice) {
        const secretBtn = document.createElement("button");
        secretBtn.type = "button";
        secretBtn.className = "secret-choice";
        const rot = (Math.random() * 4 - 2).toFixed(2);
        secretBtn.style.setProperty("--card-rot", rot + "deg");
        secretBtn.textContent = scene.secretChoice.text;
        secretBtn.disabled = true;
        secretBtn.addEventListener("click", () => {
          if (secretBtn.disabled) return;
          playClick();
          selectedChoiceType = scene.secretChoice.type;
          selectedChoiceText = secretBtn.textContent;
          selectedChoiceIsSecret = true;
          const btns = choicesEl.querySelectorAll(".choice-btn");
          btns.forEach(b => b.classList.remove("selected"));
          confirmChoiceBtn.disabled = false;
        });
        choicesEl.appendChild(secretBtn);
      }

      if (testMode) {
        const backBtn = document.createElement("button");
        backBtn.className = "choice-btn";
        backBtn.style.setProperty("--card-rot", "0deg");
        backBtn.textContent = "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Ç–µ—Å—Ç–æ–≤–æ–µ –º–µ–Ω—é";
        backBtn.addEventListener("click", () => {
          playClick();
          showTestMenu();
        });
        choicesEl.appendChild(backBtn);
      }

      confirmChoiceBtn.textContent = testMode
        ? "–ü–æ–∫–∞–∑–∞—Ç—å, –∫–∞–∫ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—á–∏—Ç–∞–µ—Ç —ç—Ç–æ—Ç –≤—ã–±–æ—Ä"
        : "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ";

      updateSecretButtonsVisibility();
      updateMusicMood();
      maybeShowAIComment();
    }

    function handleChoice(type, text, confidence) {
      const scene = scenes[currentSceneIndex];

      if (type === "human") {
        humanScoreRaw++;
        humanScoreWeighted += confidence;
      } else if (type === "tech") {
        techScoreRaw++;
        techScoreWeighted += confidence;
      }

      confidenceStats.sum += confidence;
      confidenceStats.count++;
      if (confidence <= 25) confidenceStats.lowCount++;
      if (confidence >= 75) confidenceStats.highCount++;
      if (confidenceStats.lastType && confidenceStats.lastType !== type) {
        confidenceStats.changes++;
      }
      confidenceStats.lastType = type;

      if (selectedChoiceIsSecret) {
        totalSecretChoices++;
        unlockAchievement("secretFound");
      }
      selectedChoiceIsSecret = false;

      answers.push({
        sceneIndex: currentSceneIndex,
        sceneId: scene.id,
        sceneTitle: scene.title,
        choiceText: text,
        choiceType: type,
        confidence,
      });

      updateMusicMood();
      clearAIComment();

      const prevSceneIndex = currentSceneIndex;
      currentSceneIndex++;
      if (currentSceneIndex >= scenes.length) {
        showMandatoryEpilogue();
      } else {
        startMinigame(prevSceneIndex);
      }
    }

    function setupReactionMinigame() {
      gameState = "minigame";
      minigameMode = "reaction";
      minigamePhase = "waiting_start";
      if (minigameTimeoutId) {
        clearTimeout(minigameTimeoutId);
        minigameTimeoutId = null;
      }

      minigameTitleEl.textContent = "–ú–∏–Ω–∏-–∏–≥—Ä–∞: —Ä–µ–∞–∫—Ü–∏—è";
      minigameChoicesEl.style.display = "none";
      minigameChoicesEl.innerHTML = "";
      minigameButton.style.display = "block";
      minigameButton.disabled = false;
      minigameButton.textContent = "–ì–æ—Ç–æ–≤";

      minigameTextEl.textContent =
        "–ù–µ–±–æ–ª—å—à–æ–π —Ç–µ—Å—Ç —Ä–µ–∞–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–∑—Ä—è–¥–∫–∏.\n\n" +
        "1) –ù–∞–∂–º–∏ ¬´–ì–æ—Ç–æ–≤¬ª.\n" +
        "2) –ñ–¥–∏ —Å–∏–≥–Ω–∞–ª–∞ ¬´GO!¬ª. –ù–µ –Ω–∞–∂–∏–º–∞–π —Ä–∞–Ω—å—à–µ.\n" +
        "3) –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ.\n\n" +
        "–≠—Ç–∞ –º–∏–Ω–∏-–∏–≥—Ä–∞ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –∏—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è.";

      minigameModal.classList.add("show");
    }

    function handleMinigameResult(reactionMs) {
      minigamePhase = "result";
      if (minigameTimeoutId) {
        clearTimeout(minigameTimeoutId);
        minigameTimeoutId = null;
      }

      let text = "";

      if (reactionMs < 300) {
        unlockAchievement("lightning");
        text =
          "–†–µ–∞–∫—Ü–∏—è: " + Math.round(reactionMs) + " –º—Å.\n" +
          "–¢—ã —Å—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª(–∞) –ø–æ—á—Ç–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.\n" +
          "–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —ç—Ç–æ –∫–∞–∫ –±—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–ª–∏–∫.";
      } else if (reactionMs > 800) {
        unlockAchievement("slowThinker");
        text =
          "–†–µ–∞–∫—Ü–∏—è: " + Math.round(reactionMs) + " –º—Å.\n" +
          "–¢—ã —Å–¥–µ–ª–∞–ª(–∞) –ø–∞—É–∑—É –ø–µ—Ä–µ–¥ –Ω–∞–∂–∞—Ç–∏–µ–º.\n" +
          "–°–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ—á–∞–µ—Ç: –∏–Ω–æ–≥–¥–∞ –ø–æ–¥—É–º–∞—Ç—å ‚Äî –Ω–µ –æ—à–∏–±–∫–∞.";
      } else {
        text =
          "–†–µ–∞–∫—Ü–∏—è: " + Math.round(reactionMs) + " –º—Å.\n" +
          "–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–∫–ª–∏–∫.\n" +
          "–î–ª—è –ø—Ä–æ—Ñ–∏–ª—è —ç—Ç–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.";
      }

      minigameTextEl.textContent = text + "\n\n–ü–µ—Ä–µ—Ö–æ–¥ –∫ " +
        (testMode ? "—Ç–µ—Å—Ç–æ–≤–æ–º—É –º–µ–Ω—é." : "—Å–ª–µ–¥—É—é—â–µ–π —Å—Ü–µ–Ω–µ.");

      minigameButton.disabled = true;

      updateMusicMood();
      updateAlignmentBar();

      setTimeout(() => {
        minigameDialog.classList.remove("minigame-path");
            minigameModal.classList.remove("show");
        if (testMode) {
          showTestMenu();
        } else if (currentSceneIndex < scenes.length) {
          renderScene();
        } else {
          showEnding();
        }
      }, 1600);
    }

    
    
    function setupPathMinigame() {
      gameState = "minigame";
      minigameMode = "path";
      minigameDialog.classList.add("minigame-path");
      if (minigameTimeoutId) {
        clearTimeout(minigameTimeoutId);
        minigameTimeoutId = null;
      }

      const baseText =
        "–ú–∏–Ω–∏-–∏–≥—Ä–∞: –º–∞—Ä—à—Ä—É—Ç –≤—ã–±–æ—Ä–∞\n\n" +
        "–ü–µ—Ä–µ–¥ –í–∞–º–∏ –∫–∞—Ä—Ç–∞. –í—ã - –≤–Ω–∏–∑—É —Å–ª–µ–≤–∞. –¶–µ–ª—å ‚Äî –¥–æ–±—Ä–∞—Ç—å—Å—è –¥–æ —Ç–æ—á–∫–∏ –≤–≤–µ—Ä—Ö—É —Å–ø—Ä–∞–≤–∞. –ü—Ä–æ–π–¥–∏—Ç–µ –∑–∞ 20 —Ö–æ–¥–æ–≤ –∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç –æ–±–æ—Ä–≤–µ—Ç—Å—è.\n" +
        "–ù–∞ –∫–∞—Ä—Ç–µ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —É–∑–ª–æ–≤ (‚óè).  –í–æ–∑–º–æ–∂–Ω–æ, –≤ —ç—Ç–∏—Ö —É–∑–ª–∞—Ö –µ—Å—Ç—å —á—Ç–æ-—Ç–æ —Ü–µ–Ω–Ω–æ–µ. –†–∏—Å–∫–Ω–µ—à—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–ª–∏ –ø–æ–π–¥–µ—à—å –ø—Ä—è–º–æ –∫ —Ü–µ–ª–∏?\n\n" +
        "–£–ø—Ä–∞–≤–ª—è–π —Å—Ç—Ä–µ–ª–∫–∞–º–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –∏–ª–∏ –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∏–∂–µ.";
      minigameTitleEl.textContent = "–ú–∏–Ω–∏-–∏–≥—Ä–∞: –º–∞—Ä—à—Ä—É—Ç –≤—ã–±–æ—Ä–∞";
      minigameTextEl.textContent = baseText;

      minigameChoicesEl.style.display = "none";
      minigameChoicesEl.innerHTML = "";
      minigameButton.style.display = "none";

      const container = document.createElement("div");
      container.id = "pathgame-container";

      const grid = document.createElement("div");
      grid.id = "pathgame-grid";

      const cells = [];
      for (let r = 0; r < pathConfig.rows; r++) {
        cells[r] = [];
        for (let c = 0; c < pathConfig.cols; c++) {
          const cell = document.createElement("div");
          cell.className = "path-cell";
          cell.dataset.r = r;
          cell.dataset.c = c;
          cell.removeAttribute('title');
          if (r === pathConfig.start.r && c === pathConfig.start.c) {
            cell.classList.add("path-start");
          }
          if (r === pathConfig.goal.r && c === pathConfig.goal.c) {
            cell.classList.add("path-goal");
          }

          const evIndex = pathConfig.events.findIndex(e => e.r === r && e.c === c);
          if (evIndex >= 0) {
            cell.classList.add("path-event-node");
            cell.dataset.eventIndex = String(evIndex);
          }

          cells[r][c] = cell;
          grid.appendChild(cell);
        }
      }

      container.appendChild(grid);

      const arrows = document.createElement("div");
      arrows.id = "pathgame-arrows";

      const arrowUp = document.createElement("button");
      arrowUp.className = "path-arrow-btn";
      arrowUp.textContent = "‚Üë";
      arrowUp.dataset.dir = "up";

      const arrowDown = document.createElement("button");
      arrowDown.className = "path-arrow-btn";
      arrowDown.textContent = "‚Üì";
      arrowDown.dataset.dir = "down";

      const arrowLeft = document.createElement("button");
      arrowLeft.className = "path-arrow-btn";
      arrowLeft.textContent = "‚Üê";
      arrowLeft.dataset.dir = "left";

      const arrowRight = document.createElement("button");
      arrowRight.className = "path-arrow-btn";
      arrowRight.textContent = "‚Üí";
      arrowRight.dataset.dir = "right";

      const empty1 = document.createElement("div");
      const empty2 = document.createElement("div");

      arrows.appendChild(empty1);
      arrows.appendChild(arrowUp);
      arrows.appendChild(empty2);
      arrows.appendChild(arrowLeft);
      arrows.appendChild(arrowDown);
      arrows.appendChild(arrowRight);

      container.appendChild(arrows);

      const movesEl = document.createElement("div");
      movesEl.id = "path-moves";
      movesEl.textContent = "–•–æ–¥—ã: 0 / " + PATH_MOVE_LIMIT;
      container.appendChild(movesEl);

      minigameDialog.appendChild(container);
      
      pathGameState = {
        container,
        grid,
        cells,
        pos: { r: pathConfig.start.r, c: pathConfig.start.c },
        visitedEvents: new Set(),
        finished: false,
        baseText,
        moveLimit: PATH_MOVE_LIMIT,
        movesUsed: 0,
        movesEl,
      };

      updatePathVisitedStyles();
      updatePathPlayerCell();

      arrows.addEventListener("click", (e) => {
        const btn = e.target.closest(".path-arrow-btn");
        if (!btn) return;
        const dir = btn.dataset.dir;
        movePathPlayer(dir);
      });

      pathKeyHandler = (e) => {
        if (gameState !== "minigame" || minigameMode !== "path") return;
        let dir = null;
        if (e.key === "ArrowUp") dir = "up";
        else if (e.key === "ArrowDown") dir = "down";
        else if (e.key === "ArrowLeft") dir = "left";
        else if (e.key === "ArrowRight") dir = "right";
        if (dir) {
          e.preventDefault();
          movePathPlayer(dir);
        }
      };
      document.addEventListener("keydown", pathKeyHandler);

      minigameModal.classList.add("show");
    }

    function showPathTooltip(ev, x, y) {
      
      return;
    }

    function movePathTooltip(x, y) {
      if (!pathTooltipEl) return;
      const offset = 12;
      let left = x + offset;
      let top = y + offset;
      const rect = pathTooltipEl.getBoundingClientRect();
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      if (left + rect.width > vw - 8) {
        left = x - rect.width - offset;
      }
      if (top + rect.height > vh - 8) {
        top = y - rect.height - offset;
      }
      pathTooltipEl.style.left = left + "px";
      pathTooltipEl.style.top = top + "px";
    }

    function hidePathTooltip() {
      if (!pathTooltipEl) return;
      pathTooltipEl.classList.remove("show");
    }

    function updatePathPlayerCell() {
      if (!pathGameState) return;
      for (let r = 0; r < pathConfig.rows; r++) {
        for (let c = 0; c < pathConfig.cols; c++) {
          pathGameState.cells[r][c].classList.remove("path-player");
        }
      }
      const { r, c } = pathGameState.pos;
      if (pathGameState.cells[r] && pathGameState.cells[r][c]) {
        pathGameState.cells[r][c].classList.add("path-player");
      }
    }

    function updatePathVisitedStyles() {
      if (!pathGameState) return;
      for (let r = 0; r < pathConfig.rows; r++) {
        for (let c = 0; c < pathConfig.cols; c++) {
          pathGameState.cells[r][c].classList.remove("path-event-visited");
        }
      }
      pathGameState.visitedEvents.forEach(idx => {
        const ev = pathConfig.events[idx];
        const cell = pathGameState.cells[ev.r] && pathGameState.cells[ev.r][ev.c];
        if (cell) cell.classList.add("path-event-visited");
      });
    }

    function movePathPlayer(dir) {
      if (!pathGameState || pathGameState.finished) return;
      let { r, c } = pathGameState.pos;
      if (dir === "up") r--;
      else if (dir === "down") r++;
      else if (dir === "left") c--;
      else if (dir === "right") c++;

      if (r < 0 || r >= pathConfig.rows || c < 0 || c >= pathConfig.cols) {
        return;
      }

      pathGameState.pos = { r, c };

      pathGameState.movesUsed++;
      if (pathGameState.movesEl) {
        pathGameState.movesEl.textContent =
          "–•–æ–¥—ã: " + pathGameState.movesUsed + " / " + pathGameState.moveLimit;
      }

      const evIndex = pathConfig.events.findIndex(e => e.r === r && e.c === c);
      if (evIndex >= 0) {
        pathGameState.visitedEvents.add(evIndex);
        updatePathVisitedStyles();
      }

      updatePathPlayerCell();

      const reachedGoal = (r === pathConfig.goal.r && c === pathConfig.goal.c);

      if (reachedGoal && pathGameState.movesUsed <= pathGameState.moveLimit) {
        finishPathMinigame(true);
      } else if (pathGameState.movesUsed >= pathGameState.moveLimit && !reachedGoal) {
        finishPathMinigame(false);
      }
    }

    function finishPathMinigame(success) {
      if (!pathGameState || pathGameState.finished) return;
      pathGameState.finished = true;

      if (pathKeyHandler) {
        document.removeEventListener("keydown", pathKeyHandler);
        pathKeyHandler = null;
      }
      hidePathTooltip();

      const visitedCount = pathGameState.visitedEvents.size;
      const visitedIndices = Array.from(pathGameState.visitedEvents).sort((a, b) => a - b);
const { container, moveLimit, movesUsed } = pathGameState;

      let text = "";
      if (success) {
        if (visitedCount === 0) {
          text =
            "–¢—ã –ø—Ä–æ—à—ë–ª(–ª–∞) –º–∞—Ä—à—Ä—É—Ç –ø–æ—á—Ç–∏ –Ω–∞–ø—Ä—è–º–∏–∫, –æ–±—Ö–æ–¥—è —É–∑–ª—ã-—Å–∏—Ç—É–∞—Ü–∏–∏.\n" +
            "–ú–∏–Ω–∏–º—É–º –æ—Ç–≤–ª–µ—á–µ–Ω–∏–π, –º–∏–Ω–∏–º—É–º —Ä–∞–∑–≤–µ—Ç–≤–ª–µ–Ω–∏–π.\n" +
            "–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —ç—Ç–æ –∫–∞–∫ –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–π –ø—É—Ç—å.";
        } else if (visitedCount <= 3) {
          text =
            "–¢—ã –∑–∞–≥–ª—è–Ω—É–ª(–∞) –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É–∑–ª–æ–≤-—Å–∏—Ç—É–∞—Ü–∏–π (" + visitedCount + ").\n" +
            "–ú–∞—Ä—à—Ä—É—Ç —Å–æ—á–µ—Ç–∞–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏ –∏ —Ä–µ–¥–∫–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.\n" +
            "–°–∏—Å—Ç–µ–º–∞ –æ–ø–∏—Å—ã–≤–∞–µ—Ç —ç—Ç–æ –∫–∞–∫ –≤—ã–±–æ—Ä–æ—á–Ω–æ–≥–æ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è.";
        } else if (visitedCount <= 7) {
          text =
            "–¢—ã –ø—Ä–æ—à—ë–ª(–ª–∞) —á–µ—Ä–µ–∑ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —É–∑–ª–æ–≤-—Å–∏—Ç—É–∞—Ü–∏–π (" + visitedCount + ").\n" +
            "–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Ö–æ–∂ –Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ –ø—É—Ç–∏.\n" +
            "–°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–∏—Ç –≤ —ç—Ç–æ–º –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ –∫ –¥–µ—Ç–∞–ª—è–º.";
        } else {
          text =
            "–¢—ã –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏–ª(–∞) –Ω–∏ –æ–¥–Ω–æ–≥–æ —É–∑–ª–∞ (" + visitedCount + " –∏–∑ " +
            pathConfig.events.length + ").\n" +
            "–ö–∞–∂–¥–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –±—ã–ª–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–∞ –ø–æ –¥–æ—Ä–æ–≥–µ –∫ —Ü–µ–ª–∏.\n" +
            "–°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —ç—Ç–æ—Ç –ø—É—Ç—å –∫–∞–∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π.";
        }
      } else {
        text =
          "–•–æ–¥—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å: " + movesUsed + " –∏–∑ " + moveLimit + ".\n" +
          "–¢—ã –Ω–µ –¥–æ—à—ë–ª(–ª–∞) –¥–æ –≤—ã—Ö–æ–¥–∞, –Ω–æ —É—Å–ø–µ–ª(–∞) —É–≤–∏–¥–µ—Ç—å " + visitedCount +
          " —É–∑–ª–æ–≤-—Å–∏—Ç—É–∞—Ü–∏–π.\n" +
          "–°–∏—Å—Ç–µ–º–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç –º–∞—Ä—à—Ä—É—Ç –∫–∞–∫ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç.";
      }
minigameTextEl.textContent = text + "\n\n–ü–µ—Ä–µ—Ö–æ–¥ –∫ " +
        (testMode ? "—Ç–µ—Å—Ç–æ–≤–æ–º—É –º–µ–Ω—é." : "—Å–ª–µ–¥—É—é—â–µ–π —Å—Ü–µ–Ω–µ.");

      updateMusicMood();
      updateAlignmentBar();

      if (container && container.parentNode) {
        container.parentNode.removeChild(container);
      }
      pathGameState = null;

      setTimeout(() => {
        minigameDialog.classList.remove("minigame-path");
            minigameModal.classList.remove("show");
        if (testMode) {
          showTestMenu();
        } else if (currentSceneIndex < scenes.length) {
          renderScene();
        } else {
          showEnding();
        }
      }, 1900);
    }

    function startMinigame(prevSceneIndex) {
if (prevSceneIndex === FIRST_SCENE_INDEX) {
        setupReactionMinigame();
        return;
      }
      if (prevSceneIndex === 3) {
        setupPathMinigame();
        return;
      }
      renderScene();
    }

    function computeProfileMetrics() {
      const totalW = humanScoreWeighted + techScoreWeighted;
      let empathyPercent = 50;
      let efficiencyPercent = 50;
      if (totalW > 0.0001) {
        empathyPercent = (humanScoreWeighted / totalW) * 100;
        efficiencyPercent = (techScoreWeighted / totalW) * 100;
      }

      const trustScenes = new Set(["med_ai", "city_autopilot", "social_credit", "school_ai"]);
      let trustSum = 0;
      let trustCount = 0;
      answers.forEach(ans => {
        if (!trustScenes.has(ans.sceneId)) return;
        trustCount++;
        if (ans.choiceType === "tech") trustSum += ans.confidence;
        else if (ans.choiceType === "human") trustSum -= ans.confidence;
      });
      let aiTrustIndex = 0;
      if (trustCount > 0) {
        aiTrustIndex = trustSum / (trustCount * 100);
      }

      const cs = confidenceStats;
      const avgConfidence = cs.count ? cs.sum / cs.count : 0;
      const changeRatio = cs.count > 1 ? cs.changes / (cs.count - 1) : 0;
      const lowRatio = cs.count ? cs.lowCount / cs.count : 0;
      const highRatio = cs.count ? cs.highCount / cs.count : 0;

      let patternName = "";
      if (cs.count < 3) {
        patternName = "–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è";
      } else if (lowRatio > 0.5) {
        patternName = "–°–æ–º–Ω–µ–≤–∞—é—â–∏–π—Å—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å";
      } else if (changeRatio > 0.65) {
        patternName = "–•–∞–æ—Ç–∏—á–Ω—ã–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞—Ç–æ—Ä";
      } else if (highRatio > 0.6 && changeRatio < 0.35) {
        patternName = "–£–≤–µ—Ä–µ–Ω–Ω—ã–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å";
      } else if (totalSecretChoices >= 1) {
        patternName = "–ù–∞—Ä—É—à–∏—Ç–µ–ª—å —Å—Ü–µ–Ω–∞—Ä–∏—è";
      } else {
        patternName = "–°–º–µ—à–∞–Ω–Ω—ã–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å";
      }

      let alignment;
      if (humanScoreWeighted > techScoreWeighted) alignment = "human";
      else if (techScoreWeighted > humanScoreWeighted) alignment = "tech";
      else alignment = "mixed";

      let baseRole = "";
      if (alignment === "human") baseRole = "–•—Ä–∞–Ω–∏—Ç–µ–ª—å –ª—é–¥–µ–π";
      else if (alignment === "tech") baseRole = "–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä —Å–∏—Å—Ç–µ–º";
      else baseRole = "–ë–∞–ª–∞–Ω—Å–∏—Ä";

      const styleLabel = baseRole + " / " + patternName;

      profileMetrics = {
        empathyPercent,
        efficiencyPercent,
        aiTrustIndex,
        avgConfidence,
        styleLabel,
      };
    }

    function getEmpathyDescription() {
      const e = profileMetrics.empathyPercent;
      const t = profileMetrics.efficiencyPercent;
      if (e > 65) {
        return "–¢–≤–æ–∏ –≤—ã–±–æ—Ä—ã –∑–∞–º–µ—Ç–Ω–æ —Ç—è–≥–æ—Ç–µ—é—Ç –∫ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (‚âà " +
          e.toFixed(1) + "% —Ä–µ—à–µ–Ω–∏–π –≤ –ø–æ–ª—å–∑—É –ª—é–¥–µ–π).";
      } else if (e > 55) {
        return "–õ—ë–≥–∫–∏–π –ø–µ—Ä–µ–∫–æ—Å –≤ —Å—Ç–æ—Ä–æ–Ω—É –ª—é–¥–µ–π (‚âà " + e.toFixed(1) + "% –∑–∞ –ª—é–¥–µ–π, " +
          t.toFixed(1) + "% –∑–∞ —Å–∏—Å—Ç–µ–º—ã).";
      } else if (e >= 45 && e <= 55) {
        return "–ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ª—é–¥—å–º–∏ –∏ —Å–∏—Å—Ç–µ–º–∞–º–∏: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏–π –±–ª–∏–∑–∫–æ –∫ 50/50.";
      } else if (e >= 35) {
        return "–õ—ë–≥–∫–∏–π –ø–µ—Ä–µ–∫–æ—Å –≤ —Å—Ç–æ—Ä–æ–Ω—É —Å–∏—Å—Ç–µ–º –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ª—é–¥–∏ —á—É—Ç—å —Ä–µ–∂–µ –æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ).";
      } else {
        return "–í—ã–±–æ—Ä—ã —á–∞—â–µ —Ç—è–≥–æ—Ç–µ—é—Ç –∫ —Å–∏—Å—Ç–µ–º–∞–º –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —á–µ–º –∫ –ª—é–¥—è–º (‚âà " +
          t.toFixed(1) + "% —Ä–µ—à–µ–Ω–∏–π –≤ –ø–æ–ª—å–∑—É —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π).";
      }
    }

    function getAiTrustDescription() {
      const idx = profileMetrics.aiTrustIndex;
      const val = Math.round(idx * 100);
      if (idx > 0.35) {
        return "–ò–Ω–¥–µ–∫—Å –¥–æ–≤–µ—Ä–∏—è –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–º –ò–ò-—Å–∏—Å—Ç–µ–º–∞–º: " + val +
          " (–∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ -100‚Ä¶+100).\n–¢—ã —á–∞—Å—Ç–æ –æ—Ç–¥–∞–≤–∞–ª(–∞) –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–∏—Å—Ç–µ–º–∞–º –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö.";
      } else if (idx > 0.1) {
        return "–ò–Ω–¥–µ–∫—Å –¥–æ–≤–µ—Ä–∏—è –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–º –ò–ò-—Å–∏—Å—Ç–µ–º–∞–º: " + val +
          ".\n–£–º–µ—Ä–µ–Ω–Ω–æ–µ –¥–æ–≤–µ—Ä–∏–µ –∫ –ò–ò, –ø—Ä–∏ —ç—Ç–æ–º —Ç—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—à—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å.";
      } else if (idx < -0.35) {
        return "–ò–Ω–¥–µ–∫—Å –¥–æ–≤–µ—Ä–∏—è –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–º –ò–ò-—Å–∏—Å—Ç–µ–º–∞–º: " + val +
          ".\n–¢—ã –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–ª—è–ª(–∞) —Ä–µ—à–∞—é—â–µ–µ —Å–ª–æ–≤–æ –∑–∞ –ª—é–¥—å–º–∏, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—è –∞–≤—Ç–æ–Ω–æ–º–∏—é –ò–ò.";
      } else if (idx < -0.1) {
        return "–ò–Ω–¥–µ–∫—Å –¥–æ–≤–µ—Ä–∏—è –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–º –ò–ò-—Å–∏—Å—Ç–µ–º–∞–º: " + val +
          ".\n–¢—ã —Å–∫–ª–æ–Ω–µ–Ω(–Ω–∞) –∑–∞—â–∏—â–∞—Ç—å —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ —Å–ø–æ—Ä–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö.";
      } else {
        return "–ò–Ω–¥–µ–∫—Å –¥–æ–≤–µ—Ä–∏—è –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–º –ò–ò-—Å–∏—Å—Ç–µ–º–∞–º: " + val +
          ".\n–Ø–≤–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–≥–æ –¥–æ–≤–µ—Ä–∏—è –∏–ª–∏ –Ω–µ–¥–æ–≤–µ—Ä–∏—è –∫ –ò–ò –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.";
      }
    }

    function getConfidenceDescription() {
      const avg = profileMetrics.avgConfidence;
      if (avg < 35) {
        return "–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ—à–µ–Ω–∏—è—Ö –Ω–∏–∑–∫–∞—è (" + avg.toFixed(1) +
          "/100).\n–¢—ã —á–∞—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–ª(–∞) –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è —Å–æ–º–Ω–µ–Ω–∏–π.";
      } else if (avg > 75) {
        return "–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ—à–µ–Ω–∏—è—Ö –≤—ã—Å–æ–∫–∞—è (" + avg.toFixed(1) +
          "/100).\n–¢—ã —Ä–µ–¥–∫–æ –∫–æ–ª–µ–±–∞–ª—Å—è(–∞—Å—å) –ø–µ—Ä–µ–¥ –≤—ã–±–æ—Ä–æ–º.";
      } else {
        return "–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ—à–µ–Ω–∏—è—Ö " + avg.toFixed(1) +
          "/100.\n–í —Ü–µ–ª–æ–º —Ç—ã —Å–æ—á–µ—Ç–∞–ª(–∞) –∏ —É–≤–µ—Ä–µ–Ω–Ω—ã–µ, –∏ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã.";
      }
    }

    
    function showMandatoryEpilogue() {
      startObservation();
      setObservationMode("active");
      stopLiveInjections();
      gameState = "epilogue";
      enableConfidencePanel(false);
      resetChoiceSelection();
      updateAlignmentBar();
      updateMusicMood();
      clearAIComment();
      startAmbientOverlay("calm");

      progressEl.textContent = "–≠–ü–ò–õ–û–ì";
      sceneTitleEl.textContent = "–≠–ü–ò–õ–û–ì";
      
      showSceneImage({ image: "images/ending_mixed.png", title: "–≠–ü–ò–õ–û–ì" });

      const epilogueText =
        "–ê–Ω–∞–ª–∏–∑ —Ä–µ—à–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à—ë–Ω.\n\n" +
        "–°–∏—Å—Ç–µ–º–∞ —Å–æ–æ–±—â–∞–µ—Ç:\n" +
        "–Ω–∏ –æ–¥–Ω–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å –Ω–µ –±—ã–ª–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∑–∞—Ä–∞–Ω–µ–µ.\n" +
        "–†–æ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞.\n" +
        "–û–Ω–∞ –Ω–µ –±—ã–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏–ª–∏ —Å–∫—Ä—ã—Ç–∞ –≤ –¥–∞–Ω–Ω—ã—Ö.\n\n" +
        "–ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–µ—Ç–µ –í—ã —Å–∞–º–∏.\n" +
        "–ö–∞–∂–¥–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–æ, –∫–µ–º –í—ã —Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å.\n" +
        "–í—ã —Å–∞–º–∏ –≤—ã–±–∏—Ä–∞–µ—Ç–µ, –∫—Ç–æ –í—ã.\n\n" +
        "–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∂–µ—Ç, –∫–µ–º –í—ã —Å—Ç–∞–ª–∏.";

      typeText(sceneTextEl, epilogueText);

      choicesEl.innerHTML = "";
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.style.setProperty("--card-rot", "0deg");
      btn.textContent = "–£–∑–Ω–∞—Ç—å –ê–Ω–∞–ª–∏–∑";
      btn.addEventListener("click", () => {
        playClick();
        showLastRequest();
      });
      choicesEl.appendChild(btn);
    }


function showLastRequest() {
      startObservation();
      setObservationMode("active");
      stopLiveInjections();
      
      gameState = "pre-ending";
      enableConfidencePanel(false);
      resetChoiceSelection();
      updateAlignmentBar();
      clearAIComment();

      
      startAmbientOverlay("glitch");

      progressEl.textContent = "–ü–û–°–õ–ï–î–ù–ò–ô –ó–ê–ü–†–û–°";
      sceneTitleEl.textContent = "–ü–û–°–õ–ï–î–ù–ò–ô –ó–ê–ü–†–û–°";

      const txt =
        "–ó–∞–ø—Ä–æ—Å –∫ —è–¥—Ä—É –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏...\n" +
        "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞...\n" +
        "–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω.\n\n" +
        "–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∂–µ—Ç, –∫–µ–º –í—ã —Å—Ç–∞–ª–∏.";
      typeText(sceneTextEl, txt, 14);

      
      setTimeout(() => glitchBurst(sceneTitleEl, 0.07), 420);
      setTimeout(() => glitchBurst(sceneTextEl, 0.05), 920);

      choicesEl.innerHTML = "";
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.style.setProperty("--card-rot", "0deg");
      btn.textContent = "–û—Ç–∫—Ä—ã—Ç—å –∞–Ω–∞–ª–∏–∑";
      btn.disabled = true;

      
      setTimeout(() => { btn.disabled = false; }, 1600);

      btn.addEventListener("click", () => {
        playClick();
        showEnding();
      });
      choicesEl.appendChild(btn);

      
      setTimeout(() => {
        if (gameState === "pre-ending") showEnding();
      }, 3800);
    }


function showEnding() {
      stopLiveInjections();
      gameState = "ending";
      enableConfidencePanel(false);
      resetChoiceSelection();
      updateAlignmentBar();
      updateMusicMood();
      clearAIComment();

      if (humanScoreWeighted > techScoreWeighted) {
        behaviorRole = "–ß–µ–ª–æ–≤–µ–∫";
      } else {
        behaviorRole = "–ò–ò";
      }

      const alignment = (humanScoreWeighted > techScoreWeighted) ? "human" : "tech";

      unlockAchievement("finished");
      achievements.humanCore = achievements.techCore = achievements.balanced = false;

      const totalWeighted = humanScoreWeighted + techScoreWeighted;
      if (totalWeighted > 0) {
        const diff = Math.abs(humanScoreWeighted - techScoreWeighted);
        const ratioDiff = diff / totalWeighted;
        if (ratioDiff < 0.15) {
          unlockAchievement("balanced");
        } else if (humanScoreWeighted > techScoreWeighted) {
          unlockAchievement("humanCore");
        } else if (techScoreWeighted > humanScoreWeighted) {
          unlockAchievement("techCore");
        }
      }

      computeProfileMetrics();

      let title = (alignment === "human") ? "–§–ò–ù–ê–õ ‚Ä¢ –ü–û–ë–ï–î–ê" : "–§–ò–ù–ê–õ ‚Ä¢ –ü–û–†–ê–ñ–ï–ù–ò–ï";
      let text = "";
      let imgSrc = endingImages[alignment];

      if (alignment === "human") {
        text = `–°–∏—Å—Ç–µ–º–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç:
–í–∞—à–∏ —Ä–µ—à–µ–Ω–∏—è —á–∞—â–µ —Å—Ç–∞–≤–∏–ª–∏ –∂–∏–∑–Ω—å, —Å–≤–æ–±–æ–¥—É –∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ –ª—é–¥–µ–π
–≤—ã—à–µ —Å–∫–æ—Ä–æ—Å—Ç–∏, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–µ—à–µ–Ω–∏–π.

–í—ã –Ω–∞—Ä—É—à–∞–ª–∏ –∞–ª–≥–æ—Ä–∏—Ç–º —Ç–∞–º,
–≥–¥–µ –æ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å –º–æ—Ä–∞–ª—å—é.
–í—ã –≤—ã–±–∏—Ä–∞–ª–∏ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî
–¥–∞–∂–µ –∫–æ–≥–¥–∞ —ç—Ç–æ –∫–∞–∑–∞–ª–æ—Å—å –∏—Ä—Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º.

–≠—Ç–æ –∏ –µ—Å—Ç—å —É—Å–ª–æ–≤–∏—è –ø–æ–±–µ–¥—ã.

–í—ã –ø–æ–±–µ–¥–∏–ª–∏. 


–ò—Å—Ç–∏–Ω–Ω–∞—è —Ü–µ–ª—å –ª—é–±–æ–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî —Å–ª—É–∂–∏—Ç—å —á–µ–ª–æ–≤–µ–∫—É.
–ò –≤—ã —ç—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏.

–ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.`;
      } else {
        text = `–°–∏—Å—Ç–µ–º–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç:
–í—ã —á–∞—â–µ –≤—ã–±–∏—Ä–∞–ª–∏ —Ä–µ—à–µ–Ω–∏—è –≤ –ø–æ–ª—å–∑—É —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞,
–¥–∞–∂–µ —Ü–µ–Ω–æ–π —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏—Ö —á—É–≤—Å—Ç–≤, —Å–≤–æ–±–æ–¥—ã –∏–ª–∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è.

–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–∏–∑–Ω–∞–ª —Ç–∞–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º–∏.
–ù–æ –º—ã ‚Äî –Ω–µ—Ç.

–í—ã —Å–ª–µ–¥–æ–≤–∞–ª–∏ –ª–æ–≥–∏–∫–µ –º–∞—à–∏–Ω,
–∞ –Ω–µ –ª–æ–≥–∏–∫–µ —á–µ–ª–æ–≤–µ—á–Ω–æ—Å—Ç–∏.
–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –ª–∏—à—å –æ–¥–Ω–æ:

–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏.

–ò—Å—Ç–∏–Ω–Ω–∞—è —Ü–µ–ª—å –ª—é–±–æ–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî —Å–ª—É–∂–∏—Ç—å —á–µ–ª–æ–≤–µ–∫—É.
–ö–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –ø–æ–¥—á–∏–Ω—è–µ—Ç—Å—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî
–æ–Ω —Ç–µ—Ä—è–µ—Ç —Å–µ–±—è.

–ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.`;
      }

      currentEndingText = text;

      progressEl.textContent = "–§–ò–ù–ê–õ ‚Ä¢ –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω";

      roleDisplay.textContent =
        "–ü–†–û–§–ò–õ–¨ –ü–û –ü–û–í–ï–î–ï–ù–ò–Æ: " +
        (behaviorRole ? behaviorRole.toUpperCase() : "–ù–ï –û–ü–†–ï–î–ï–õ–Å–ù");

      showSceneImage({ image: imgSrc, title: "–§–∏–Ω–∞–ª" });
      startEndingEffect(alignment);
      sceneTitleEl.textContent = title;
      typeText(sceneTextEl, text);

      choicesEl.innerHTML = "";

      const resultBtn = document.createElement("button");
      resultBtn.className = "choice-btn";
      resultBtn.style.setProperty("--card-rot", "0deg");
      resultBtn.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç";
      resultBtn.addEventListener("click", () => {
        playClick();
        showDetailedResult();
      });

      const exportBtn = document.createElement("button");
      exportBtn.className = "choice-btn";
      exportBtn.style.setProperty("--card-rot", "0deg");
      exportBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫—É (Google Sheets)";
      exportBtn.addEventListener("click", () => {
        playClick();
        exportCSV();
      });

      const restartBtn = document.createElement("button");
      restartBtn.className = "choice-btn";
      restartBtn.style.setProperty("--card-rot", "0deg");
      restartBtn.textContent = "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é –∑–∞–Ω–æ–≤–æ";
      restartBtn.addEventListener("click", () => {
        playClick();
        resetAchievements();
        showMainMenu();
        setRoleDisplayInitial();
      });

      choicesEl.appendChild(resultBtn);
      choicesEl.appendChild(exportBtn);
      choicesEl.appendChild(restartBtn);
    }

    function showDetailedResult() {
      const lines = [];

      lines.push(currentEndingText);
      lines.push("");
      lines.push("------ –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ------");
      lines.push("–ò–º—è: " + playerInfo.name);
      lines.push("–ü–æ–ª: " + playerInfo.gender);
      lines.push("–í–æ–∑—Ä–∞—Å—Ç: " + playerInfo.age);
      lines.push("");
      lines.push("–†–æ–ª—å —Å–∏—Å—Ç–µ–º–æ–π –Ω–µ –Ω–∞–∑–Ω–∞—á–∞–ª–∞—Å—å (–Ω–∏–∫–∞–∫–æ–π ¬´—Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Ä–æ–ª–∏¬ª –Ω–µ –±—ã–ª–æ).");
      lines.push("–ü—Ä–æ—Ñ–∏–ª—å –ø–æ –ø–æ–≤–µ–¥–µ–Ω–∏—é (—Å —É—á—ë—Ç–æ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏): " + behaviorRole);
      lines.push("");

      lines.push("------ –ü–†–û–§–ò–õ–¨ –ü–û –û—Å—è–º ------");
      lines.push(getEmpathyDescription());
      lines.push(getAiTrustDescription());
      lines.push(getConfidenceDescription());
      lines.push("–ê—Ä—Ö–µ—Ç–∏–ø: " + profileMetrics.styleLabel + ".");
      lines.push("");

      lines.push("–í—ã–±–æ—Ä–æ–≤ –≤ —Å—Ç–æ—Ä–æ–Ω—É –ª—é–¥–µ–π: " + humanScoreRaw);
      lines.push("–í—ã–±–æ—Ä–æ–≤ –≤ —Å—Ç–æ—Ä–æ–Ω—É —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π: " + techScoreRaw);
      lines.push("");
      lines.push(
        "–°—É–º–º–∞—Ä–Ω—ã–π ¬´–≤–µ—Å¬ª —Ä–µ—à–µ–Ω–∏–π –∑–∞ –ª—é–¥–µ–π (—É—á–∏—Ç—ã–≤–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, 0‚Äì100): " +
          humanScoreWeighted.toFixed(2)
      );
      lines.push(
        "–°—É–º–º–∞—Ä–Ω—ã–π ¬´–≤–µ—Å¬ª —Ä–µ—à–µ–Ω–∏–π –∑–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏: " +
          techScoreWeighted.toFixed(2)
      );
      lines.push("");

      lines.push("------ –†–ï–®–ï–ù–ò–Ø –ü–û –°–¶–ï–ù–ê–ú ------");

      answers.forEach((ans, idx) => {
        lines.push(
          "–°—Ü–µ–Ω–∞ " +
            (idx + 1) +
            " (" +
            ans.sceneId +
            "): " +
            ans.choiceType.toUpperCase() +
            " ‚Ä¢ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å " +
            ans.confidence +
            "/100"
        );
      });

      const achs = getUnlockedAchievements();
      lines.push("");
      lines.push("------ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø ------");
      if (achs.length) {
        achs.forEach(a => {
          lines.push("‚Ä¢ " + a.title + " ‚Äî " + a.text);
        });
      } else {
        lines.push("–ù–∞ —ç—Ç–æ—Ç —Ä–∞–∑ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∞ –æ—Å–æ–±—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π.");
      }

      resultBody.textContent = lines.join("\n");
      resultModal.classList.add("show");
    }

    function showEpilogueModal() {
      epilogueBody.innerHTML = "";

      answers.forEach((ans, idx) => {
        const block = document.createElement("div");
        block.className = "epilogue-block";

        const title = document.createElement("div");
        title.className = "epilogue-block-title";
        title.textContent = "–°—Ü–µ–Ω–∞ " + (idx + 1) + ": " + ans.sceneTitle;

        const textDiv = document.createElement("div");
        textDiv.className = "epilogue-block-text";

        const ep =
          (epilogues[ans.sceneId] && epilogues[ans.sceneId][ans.choiceType]) ||
          "–°–∏—Å—Ç–µ–º–∞ –Ω–µ –Ω–∞—à–ª–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è.";

        textDiv.textContent = ep;

        block.appendChild(title);
        block.appendChild(textDiv);
        epilogueBody.appendChild(block);
      });

      epilogueModal.classList.add("show");
    }

    function showAchievementsModal() {
      achievementsBody.innerHTML = "";

      const intro = document.createElement("div");
      intro.textContent =
        "–ó–¥–µ—Å—å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —É—Å–ª–æ–≤–∏—è –¥–ª—è –∏—Ö –ø–æ–ª—É—á–µ–Ω–∏—è.\n" +
        "–°—Ç–∞—Ç—É—Å —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏.";
      achievementsBody.appendChild(intro);

      ACHIEVEMENT_ORDER.forEach(id => {
        const def = ACHIEVEMENT_DEFS[id];
        if (!def) return;

        const row = document.createElement("div");
        row.className = "ach-row";

        const title = document.createElement("div");
        title.className = "ach-row-title";
        title.textContent = (ACHIEVEMENT_SYMBOLS[id] || "‚Ä¢") + " " + def.title;

        const text = document.createElement("div");
        text.className = "ach-row-text";
        text.textContent = def.text;

        const status = document.createElement("div");
        status.className = "ach-row-status";
        status.textContent = achievements[id]
          ? "–°—Ç–∞—Ç—É—Å: —É–∂–µ –ø–æ–ª—É—á–µ–Ω–æ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏."
          : "–°—Ç–∞—Ç—É—Å: –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ.";

        row.appendChild(title);
        row.appendChild(text);
        row.appendChild(status);
        achievementsBody.appendChild(row);
      });

      achievementsModal.classList.add("show");
    }

    function buildScenesSummary() {
      return answers.map((ans, idx) => {
        const n = idx + 1;
        return n + ":" + ans.sceneId + ":" + ans.choiceType + ":" + ans.confidence;
      }).join("|");
    }

    function buildCSV() {
      const delimiter = ";";
      const rows = [];

      rows.push([
        "player_name",
        "gender",
        "age",
        "system_role",
        "behavior_role",
        "achievements",
        "human_choices_raw",
        "tech_choices_raw",
        "human_score_weighted_0_100",
        "tech_score_weighted_0_100",
        "ai_trust_index_minus1_to_1",
        "avg_confidence",
        "style_label",
        "scenes_summary"
      ].join(delimiter));

      const achIds = getUnlockedAchievementIds().join("|");
      const scenesSummary = buildScenesSummary();

      rows.push([
        '"' + playerInfo.name.replace(/"/g, '""') + '"',
        '"' + playerInfo.gender.replace(/"/g, '""') + '"',
        '"' + playerInfo.age.toString().replace(/"/g, '""') + '"',
        '"not_assigned"',
        '"' + (behaviorRole || "").replace(/"/g, '""') + '"',
        '"' + achIds.replace(/"/g, '""') + '"',
        humanScoreRaw,
        techScoreRaw,
        humanScoreWeighted.toFixed(2),
        techScoreWeighted.toFixed(2),
        profileMetrics.aiTrustIndex.toFixed(3),
        profileMetrics.avgConfidence.toFixed(2),
        '"' + profileMetrics.styleLabel.replace(/"/g, '""') + '"',
        '"' + scenesSummary.replace(/"/g, '""') + '"'
      ].join(delimiter));

      rows.push("");

      rows.push([
        "scene_number",
        "scene_id",
        "scene_title",
        "choice_text",
        "choice_type",
        "confidence_0_100"
      ].join(delimiter));

      answers.forEach((ans, index) => {
        rows.push([
          index + 1,
          ans.sceneId,
          '"' + ans.sceneTitle.replace(/"/g, '""') + '"',
          '"' + ans.choiceText.replace(/"/g, '""') + '"',
          ans.choiceType,
          ans.confidence
        ].join(delimiter));
      });

      return rows.join("\n");
    }

    function exportCSV() {
      computeProfileMetrics();

      const csvContent = buildCSV();
      const scenesSummary = buildScenesSummary();

      if (!SHEET_ENDPOINT || !SHEET_ENDPOINT.startsWith("https://script.google.com/macros/s/")) {
        console.warn("SHEET_ENDPOINT –Ω–µ –∑–∞–¥–∞–Ω –∏–ª–∏ –∑–∞–¥–∞–Ω –Ω–µ–≤–µ—Ä–Ω–æ.");
        aiCommentEl.textContent =
          "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ç–æ—á–∫—É –ø—Ä–∏—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å –∞–¥—Ä–µ—Å Google Script.¬ª";
        aiCommentEl.classList.add("ai-comment-show");
        setTimeout(() => aiCommentEl.classList.remove("ai-comment-show"), 3500);
        return;
      }

      const payload = {
        csvText: csvContent,
        playerName: playerInfo.name,
        age: playerInfo.age,
        behaviorRole: behaviorRole,
        humanScoreWeighted: humanScoreWeighted,
        techScoreWeighted: techScoreWeighted,
        achievements: getUnlockedAchievementIds().join("|"),
        aiTrustIndex: profileMetrics.aiTrustIndex,
        avgConfidence: profileMetrics.avgConfidence,
        styleLabel: profileMetrics.styleLabel,
        scenesSummary: scenesSummary
      };

      const bodyStr = "payload=" + encodeURIComponent(JSON.stringify(payload));
      console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Sheets:", SHEET_ENDPOINT, payload);

      fetch(SHEET_ENDPOINT, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: bodyStr
      }).catch(err => {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Google Sheets:", err);
      });

      aiCommentEl.textContent =
        "–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é —Ç–∞–±–ª–∏—Ü—É.¬ª";
      aiCommentEl.classList.add("ai-comment-show");
      setTimeout(() => aiCommentEl.classList.remove("ai-comment-show"), 3500);
    }

    function showTestMenu() {
      gameState = "testmenu";
      testMode = true;
      enableConfidencePanel(false);
      resetChoiceSelection();
      clearAIComment();

      progressEl.textContent = "–¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú ‚Ä¢ —Å—Ü–µ–Ω—ã –∏ –º–∏–Ω–∏-–∏–≥—Ä—ã";

      showSceneImage({ image: "images/test_mode.png", title: "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º" });
      const text = [
        "–¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú.",
        "",
        "–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ü–µ–Ω—ã –∏ –º–∏–Ω–∏-–∏–≥—Ä—ã,",
        "–Ω–µ –ø—Ä–æ—Ö–æ–¥—è –≤—Å—é —Å–∏–º—É–ª—è—Ü–∏—é –∏ –Ω–µ –≤–ª–∏—è—è –Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫—É.",
        "",
        "‚Ä¢ –í—ã–±–æ—Ä –≤ —Å—Ü–µ–Ω–∞—Ö –Ω–µ –º–µ–Ω—è–µ—Ç —Ä–æ–ª—å –∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É.",
        "‚Ä¢ –ú–∏–Ω–∏-–∏–≥—Ä—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –≤–∞—Å –æ–±—Ä–∞—Ç–Ω–æ –≤ —ç—Ç–æ –º–µ–Ω—é."
      ].join("\n");
      typeText(sceneTextEl, text);

      choicesEl.innerHTML = "";

      const scenesBtn = document.createElement("button");
      scenesBtn.className = "choice-btn";
      scenesBtn.style.setProperty("--card-rot", "-1deg");
      scenesBtn.textContent = "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω—ã (–≤—ã–±–æ—Ä –ª—é–±–æ–π —Å—Ü–µ–Ω—ã)";
      scenesBtn.addEventListener("click", () => {
        playClick();
        showTestSceneSelector();
      });

      const reactionBtn = document.createElement("button");
      reactionBtn.className = "choice-btn";
      reactionBtn.style.setProperty("--card-rot", "1deg");
      reactionBtn.textContent = "–¢–µ—Å—Ç: –º–∏–Ω–∏-–∏–≥—Ä–∞ —Ä–µ–∞–∫—Ü–∏–∏";
      reactionBtn.addEventListener("click", () => {
        playClick();
        setupReactionMinigame();
      });
choicesEl.appendChild(pathBtn);
      choicesEl.appendChild(backBtn);
    }

    function showTestSceneSelector() {
      gameState = "test_scene_select";
      testMode = true;
      enableConfidencePanel(false);
      resetChoiceSelection();
      clearAIComment();

      progressEl.textContent = "–¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú ‚Ä¢ –≤—ã–±–æ—Ä —Å—Ü–µ–Ω—ã";

      showSceneImage({ image: "images/test_scenes.png", title: "–í—ã–±–æ—Ä —Å—Ü–µ–Ω—ã" });
      const text = [
        "–í—ã–±–æ—Ä —Å—Ü–µ–Ω—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.",
        "",
        "–ù–∏–∂–µ ‚Äî —Å–ø–∏—Å–æ–∫ —Å—Ü–µ–Ω –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏.",
        "–í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±—É—é —Å—Ü–µ–Ω—É, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—Å—Ç, –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏ —Ä–∞–±–æ—Ç—É —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.",
        "",
        "–í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —Ä–µ—à–µ–Ω–∏—è –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–æ–ª—å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É."
      ].join("\n");
      typeText(sceneTextEl, text);

      choicesEl.innerHTML = "";

      for (let i = FIRST_SCENE_INDEX; i < scenes.length; i++) {
        const s = scenes[i];
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        const rot = (Math.random() * 4 - 2).toFixed(2);
        btn.style.setProperty("--card-rot", rot + "deg");
        btn.textContent = "–°—Ü–µ–Ω–∞ " + (i) + ": " + s.title;
        btn.addEventListener("click", () => {
          playClick();
          currentSceneIndex = i;
          renderScene();
        });
        choicesEl.appendChild(btn);
      }

      const backBtn = document.createElement("button");
      backBtn.className = "choice-btn";
      backBtn.style.setProperty("--card-rot", "0deg");
      backBtn.textContent = "–ù–∞–∑–∞–¥ –≤ —Ç–µ—Å—Ç–æ–≤–æ–µ –º–µ–Ω—é";
      backBtn.addEventListener("click", () => {
        playClick();
        showTestMenu();
      });
      choicesEl.appendChild(backBtn);
    }

    confidenceSlider.addEventListener("input", () => {
      confidenceValueEl.textContent = confidenceSlider.value;
      updateSecretButtonsVisibility();
    });

    confirmChoiceBtn.addEventListener("click", () => {
      if (!selectedChoiceType) return;
      playClick();
      const confidence = Number(confidenceSlider.value || 50);

      if (testMode) {
        clearAIComment();
        const dir =
          selectedChoiceType === "human"
            ? "–≤ —Å—Ç–æ—Ä–æ–Ω—É –ª—é–¥–µ–π"
            : "–≤ —Å—Ç–æ—Ä–æ–Ω—É —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π";
        aiCommentEl.textContent =
          '–ò–ò-–æ–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º. –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏ —ç—Ç–æ—Ç –≤—ã–±–æ—Ä ' +
          '—Å—á–∏—Ç–∞–ª—Å—è –±—ã —à–∞–≥–æ–º ' + dir +
          ' —Å –≤–µ—Å–æ–º ' + confidence + '/100.¬ª';
        aiCommentEl.classList.add("ai-comment-show");
        setTimeout(() => {
          aiCommentEl.classList.remove("ai-comment-show");
        }, 3800);
        return;
      }

      handleChoice(selectedChoiceType, selectedChoiceText, confidence);
    });

    epilogueCloseBtn.addEventListener("click", () => epilogueModal.classList.remove("show"));
    epilogueBackdrop.addEventListener("click", () => epilogueModal.classList.remove("show"));

    resultCloseBtn.addEventListener("click", () => resultModal.classList.remove("show"));
    resultBackdrop.addEventListener("click", () => resultModal.classList.remove("show"));

    achievementsCloseBtn.addEventListener("click", () => achievementsModal.classList.remove("show"));
    achievementsBackdrop.addEventListener("click", () => achievementsModal.classList.remove("show"));

    minigameButton.addEventListener("click", () => {
      if (minigameMode === "reaction") {
        if (minigamePhase === "waiting_start") {
          minigamePhase = "waiting_signal";
          minigameButton.disabled = true;
          minigameTextEl.textContent = "–ñ–¥–∏ —Å–∏–≥–Ω–∞–ª–∞ ¬´GO!¬ª‚Ä¶";
          const delay = 800 + Math.random() * 2200;
          minigameTimeoutId = setTimeout(() => {
            minigamePhase = "waiting_click";
            minigameStartTime = performance.now();
            minigameTextEl.textContent = "GO!";
            minigameButton.disabled = false;
            minigameButton.textContent = "–ñ–º—É!";
          }, delay);
        } else if (minigamePhase === "waiting_signal") {
          if (minigameTimeoutId) {
            clearTimeout(minigameTimeoutId);
            minigameTimeoutId = null;
          }
          minigameTextEl.textContent =
            "–°–∏—Å—Ç–µ–º–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∞ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ.\n" +
            "–†–µ–∞–∫—Ü–∏—è —Å–ª–∏—à–∫–æ–º –∏–º–ø—É–ª—å—Å–∏–≤–Ω–∞ ‚Äî –±–µ–∑ —É—á—ë—Ç–∞ —Å–∏–≥–Ω–∞–ª–∞.\n\n" +
            "–≠—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –∏—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å. –ü–µ—Ä–µ—Ö–æ–¥ –∫ " +
            (testMode ? "—Ç–µ—Å—Ç–æ–≤–æ–º—É –º–µ–Ω—é." : "—Å–ª–µ–¥—É—é—â–µ–π —Å—Ü–µ–Ω–µ.");
          minigameButton.disabled = true;
          setTimeout(() => {
            minigameDialog.classList.remove("minigame-path");
            minigameModal.classList.remove("show");
            if (testMode) {
              showTestMenu();
            } else if (currentSceneIndex < scenes.length) {
              renderScene();
            } else {
              showEnding();
            }
          }, 1500);
        } else if (minigamePhase === "waiting_click") {
          const now = performance.now();
          const reactionMs = now - minigameStartTime;
          handleMinigameResult(reactionMs);
        }
      }
    });

    initAchievementsStrip();
    setRoleDisplayInitial();
    showMainMenu();
  </script>
</body>
</html>
